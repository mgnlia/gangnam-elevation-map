<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ê°•ë‚¨ ìì „ê±° ê³ ë„ ì§€ë„ ğŸš´</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif; }
#map { width: 100%; height: 100vh; }

.top-bar {
  position: absolute; top: 0; left: 0; right: 0; z-index: 1000;
  background: #fff; padding: 10px 14px;
  display: flex; align-items: center; justify-content: space-between;
  border-bottom: 1px solid #e8e8e8; box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}
.top-bar h1 { font-size: 15px; font-weight: 700; color: #333; }
.top-bar h1 span { font-weight: 400; color: #999; font-size: 12px; }
.mode-tabs { display: flex; gap: 2px; background: #f2f2f2; border-radius: 8px; padding: 2px; }
.mode-tab {
  padding: 5px 14px; border: none; border-radius: 7px; background: transparent;
  color: #888; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.15s;
}
.mode-tab.active { background: #fff; color: #333; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

.bottom-sheet {
  position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000;
  background: #fff; border-radius: 16px 16px 0 0;
  padding: 10px 16px; padding-bottom: max(14px, env(safe-area-inset-bottom));
  box-shadow: 0 -2px 12px rgba(0,0,0,0.08);
}
.sheet-handle { width: 36px; height: 4px; background: #ddd; border-radius: 2px; margin: 0 auto 10px; }
.elev-info { display: flex; align-items: center; gap: 14px; }
.elev-big { font-size: 34px; font-weight: 800; color: #333; line-height: 1; }
.elev-big small { font-size: 14px; font-weight: 500; color: #999; }
.elev-badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; margin-bottom: 2px; }
.badge-safe { background: #E8F5E9; color: #2E7D32; }
.badge-warn { background: #FFF3E0; color: #E65100; }
.badge-danger { background: #FFEBEE; color: #C62828; }
.elev-coord { font-size: 11px; color: #bbb; }

.compare-info { display: none; }
.compare-row { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
.compare-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.compare-label { font-size: 11px; color: #999; }
.compare-elev { font-size: 15px; font-weight: 700; color: #333; }
.compare-result-box {
  background: #f8f8f8; border-radius: 10px; padding: 10px 14px;
  margin-top: 6px; display: flex; align-items: center; gap: 12px;
}
.compare-arrow { font-size: 22px; }
.compare-diff { font-size: 20px; font-weight: 800; }
.compare-verdict { font-size: 12px; color: #888; }
.hint-text { font-size: 13px; color: #bbb; text-align: center; padding: 6px 0; }

.contour-control {
  position: absolute; top: 52px; left: 10px; z-index: 1000;
  background: #fff; border-radius: 10px; padding: 8px 12px;
  box-shadow: 0 1px 6px rgba(0,0,0,0.1); font-size: 11px; color: #666;
  display: none;
}
.contour-control.show { display: block; }
.contour-control label { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; cursor: pointer; }
.contour-control input[type="range"] { width: 100px; }
.contour-control hr { border: none; border-top: 1px solid #eee; margin: 5px 0; }

.flat-badge {
  background: #2E7D32; color: #fff; font-size: 10px; font-weight: 700;
  padding: 2px 7px; border-radius: 8px; white-space: nowrap;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.caution-badge { background: #C62828; }
.moderate-badge { background: #E65100; }

.stn {
  background: #fff; border: 1.5px solid; border-radius: 3px;
  padding: 0px 4px; font-size: 9.5px; font-weight: 600;
  white-space: nowrap; box-shadow: 0 1px 2px rgba(0,0,0,0.12); line-height: 1.5;
}
.s2 { border-color: #33A23D; color: #33A23D; }
.s3 { border-color: #FE5B10; color: #FE5B10; }
.s7 { border-color: #6E8B2D; color: #6E8B2D; }
.s9 { border-color: #AA9872; color: #AA9872; }
.ss { border-color: #A71E31; color: #A71E31; }
.sb { border-color: #b39500; color: #b39500; }

.peak-label {
  font-size: 10px; font-weight: 700; color: #C62828;
  text-shadow: 0 0 3px #fff, 0 0 3px #fff, 0 0 3px #fff, 0 0 3px #fff;
  white-space: nowrap;
}

/* Slope arrow markers */
.slope-arrow {
  font-size: 18px;
  text-shadow: 0 0 4px #fff, 0 0 4px #fff, 0 0 4px #fff;
  filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
}
.slope-arrow-label {
  font-size: 9px; font-weight: 700; color: #fff;
  background: rgba(198,40,40,0.85);
  padding: 1px 5px; border-radius: 6px;
  white-space: nowrap;
  box-shadow: 0 1px 2px rgba(0,0,0,0.2);
}
.slope-arrow-label.moderate {
  background: rgba(230,81,0,0.85);
}

.fab-col {
  position: absolute; right: 10px; z-index: 1000;
  display: flex; flex-direction: column; gap: 6px;
}
.fab-col.bot { bottom: 110px; }
.fab {
  width: 40px; height: 40px; border-radius: 50%; border: none;
  background: #fff; box-shadow: 0 1px 6px rgba(0,0,0,0.15);
  font-size: 18px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; transition: transform 0.15s;
}
.fab:active { transform: scale(0.9); }

.legend-bar {
  position: absolute; top: 52px; right: 10px; z-index: 999;
  background: #fff; border-radius: 8px; padding: 6px 8px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1); font-size: 10px; color: #888;
}
.legend-bar h4 { font-size: 11px; color: #555; margin-bottom: 3px; }
.lg-row { display: flex; align-items: center; margin-bottom: 1px; }
.lg-c { width: 14px; height: 8px; border-radius: 2px; margin-right: 4px; }

/* Contour desaturate: mix-blend-mode to keep only the lines */
.leaflet-contour-overlay {
  mix-blend-mode: multiply;
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(66,133,244,0.4); }
  70% { box-shadow: 0 0 0 14px rgba(66,133,244,0); }
  100% { box-shadow: 0 0 0 0 rgba(66,133,244,0); }
}
.my-dot {
  width: 14px; height: 14px; background: #4285F4;
  border: 2.5px solid #fff; border-radius: 50%; animation: pulse 2s infinite;
}
</style>
</head>
<body>

<div id="map"></div>

<div class="top-bar">
  <h1>ğŸš´ ê°•ë‚¨ ì˜¤ë¥´ë§‰ ì§€ë„ <span>ì–¸ë• í”¼í•´ì„œ íƒ€ì</span></h1>
  <div class="mode-tabs">
    <button class="mode-tab active" data-mode="explore">íƒìƒ‰</button>
    <button class="mode-tab" data-mode="compare">Aâ†’B ë¹„êµ</button>
  </div>
</div>

<div class="contour-control" id="layerPanel">
  <strong style="color:#333">ë ˆì´ì–´</strong>
  <hr>
  <label><input type="radio" name="base" value="clean" checked> ê¸°ë³¸ ì§€ë„</label>
  <label><input type="radio" name="base" value="satellite"> ìœ„ì„±</label>
  <hr>
  <label>ë“±ê³ ì„  ì§„í•˜ê¸°</label>
  <input type="range" id="contourOpacity" min="0" max="100" value="40">
  <hr>
  <label><input type="checkbox" id="chkHill" checked> ìŒì˜ê¸°ë³µ</label>
  <label><input type="checkbox" id="chkStation" checked> ğŸš‡ ì—­</label>
  <label><input type="checkbox" id="chkPeak" checked> â›°ï¸ ì‚°</label>
  <label><input type="checkbox" id="chkRoute" checked> ğŸŸ¢ ì¶”ì²œê²½ë¡œ</label>
  <label><input type="checkbox" id="chkSlope" checked> ğŸ”º ì˜¤ë¥´ë§‰ ë°©í–¥</label>
</div>

<div class="legend-bar">
  <h4>ğŸš´ ì§€ë„ ë²”ë¡€</h4>
  <div class="lg-row"><div class="lg-c" style="background:#4CAF50"></div>í‰ì§€ ìì „ê±°ê¸¸</div>
  <div class="lg-row"><div class="lg-c" style="background:#FF9800"></div>ì˜¤ë¥´ë§‰ ì£¼ì˜ êµ¬ê°„</div>
  <div class="lg-row"><div class="lg-c" style="background:#f44336"></div>ê¸‰ê²½ì‚¬ íšŒí”¼ êµ¬ê°„</div>
  <div class="lg-row" style="margin-top:3px;border-top:1px solid #eee;padding-top:3px">
    <span style="margin-right:4px">ğŸ”º</span> ì˜¤ë¥´ë§‰ ë°©í–¥ í™”ì‚´í‘œ
  </div>
  <div class="lg-row">
    <span style="font-size:9px;margin-right:4px">ã€°ï¸</span> ë“±ê³ ì„  (ê°€ê¹Œìš¸ìˆ˜ë¡ ê¸‰ê²½ì‚¬)
  </div>
</div>

<div class="fab-col bot">
  <button class="fab" id="btnLayers" title="ë ˆì´ì–´">ğŸ—ºï¸</button>
  <button class="fab" id="btnLocate" title="ë‚´ ìœ„ì¹˜">ğŸ“</button>
  <button class="fab" id="btnReset" title="ì „ì²´ë³´ê¸°">â†º</button>
</div>

<div class="bottom-sheet" id="bottomSheet">
  <div class="sheet-handle"></div>
  <div id="exploreInfo"><div class="hint-text">ì§€ë„ë¥¼ íƒ­í•˜ë©´ ê³ ë„ì™€ ê²½ì‚¬ íŒì •ì„ ë³¼ ìˆ˜ ìˆì–´ìš”</div></div>
  <div class="compare-info" id="compareInfo">
    <div class="hint-text" id="compareHint">ğŸ…°ï¸ ì¶œë°œ ì§€ì ì„ íƒ­í•˜ì„¸ìš”</div>
    <div id="compareResult" style="display:none">
      <div class="compare-row">
        <div class="compare-dot" style="background:#4CAF50"></div>
        <div><div class="compare-label">ì¶œë°œ</div><div class="compare-elev" id="elevA">â€”</div></div>
      </div>
      <div class="compare-row">
        <div class="compare-dot" style="background:#2196F3"></div>
        <div><div class="compare-label">ë„ì°©</div><div class="compare-elev" id="elevB">â€”</div></div>
      </div>
      <div class="compare-result-box" id="diffBox">
        <div class="compare-arrow" id="diffArrow"></div>
        <div>
          <div class="compare-diff" id="diffText">â€”</div>
          <div class="compare-verdict" id="diffVerdict"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const CENTER = [37.497, 127.047];
const BOUNDS = [[37.464, 127.012], [37.532, 127.105]];

// ===== Layers =====
const cleanBase = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
  maxZoom: 19, subdomains: 'abcd',
  attribution: 'Â© CARTO Â· Â© OSM'
});
const satBase = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 18 });

// Contour lines only â€” use multiply blend to strip the background colors
const contourOverlay = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
  maxZoom: 17, opacity: 0.4, className: 'leaflet-contour-overlay'
});
const hillOverlay = L.tileLayer('https://tiles.wmflabs.org/hillshading/{z}/{x}/{y}.png', {
  maxZoom: 17, opacity: 0.3
});

const map = L.map('map', {
  center: CENTER, zoom: 14,
  layers: [cleanBase, contourOverlay, hillOverlay],
  zoomControl: false
});
L.control.zoom({ position: 'bottomleft' }).addTo(map);
map.fitBounds(BOUNDS, { padding: [10, 60] });

// Contour opacity slider
document.getElementById('contourOpacity').addEventListener('input', e => {
  contourOverlay.setOpacity(e.target.value / 100);
});

// ===== Slope direction arrows =====
// These show which direction is UPHILL with arrow + grade info
// Placed at key cycling-relevant slope locations
const slopeGrp = L.layerGroup();

const slopeArrows = [
  // [lat, lng, arrow emoji (pointing uphill direction), label, steep?]
  // ëŒ€ëª¨ì‚° approaches
  { la:37.4790, lo:127.0780, dir:'â†—ï¸', label:'+80m ê¸‰ê²½ì‚¬', steep:true },
  { la:37.4760, lo:127.0850, dir:'â†’', label:'+60m ê¸‰ê²½ì‚¬', steep:true },
  { la:37.4810, lo:127.0870, dir:'â†˜ï¸', label:'+50m ê¸‰ê²½ì‚¬', steep:true },
  // êµ¬ë£¡ì‚° approaches
  { la:37.4820, lo:127.0580, dir:'â†“', label:'+70m ê¸‰ê²½ì‚¬', steep:true },
  { la:37.4760, lo:127.0650, dir:'â†—ï¸', label:'+90m ê¸‰ê²½ì‚¬', steep:true },
  // ë§¤ë´‰ì‚°
  { la:37.4880, lo:127.0400, dir:'â†‘', label:'+30m', steep:false },
  { la:37.4930, lo:127.0420, dir:'â†—ï¸', label:'+25m', steep:false },
  { la:37.4890, lo:127.0480, dir:'â†', label:'+20m', steep:false },
  // ìš°ë©´ì‚° approaches
  { la:37.4810, lo:127.0120, dir:'â†‘', label:'+60m ê¸‰ê²½ì‚¬', steep:true },
  { la:37.4750, lo:127.0050, dir:'â†—ï¸', label:'+80m ê¸‰ê²½ì‚¬', steep:true },
  // ì„¸ê³¡ë™ hills
  { la:37.4700, lo:127.0660, dir:'â†“', label:'+35m', steep:false },
  { la:37.4660, lo:127.0730, dir:'â†—ï¸', label:'+40m', steep:false },
  // ì—­ì‚¼/ë„ê³¡ minor hills
  { la:37.4950, lo:127.0400, dir:'â†‘', label:'+15m', steep:false },
  // ì¼ì›ë™
  { la:37.4850, lo:127.0920, dir:'â†', label:'+25m', steep:false },
  // ê°œí¬ë™ toward êµ¬ë£¡ì‚°
  { la:37.4800, lo:127.0560, dir:'â†“', label:'+45m', steep:false },
];

slopeArrows.forEach(s => {
  // Arrow
  L.marker([s.la, s.lo], {
    icon: L.divIcon({
      html: `<div class="slope-arrow">${s.dir}</div>`,
      className: '', iconSize: [20, 20], iconAnchor: [10, 10]
    }), interactive: false, zIndexOffset: 500
  }).addTo(slopeGrp);
  // Label slightly offset
  L.marker([s.la + 0.001, s.lo + 0.001], {
    icon: L.divIcon({
      html: `<div class="slope-arrow-label ${s.steep ? '' : 'moderate'}">${s.label}</div>`,
      className: '', iconAnchor: [0, 0]
    }), interactive: false, zIndexOffset: 500
  }).addTo(slopeGrp);
});
slopeGrp.addTo(map);

// ===== Flat routes =====
const routeGrp = L.layerGroup();
const flatPaths = [
  { n:'íƒ„ì²œ ìì „ê±°ê¸¸ (í‰ì§€)', pts:[[37.5145,127.0946],[37.5100,127.0920],[37.5040,127.0870],[37.4970,127.0810],[37.4910,127.0770],[37.4850,127.0730],[37.4780,127.0680],[37.4720,127.0640],[37.4665,127.0610]]},
  { n:'ì–‘ì¬ì²œ ìì „ê±°ê¸¸ (í‰ì§€)', pts:[[37.4842,127.0352],[37.4835,127.0420],[37.4830,127.0490],[37.4828,127.0560],[37.4825,127.0630],[37.4822,127.0700],[37.4820,127.0750]]},
  { n:'í•œê°• ìì „ê±°ê¸¸ (í‰ì§€)', pts:[[37.5240,127.0100],[37.5250,127.0200],[37.5260,127.0300],[37.5270,127.0400],[37.5265,127.0500],[37.5260,127.0600],[37.5255,127.0700],[37.5250,127.0800],[37.5245,127.0900],[37.5240,127.1000]]},
  { n:'í…Œí—¤ë€ë¡œ (ë¹„êµì  í‰ì§€)', pts:[[37.4979,127.0276],[37.4990,127.0330],[37.5007,127.0366],[37.5025,127.0420],[37.5045,127.0490],[37.5065,127.0560],[37.5088,127.0639]]},
];
flatPaths.forEach(r => {
  L.polyline(r.pts, { color: '#4CAF50', weight: 4, opacity: 0.65, lineCap: 'round' })
    .bindPopup(`<b>ğŸŸ¢ ${r.n}</b><br>ìì „ê±° íƒ€ê¸° ì¢‹ì€ í‰íƒ„ êµ¬ê°„`).addTo(routeGrp);
  const m = r.pts[Math.floor(r.pts.length/2)];
  L.marker(m, { icon: L.divIcon({ html:`<div class="flat-badge">ğŸŸ¢ ${r.n}</div>`, className:'', iconAnchor:[0,0]}), interactive:false }).addTo(routeGrp);
});

const cautionAreas = [
  { n:'ëŒ€ëª¨ì‚°Â·êµ¬ë£¡ì‚°', c:[37.476,127.073], r:600, steep:true },
  { n:'ë§¤ë´‰ì‚°', c:[37.489,127.040], r:350, steep:false },
  { n:'ìš°ë©´ì‚°', c:[37.478,127.010], r:450, steep:true },
  { n:'ì„¸ê³¡ë™ êµ¬ë¦‰', c:[37.468,127.070], r:400, steep:false },
];
cautionAreas.forEach(z => {
  const col = z.steep ? '#f44336' : '#FF9800';
  L.circle(z.c, { radius:z.r, color:col, fillColor:col, fillOpacity:0.08, weight:1.5, dashArray:'5,4' })
    .bindPopup(`<b>${z.steep?'ğŸ”´':'ğŸŸ '} ${z.n}</b><br>${z.steep?'ê¸‰ê²½ì‚¬ â€” ìì „ê±° íšŒí”¼ ê¶Œì¥':'ì˜¤ë¥´ë§‰ ì£¼ì˜'}`).addTo(routeGrp);
  L.marker(z.c, { icon: L.divIcon({ html:`<div class="flat-badge ${z.steep?'caution-badge':'moderate-badge'}">${z.steep?'ğŸ”´':'ğŸŸ '} ${z.n}</div>`, className:'', iconAnchor:[0,0]}), interactive:false }).addTo(routeGrp);
});
routeGrp.addTo(map);

// ===== Stations =====
const stnGrp = L.layerGroup();
[
  {n:'ê°•ë‚¨',la:37.4979,lo:127.0276,c:'s2'},{n:'ì—­ì‚¼',la:37.5007,lo:127.0366,c:'s2'},
  {n:'ì„ ë¦‰',la:37.5045,lo:127.0490,c:'s2'},{n:'ì‚¼ì„±',la:37.5088,lo:127.0639,c:'s2'},
  {n:'ì¢…í•©ìš´ë™ì¥',la:37.5107,lo:127.0736,c:'s2'},{n:'êµëŒ€',la:37.4934,lo:127.0146,c:'s2'},
  {n:'ì••êµ¬ì •',la:37.5270,lo:127.0286,c:'s3'},{n:'ì‹ ì‚¬',la:37.5164,lo:127.0203,c:'s3'},
  {n:'ë§¤ë´‰',la:37.4874,lo:127.0347,c:'s3'},{n:'ë„ê³¡',la:37.4915,lo:127.0455,c:'s3'},
  {n:'ëŒ€ì¹˜',la:37.4948,lo:127.0577,c:'s3'},{n:'í•™ì—¬ìš¸',la:37.4965,lo:127.0648,c:'s3'},
  {n:'ëŒ€ì²­',la:37.4920,lo:127.0744,c:'s3'},{n:'ì¼ì›',la:37.4836,lo:127.0867,c:'s3'},
  {n:'ìˆ˜ì„œ',la:37.4872,lo:127.1017,c:'s3'},
  {n:'ê°•ë‚¨êµ¬ì²­',la:37.5173,lo:127.0413,c:'s7'},{n:'ì²­ë‹´',la:37.5196,lo:127.0539,c:'s7'},
  {n:'ë…¼í˜„',la:37.5113,lo:127.0215,c:'s7'},{n:'í•™ë™',la:37.5146,lo:127.0319,c:'s7'},
  {n:'ë´‰ì€ì‚¬',la:37.5140,lo:127.0580,c:'s9'},{n:'ì–¸ì£¼',la:37.5072,lo:127.0340,c:'s9'},
  {n:'ì‹ ë…¼í˜„',la:37.5045,lo:127.0253,c:'s9'},{n:'ì„ ì •ë¦‰',la:37.5104,lo:127.0448,c:'s9'},
  {n:'ì–‘ì¬',la:37.4842,lo:127.0352,c:'ss'},
  {n:'í•œí‹°',la:37.4984,lo:127.0561,c:'sb'},{n:'êµ¬ë£¡',la:37.4847,lo:127.0538,c:'sb'},
  {n:'ê°œí¬ë™',la:37.4787,lo:127.0549,c:'sb'},{n:'ëŒ€ëª¨ì‚°ì…êµ¬',la:37.4765,lo:127.0772,c:'sb'},
].forEach(s => {
  L.marker([s.la,s.lo], { icon: L.divIcon({ html:`<div class="stn ${s.c}">${s.n}</div>`, className:'', iconAnchor:[0,-2]}), interactive:false }).addTo(stnGrp);
});
stnGrp.addTo(map);

// ===== Peaks =====
const peakGrp = L.layerGroup();
[
  {n:'ëŒ€ëª¨ì‚° 293m',la:37.4730,lo:127.0830},{n:'êµ¬ë£¡ì‚° 306m',la:37.4785,lo:127.0620},
  {n:'ë§¤ë´‰ì‚° 101m',la:37.4910,lo:127.0450},{n:'ìš°ë©´ì‚° 293m',la:37.4780,lo:127.0080},
].forEach(h => {
  L.marker([h.la,h.lo], { icon: L.divIcon({ html:`<div class="peak-label">â›°ï¸ ${h.n}</div>`, className:'', iconAnchor:[0,8]}), interactive:false }).addTo(peakGrp);
});
peakGrp.addTo(map);

// ===== Layer controls =====
const bases = { clean: cleanBase, satellite: satBase };
let curBase = 'clean';
document.querySelectorAll('input[name="base"]').forEach(r => {
  r.addEventListener('change', e => { map.removeLayer(bases[curBase]); curBase=e.target.value; map.addLayer(bases[curBase]); });
});
document.getElementById('chkHill').addEventListener('change', e => e.target.checked ? map.addLayer(hillOverlay) : map.removeLayer(hillOverlay));
document.getElementById('chkStation').addEventListener('change', e => e.target.checked ? map.addLayer(stnGrp) : map.removeLayer(stnGrp));
document.getElementById('chkPeak').addEventListener('change', e => e.target.checked ? map.addLayer(peakGrp) : map.removeLayer(peakGrp));
document.getElementById('chkRoute').addEventListener('change', e => e.target.checked ? map.addLayer(routeGrp) : map.removeLayer(routeGrp));
document.getElementById('chkSlope').addEventListener('change', e => e.target.checked ? map.addLayer(slopeGrp) : map.removeLayer(slopeGrp));
document.getElementById('btnLayers').addEventListener('click', () => document.getElementById('layerPanel').classList.toggle('show'));
document.getElementById('btnReset').addEventListener('click', () => map.fitBounds(BOUNDS, { padding:[10,60] }));

// ===== My location =====
let locM=null, locC=null;
document.getElementById('btnLocate').addEventListener('click', () => {
  if (!navigator.geolocation) return alert('ìœ„ì¹˜ ì„œë¹„ìŠ¤ ë¶ˆê°€');
  const b = document.getElementById('btnLocate'); b.textContent='â³';
  navigator.geolocation.getCurrentPosition(p => {
    const {latitude:la,longitude:lo,accuracy:ac}=p.coords;
    if(locM){map.removeLayer(locM);map.removeLayer(locC);}
    locM = L.marker([la,lo],{icon:L.divIcon({html:'<div class="my-dot"></div>',className:'',iconSize:[14,14],iconAnchor:[7,7]}),zIndexOffset:9999}).addTo(map);
    locC = L.circle([la,lo],{radius:ac,color:'#4285F4',fillColor:'#4285F4',fillOpacity:0.07,weight:1}).addTo(map);
    map.setView([la,lo],15); b.textContent='ğŸ“';
    fetchE(la,lo).then(e => { if(e!==null) locM.bindPopup(`ğŸ“ í˜„ìœ„ì¹˜ ê³ ë„: <b>${e}m</b>`).openPopup(); });
  }, err => { b.textContent='ğŸ“'; alert('ìœ„ì¹˜ ì˜¤ë¥˜: '+err.message); }, {enableHighAccuracy:true,timeout:10000});
});

// ===== Elevation API =====
async function fetchE(la,lo) {
  try { const r=await fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${la},${lo}`); const d=await r.json(); return d.results[0].elevation; }
  catch { return null; }
}

// ===== Mode & Click =====
let mode='explore', cmpState=0, ptA=null, ptB=null, mkA=null, mkB=null, cmpLine=null, clickMk=null;

document.querySelectorAll('.mode-tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.mode-tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    mode = t.dataset.mode;
    resetCmp();
    document.getElementById('exploreInfo').style.display = mode==='explore'?'block':'none';
    document.getElementById('compareInfo').style.display = mode==='compare'?'block':'none';
  });
});

function resetCmp() {
  cmpState=0; ptA=ptB=null;
  [mkA,mkB,cmpLine].forEach(m=>{if(m)map.removeLayer(m)});
  mkA=mkB=cmpLine=null;
  document.getElementById('compareHint').style.display='block';
  document.getElementById('compareHint').textContent='ğŸ…°ï¸ ì¶œë°œ ì§€ì ì„ íƒ­í•˜ì„¸ìš”';
  document.getElementById('compareResult').style.display='none';
  document.getElementById('exploreInfo').innerHTML='<div class="hint-text">ì§€ë„ë¥¼ íƒ­í•˜ë©´ ê³ ë„ì™€ ê²½ì‚¬ íŒì •ì„ ë³¼ ìˆ˜ ìˆì–´ìš”</div>';
}

function gradeInfo(elev) {
  if (elev > 80) return { text:'ê¸‰ê²½ì‚¬ êµ¬ê°„ â€” íšŒí”¼ ê¶Œì¥ ğŸš«', cls:'badge-danger', color:'#C62828' };
  if (elev > 40) return { text:'ì˜¤ë¥´ë§‰ ì£¼ì˜ âš ï¸', cls:'badge-warn', color:'#E65100' };
  return { text:'í‰ì§€ â€” ìì „ê±° OK ğŸš´', cls:'badge-safe', color:'#2E7D32' };
}

// Arrow decorator for compare line
function makeArrow(from, to, color) {
  const dx = to[1]-from[1], dy = to[0]-from[0];
  const angle = Math.atan2(dy, dx) * 180 / Math.PI;
  const midLat = (from[0]+to[0])/2, midLng = (from[1]+to[1])/2;
  // Rotated arrow at midpoint
  return L.marker([midLat, midLng], {
    icon: L.divIcon({
      html: `<div style="font-size:24px;transform:rotate(${-angle+90}deg);color:${color};text-shadow:0 0 4px #fff,0 0 4px #fff;">â¬†</div>`,
      className: '', iconSize: [24,24], iconAnchor: [12,12]
    }), interactive: false
  });
}

let cmpArrowMk = null;

map.on('click', async e => {
  const {lat,lng} = e.latlng;

  if (mode==='explore') {
    if(clickMk) map.removeLayer(clickMk);
    clickMk = L.circleMarker([lat,lng],{radius:5,color:'#333',fillColor:'#333',fillOpacity:0.9,weight:2}).addTo(map);
    document.getElementById('exploreInfo').innerHTML='<div class="hint-text">â³ ê³ ë„ ì¡°íšŒ ì¤‘...</div>';
    const el = await fetchE(lat,lng);
    if (el!==null) {
      const g = gradeInfo(el);
      document.getElementById('exploreInfo').innerHTML=`
        <div class="elev-info">
          <div class="elev-big" style="color:${g.color}">${el}<small>m</small></div>
          <div>
            <div class="elev-badge ${g.cls}">${g.text}</div>
            <div class="elev-coord">${lat.toFixed(5)}, ${lng.toFixed(5)}</div>
          </div>
        </div>`;
    } else {
      document.getElementById('exploreInfo').innerHTML='<div class="hint-text">âš ï¸ ì¡°íšŒ ì‹¤íŒ¨ â€” ë‹¤ì‹œ íƒ­í•´ë³´ì„¸ìš”</div>';
    }
  }

  else if (mode==='compare') {
    if (cmpState===0) {
      if(mkA) map.removeLayer(mkA);
      mkA = L.circleMarker([lat,lng],{radius:7,color:'#4CAF50',fillColor:'#4CAF50',fillOpacity:0.9}).addTo(map);
      ptA = {lat,lng,e:null};
      document.getElementById('compareHint').textContent='â³ ì¶œë°œ ê³ ë„ ì¡°íšŒ ì¤‘...';
      ptA.e = await fetchE(lat,lng);
      if (ptA.e!==null) { document.getElementById('compareHint').textContent=`ğŸ…°ï¸ ${ptA.e}m â€” ì´ì œ ğŸ…±ï¸ ë„ì°©ì„ íƒ­í•˜ì„¸ìš”`; cmpState=1; }
      else document.getElementById('compareHint').textContent='âš ï¸ ì‹¤íŒ¨, ë‹¤ì‹œ íƒ­';
    }
    else if (cmpState===1) {
      if(mkB) map.removeLayer(mkB);
      if(cmpLine) map.removeLayer(cmpLine);
      if(cmpArrowMk) map.removeLayer(cmpArrowMk);
      mkB = L.circleMarker([lat,lng],{radius:7,color:'#2196F3',fillColor:'#2196F3',fillOpacity:0.9}).addTo(map);
      cmpLine = L.polyline([[ptA.lat,ptA.lng],[lat,lng]],{color:'#555',weight:2,dashArray:'5,5',opacity:0.5}).addTo(map);
      ptB = {lat,lng,e:null};
      document.getElementById('compareHint').textContent='â³ ë„ì°© ê³ ë„ ì¡°íšŒ ì¤‘...';
      ptB.e = await fetchE(lat,lng);
      if (ptB.e!==null) {
        document.getElementById('compareHint').style.display='none';
        document.getElementById('compareResult').style.display='block';
        document.getElementById('elevA').textContent=ptA.e+'m';
        document.getElementById('elevB').textContent=ptB.e+'m';
        const d = ptB.e - ptA.e, ad = Math.abs(d);
        let arr,col,vd;
        if (d>10) { arr='ğŸ“ˆ'; col='#C62828'; vd=ad>30?'ì˜¤ë¥´ë§‰ ì‹¬í•¨! ğŸš« ë‹¤ë¥¸ ê¸¸ ì¶”ì²œ':'ì•½ê°„ ì˜¤ë¥´ë§‰ â€” í˜ë“¤ ìˆ˜ ìˆìŒ'; }
        else if (d<-10) { arr='ğŸ“‰'; col='#2E7D32'; vd='ë‚´ë¦¬ë§‰! í¸í•˜ê²Œ ê°ˆ ìˆ˜ ìˆì–´ìš” ğŸ‰'; }
        else { arr='â¡ï¸'; col='#2E7D32'; vd='ê±°ì˜ í‰ì§€! ìì „ê±° OK ğŸš´'; }
        document.getElementById('diffArrow').textContent=arr;
        document.getElementById('diffText').style.color=col;
        document.getElementById('diffText').textContent=`${d>0?'+':''}${d}m`;
        document.getElementById('diffVerdict').textContent=vd;

        // Direction arrow on the line (points from A to B, colored by slope)
        const arrowCol = d > 10 ? '#C62828' : d < -10 ? '#2E7D32' : '#888';
        cmpArrowMk = makeArrow([ptA.lat,ptA.lng],[lat,lng], arrowCol);
        cmpArrowMk.addTo(map);

        cmpState=2;
      } else { document.getElementById('compareHint').textContent='âš ï¸ ì‹¤íŒ¨, ë‹¤ì‹œ íƒ­'; document.getElementById('compareHint').style.display='block'; }
    }
    else if (cmpState===2) {
      if(cmpArrowMk) map.removeLayer(cmpArrowMk);
      resetCmp();
      map.fire('click',e);
    }
  }
});
</script>
</body>
</html>
