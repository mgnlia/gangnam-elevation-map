<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ê°•ë‚¨ ìì „ê±° ê³ ë„ ì§€ë„ ğŸš´</title>
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" />
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Apple SD Gothic Neo','Noto Sans KR',sans-serif}
#map{width:100%;height:100vh}

.top-bar{
  position:absolute;top:0;left:0;right:0;z-index:10;
  background:#fff;padding:10px 14px;
  display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid #e8e8e8;box-shadow:0 1px 4px rgba(0,0,0,0.06);
}
.top-bar h1{font-size:15px;font-weight:700;color:#333}
.top-bar h1 span{font-weight:400;color:#999;font-size:12px}
.mode-tabs{display:flex;gap:2px;background:#f2f2f2;border-radius:8px;padding:2px}
.mode-tab{
  padding:5px 14px;border:none;border-radius:7px;background:transparent;
  color:#888;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;
}
.mode-tab.active{background:#fff;color:#333;box-shadow:0 1px 3px rgba(0,0,0,0.1)}

.bottom-sheet{
  position:absolute;bottom:0;left:0;right:0;z-index:10;
  background:#fff;border-radius:16px 16px 0 0;
  padding:10px 16px;padding-bottom:max(14px,env(safe-area-inset-bottom));
  box-shadow:0 -2px 12px rgba(0,0,0,0.08);
}
.sheet-handle{width:36px;height:4px;background:#ddd;border-radius:2px;margin:0 auto 10px}
.elev-info{display:flex;align-items:center;gap:14px}
.elev-big{font-size:34px;font-weight:800;color:#333;line-height:1}
.elev-big small{font-size:14px;font-weight:500;color:#999}
.elev-badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:12px;font-weight:700;margin-bottom:2px}
.badge-safe{background:#E8F5E9;color:#2E7D32}
.badge-warn{background:#FFF3E0;color:#E65100}
.badge-danger{background:#FFEBEE;color:#C62828}
.elev-coord{font-size:11px;color:#bbb}

.compare-info{display:none}
.compare-row{display:flex;align-items:center;gap:10px;margin-bottom:6px}
.compare-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.compare-label{font-size:11px;color:#999}
.compare-elev{font-size:15px;font-weight:700;color:#333}
.compare-result-box{background:#f8f8f8;border-radius:10px;padding:10px 14px;margin-top:6px;display:flex;align-items:center;gap:12px}
.compare-arrow{font-size:22px}
.compare-diff{font-size:20px;font-weight:800}
.compare-verdict{font-size:12px;color:#888}
.hint-text{font-size:13px;color:#bbb;text-align:center;padding:6px 0}

.ctrl-panel{
  position:absolute;top:52px;left:10px;z-index:10;
  background:#fff;border-radius:10px;padding:8px 12px;
  box-shadow:0 1px 6px rgba(0,0,0,0.1);font-size:11px;color:#666;
  display:none;
}
.ctrl-panel.show{display:block}
.ctrl-panel label{display:flex;align-items:center;gap:6px;margin-bottom:3px;cursor:pointer}
.ctrl-panel input[type="range"]{width:100px}
.ctrl-panel hr{border:none;border-top:1px solid #eee;margin:5px 0}

.legend-bar{
  position:absolute;top:52px;right:10px;z-index:9;
  background:#fff;border-radius:8px;padding:6px 8px;
  box-shadow:0 1px 4px rgba(0,0,0,0.1);font-size:10px;color:#888;
}
.legend-bar h4{font-size:11px;color:#555;margin-bottom:3px}
.lg-row{display:flex;align-items:center;margin-bottom:1px}
.lg-c{width:14px;height:8px;border-radius:2px;margin-right:4px}

.fab-col{
  position:absolute;right:10px;z-index:10;
  display:flex;flex-direction:column;gap:8px;
}
.fab-col.bot{bottom:130px}
@media(max-width:600px){.fab-col.bot{bottom:100px}}
.fab{
  width:44px;height:44px;border-radius:50%;border:none;
  background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.2);
  font-size:20px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:transform .15s;-webkit-tap-highlight-color:transparent;
}
.fab:active{transform:scale(0.9)}
.fab-locate{width:48px;height:48px;font-size:22px;background:#4285F4;color:#fff;box-shadow:0 2px 10px rgba(66,133,244,0.4)}

.pitch-hint{
  position:absolute;bottom:130px;left:50%;transform:translateX(-50%);z-index:10;
  background:rgba(0,0,0,0.7);color:#fff;border-radius:20px;
  padding:6px 14px;font-size:12px;pointer-events:none;
  opacity:0;transition:opacity .5s;
}
.pitch-hint.show{opacity:1}
</style>
</head>
<body>

<div id="map"></div>

<div class="top-bar">
  <h1>ğŸš´ ê°•ë‚¨ ì˜¤ë¥´ë§‰ ì§€ë„ <span>ì–¸ë• í”¼í•´ì„œ íƒ€ì</span></h1>
  <div class="mode-tabs">
    <button class="mode-tab active" data-mode="explore">íƒìƒ‰</button>
    <button class="mode-tab" data-mode="compare">Aâ†’B ë¹„êµ</button>
  </div>
</div>

<div class="ctrl-panel" id="layerPanel">
  <strong style="color:#333">ë ˆì´ì–´</strong>
  <hr>
  <label>ë“±ê³ ì„  ì§„í•˜ê¸°</label>
  <input type="range" id="contourOpacity" min="0" max="100" value="75">
  <hr>
  <label><input type="checkbox" id="chk3d" checked> ğŸ”ï¸ 3D ì§€í˜•</label>
  <label><input type="checkbox" id="chkStation" checked> ğŸš‡ ì—­</label>
  <label><input type="checkbox" id="chkRoute" checked> ğŸŸ¢ ì¶”ì²œê²½ë¡œ</label>
  <label><input type="checkbox" id="chkSlope" checked> ğŸ”º ì˜¤ë¥´ë§‰ ë°©í–¥</label>
</div>

<div class="legend-bar">
  <h4>ğŸš´ ì§€ë„ ë²”ë¡€</h4>
  <div class="lg-row"><div class="lg-c" style="background:#4CAF50"></div>í‰ì§€ ìì „ê±°ê¸¸</div>
  <div class="lg-row"><div class="lg-c" style="background:#FF9800"></div>ì˜¤ë¥´ë§‰ ì£¼ì˜ êµ¬ê°„</div>
  <div class="lg-row"><div class="lg-c" style="background:#f44336"></div>ê¸‰ê²½ì‚¬ íšŒí”¼ êµ¬ê°„</div>
  <div class="lg-row" style="margin-top:3px;border-top:1px solid #eee;padding-top:3px">
    <span style="margin-right:4px">ğŸ”º</span> ì˜¤ë¥´ë§‰ ë°©í–¥
  </div>
  <div class="lg-row"><span style="font-size:9px;margin-right:4px">ã€°ï¸</span> ë“±ê³ ì„ </div>
  <div class="lg-row" style="margin-top:3px;border-top:1px solid #eee;padding-top:3px;color:#666">
    ğŸ¤ ë‘ ì†ê°€ë½ íšŒì „/ê¸°ìš¸ì´ê¸°
  </div>
</div>

<div class="fab-col bot">
  <button class="fab" id="btnLayers" title="ë ˆì´ì–´">ğŸ—ºï¸</button>
  <button class="fab fab-locate" id="btnLocate" title="ë‚´ ìœ„ì¹˜">ğŸ“</button>
  <button class="fab" id="btnReset" title="ì „ì²´ë³´ê¸°">â†º</button>
  <button class="fab" id="btn3dToggle" title="3D/2D ì „í™˜">ğŸ”ï¸</button>
</div>

<div class="pitch-hint" id="pitchHint">ğŸ¤ ë‘ ì†ê°€ë½ìœ¼ë¡œ íšŒì „ & ê¸°ìš¸ì´ê¸°</div>

<div class="bottom-sheet">
  <div class="sheet-handle"></div>
  <div id="exploreInfo"><div class="hint-text">ì§€ë„ë¥¼ íƒ­í•˜ë©´ ê³ ë„ì™€ ê²½ì‚¬ íŒì •ì„ ë³¼ ìˆ˜ ìˆì–´ìš”</div></div>
  <div class="compare-info" id="compareInfo">
    <div class="hint-text" id="compareHint">ğŸ…°ï¸ ì¶œë°œ ì§€ì ì„ íƒ­í•˜ì„¸ìš”</div>
    <div id="compareResult" style="display:none">
      <div class="compare-row">
        <div class="compare-dot" style="background:#4CAF50"></div>
        <div><div class="compare-label">ì¶œë°œ</div><div class="compare-elev" id="elevA">â€”</div></div>
      </div>
      <div class="compare-row">
        <div class="compare-dot" style="background:#2196F3"></div>
        <div><div class="compare-label">ë„ì°©</div><div class="compare-elev" id="elevB">â€”</div></div>
      </div>
      <div class="compare-result-box" id="diffBox">
        <div class="compare-arrow" id="diffArrow"></div>
        <div>
          <div class="compare-diff" id="diffText">â€”</div>
          <div class="compare-verdict" id="diffVerdict"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
<script>
const DEFAULT_LOC = [127.0448, 37.5104]; // ì„ ì •ë¦‰ì—­ [lng, lat]
const GANGNAM_CENTER = [127.047, 37.497];

// ===== Map =====
const map = new maplibregl.Map({
  container: 'map',
  style: {
    version: 8,
    sources: {
      'carto': {
        type: 'raster',
        tiles: ['https://a.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}@2x.png'],
        tileSize: 256,
        attribution: 'Â© CARTO Â· Â© OSM'
      },
      'contour': {
        type: 'raster',
        tiles: ['https://a.tile.opentopomap.org/{z}/{x}/{y}.png','https://b.tile.opentopomap.org/{z}/{x}/{y}.png'],
        tileSize: 256
      },
      'hillshade-tiles': {
        type: 'raster',
        tiles: ['https://tiles.wmflabs.org/hillshading/{z}/{x}/{y}.png'],
        tileSize: 256
      },
      'terrain-dem': {
        type: 'raster-dem',
        tiles: ['https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png'],
        tileSize: 256,
        encoding: 'terrarium'
      }
    },
    layers: [
      { id: 'base', type: 'raster', source: 'carto' },
      { id: 'contour-overlay', type: 'raster', source: 'contour', paint: { 'raster-opacity': 0.75, 'raster-contrast': 0.15 } },
      { id: 'hill-overlay', type: 'raster', source: 'hillshade-tiles', paint: { 'raster-opacity': 0.55 } }
    ],
    terrain: { source: 'terrain-dem', exaggeration: 2.0 }
  },
  center: DEFAULT_LOC,
  zoom: 14,
  pitch: 40,
  bearing: 0,
  maxPitch: 70,
  touchPitch: true,
  dragRotate: true,
  touchZoomRotate: true
});

// Nav controls
map.addControl(new maplibregl.NavigationControl({ showCompass: true, showZoom: true }), 'bottom-left');

// Show pitch hint on first load
setTimeout(() => {
  const h = document.getElementById('pitchHint');
  h.classList.add('show');
  setTimeout(() => h.classList.remove('show'), 4000);
}, 2000);

// ===== GeoJSON sources for overlays =====
map.on('load', () => {
  // --- Flat routes ---
  const flatRoutes = [
    { name: 'íƒ„ì²œ ìì „ê±°ê¸¸', coords: [[127.0946,37.5145],[127.0920,37.5100],[127.0870,37.5040],[127.0810,37.4970],[127.0770,37.4910],[127.0730,37.4850],[127.0680,37.4780],[127.0640,37.4720],[127.0610,37.4665]] },
    { name: 'ì–‘ì¬ì²œ ìì „ê±°ê¸¸', coords: [[127.0352,37.4842],[127.0420,37.4835],[127.0490,37.4830],[127.0560,37.4828],[127.0630,37.4825],[127.0700,37.4822],[127.0750,37.4820]] },
    { name: 'í•œê°• ìì „ê±°ê¸¸', coords: [[127.0100,37.5240],[127.0200,37.5250],[127.0300,37.5260],[127.0400,37.5270],[127.0500,37.5265],[127.0600,37.5260],[127.0700,37.5255],[127.0800,37.5250],[127.0900,37.5245],[127.1000,37.5240]] },
    { name: 'í…Œí—¤ë€ë¡œ', coords: [[127.0276,37.4979],[127.0330,37.4990],[127.0366,37.5007],[127.0420,37.5025],[127.0490,37.5045],[127.0560,37.5065],[127.0639,37.5088]] },
  ];
  const routeFeatures = flatRoutes.map(r => ({
    type: 'Feature', properties: { name: r.name },
    geometry: { type: 'LineString', coordinates: r.coords }
  }));

  map.addSource('flat-routes', { type: 'geojson', data: { type: 'FeatureCollection', features: routeFeatures } });
  map.addLayer({ id: 'flat-routes-line', type: 'line', source: 'flat-routes',
    paint: { 'line-color': '#4CAF50', 'line-width': 5, 'line-opacity': 0.7 },
    layout: { 'line-cap': 'round', 'line-join': 'round' }
  });
  map.addLayer({ id: 'flat-routes-label', type: 'symbol', source: 'flat-routes',
    layout: { 'symbol-placement': 'line-center', 'text-field': ['concat', 'ğŸŸ¢ ', ['get', 'name']],
      'text-size': 11, 'text-font': ['Open Sans Bold','Arial Unicode MS Bold'],
      'text-allow-overlap': true
    },
    paint: { 'text-color': '#1B5E20', 'text-halo-color': '#fff', 'text-halo-width': 2 }
  });

  // --- Caution zones ---
  const cautionZones = [
    { name: 'ëŒ€ëª¨ì‚°Â·êµ¬ë£¡ì‚°', center: [127.073,37.476], radius: 600, steep: true },
    { name: 'ë§¤ë´‰ì‚°', center: [127.040,37.489], radius: 350, steep: false },
    { name: 'ìš°ë©´ì‚°', center: [127.010,37.478], radius: 450, steep: true },
    { name: 'ì„¸ê³¡ë™ êµ¬ë¦‰', center: [127.070,37.468], radius: 400, steep: false },
  ];
  // Approximate circles as polygons
  function makeCircle(c, r, n=32) {
    const coords = [];
    for (let i=0;i<=n;i++) {
      const a = (i/n)*2*Math.PI;
      const dlat = (r/111320)*Math.cos(a);
      const dlng = (r/(111320*Math.cos(c[1]*Math.PI/180)))*Math.sin(a);
      coords.push([c[0]+dlng, c[1]+dlat]);
    }
    return coords;
  }
  const cautionFeatures = cautionZones.map(z => ({
    type: 'Feature',
    properties: { name: z.name, steep: z.steep },
    geometry: { type: 'Polygon', coordinates: [makeCircle(z.center, z.radius)] }
  }));
  map.addSource('caution-zones', { type: 'geojson', data: { type: 'FeatureCollection', features: cautionFeatures } });
  map.addLayer({ id: 'caution-fill', type: 'fill', source: 'caution-zones',
    paint: { 'fill-color': ['case', ['get','steep'], '#f44336', '#FF9800'], 'fill-opacity': 0.12 }
  });
  map.addLayer({ id: 'caution-border', type: 'line', source: 'caution-zones',
    paint: { 'line-color': ['case', ['get','steep'], '#f44336', '#FF9800'], 'line-width': 2, 'line-dasharray': [4,3] }
  });
  map.addLayer({ id: 'caution-label', type: 'symbol', source: 'caution-zones',
    layout: { 'text-field': ['concat', ['case',['get','steep'],'ğŸ”´','ğŸŸ '], ' ', ['get','name']],
      'text-size': 11, 'text-font': ['Open Sans Bold','Arial Unicode MS Bold']
    },
    paint: { 'text-color': ['case',['get','steep'],'#C62828','#E65100'], 'text-halo-color': '#fff', 'text-halo-width': 2 }
  });

  // --- Stations ---
  const stations = [
    {n:'ê°•ë‚¨',la:37.4979,lo:127.0276,c:'#1a6b24',l:'2'},
    {n:'ì—­ì‚¼',la:37.5007,lo:127.0366,c:'#1a6b24',l:'2'},
    {n:'ì„ ë¦‰',la:37.5045,lo:127.0490,c:'#1a6b24',l:'2'},
    {n:'ì‚¼ì„±',la:37.5088,lo:127.0639,c:'#1a6b24',l:'2'},
    {n:'ì¢…í•©ìš´ë™ì¥',la:37.5107,lo:127.0736,c:'#1a6b24',l:'2'},
    {n:'êµëŒ€',la:37.4934,lo:127.0146,c:'#1a6b24',l:'2'},
    {n:'ì••êµ¬ì •',la:37.5270,lo:127.0286,c:'#c43d08',l:'3'},
    {n:'ì‹ ì‚¬',la:37.5164,lo:127.0203,c:'#c43d08',l:'3'},
    {n:'ë§¤ë´‰',la:37.4874,lo:127.0347,c:'#c43d08',l:'3'},
    {n:'ë„ê³¡',la:37.4915,lo:127.0455,c:'#c43d08',l:'3'},
    {n:'ëŒ€ì¹˜',la:37.4948,lo:127.0577,c:'#c43d08',l:'3'},
    {n:'í•™ì—¬ìš¸',la:37.4965,lo:127.0648,c:'#c43d08',l:'3'},
    {n:'ëŒ€ì²­',la:37.4920,lo:127.0744,c:'#c43d08',l:'3'},
    {n:'ì¼ì›',la:37.4836,lo:127.0867,c:'#c43d08',l:'3'},
    {n:'ìˆ˜ì„œ',la:37.4872,lo:127.1017,c:'#c43d08',l:'3'},
    {n:'ê°•ë‚¨êµ¬ì²­',la:37.5173,lo:127.0413,c:'#3d5516',l:'7'},
    {n:'ì²­ë‹´',la:37.5196,lo:127.0539,c:'#3d5516',l:'7'},
    {n:'ë…¼í˜„',la:37.5113,lo:127.0215,c:'#3d5516',l:'7'},
    {n:'í•™ë™',la:37.5146,lo:127.0319,c:'#3d5516',l:'7'},
    {n:'ë´‰ì€ì‚¬',la:37.5140,lo:127.0580,c:'#6b5c38',l:'9'},
    {n:'ì–¸ì£¼',la:37.5072,lo:127.0340,c:'#6b5c38',l:'9'},
    {n:'ì‹ ë…¼í˜„',la:37.5045,lo:127.0253,c:'#6b5c38',l:'9'},
    {n:'ì„ ì •ë¦‰',la:37.5104,lo:127.0448,c:'#6b5c38',l:'9'},
    {n:'ì–‘ì¬',la:37.4842,lo:127.0352,c:'#a01528',l:'ì‹ ë¶„ë‹¹'},
    {n:'í•œí‹°',la:37.4984,lo:127.0561,c:'#9a7510',l:'ë¶„ë‹¹'},
    {n:'êµ¬ë£¡',la:37.4847,lo:127.0538,c:'#9a7510',l:'ë¶„ë‹¹'},
    {n:'ê°œí¬ë™',la:37.4787,lo:127.0549,c:'#9a7510',l:'ë¶„ë‹¹'},
    {n:'ëŒ€ëª¨ì‚°ì…êµ¬',la:37.4765,lo:127.0772,c:'#9a7510',l:'ë¶„ë‹¹'},
  ];
  const stnFeatures = stations.map(s => ({
    type: 'Feature',
    properties: { name: s.n, color: s.c, line: s.l },
    geometry: { type: 'Point', coordinates: [s.lo, s.la] }
  }));
  map.addSource('stations', { type: 'geojson', data: { type: 'FeatureCollection', features: stnFeatures } });
  // Station dot
  map.addLayer({ id: 'station-circle', type: 'circle', source: 'stations',
    paint: { 'circle-radius': 4, 'circle-color': ['get','color'], 'circle-stroke-color': '#fff', 'circle-stroke-width': 1.5, 'circle-pitch-alignment': 'map' }
  });
  // Station label - 3D: pitched with map, rotates with bearing
  map.addLayer({ id: 'station-label', type: 'symbol', source: 'stations',
    layout: {
      'text-field': ['get','name'],
      'text-size': 13, 'text-font': ['Open Sans Bold','Arial Unicode MS Bold'],
      'text-offset': [0, 1.2], 'text-anchor': 'top',
      'text-allow-overlap': false, 'text-optional': true,
      'text-pitch-alignment': 'map',
      'text-rotation-alignment': 'map',
      'symbol-placement': 'point'
    },
    paint: {
      'text-color': ['get','color'],
      'text-halo-color': 'rgba(255,255,255,0.7)', 'text-halo-width': 1.5, 'text-halo-blur': 1
    }
  });

  // --- Slope arrows ---
  const slopes = [
    {la:37.4790,lo:127.0780,dir:'â†—',label:'+80m',steep:true},
    {la:37.4760,lo:127.0850,dir:'â†’',label:'+60m',steep:true},
    {la:37.4810,lo:127.0870,dir:'â†˜',label:'+50m',steep:true},
    {la:37.4820,lo:127.0580,dir:'â†“',label:'+70m',steep:true},
    {la:37.4760,lo:127.0650,dir:'â†—',label:'+90m',steep:true},
    {la:37.4880,lo:127.0400,dir:'â†‘',label:'+30m',steep:false},
    {la:37.4930,lo:127.0420,dir:'â†—',label:'+25m',steep:false},
    {la:37.4890,lo:127.0480,dir:'â†',label:'+20m',steep:false},
    {la:37.4810,lo:127.0120,dir:'â†‘',label:'+60m',steep:true},
    {la:37.4750,lo:127.0050,dir:'â†—',label:'+80m',steep:true},
    {la:37.4700,lo:127.0660,dir:'â†“',label:'+35m',steep:false},
    {la:37.4660,lo:127.0730,dir:'â†—',label:'+40m',steep:false},
    {la:37.4850,lo:127.0920,dir:'â†',label:'+25m',steep:false},
    {la:37.4800,lo:127.0560,dir:'â†“',label:'+45m',steep:false},
  ];
  const slopeFeatures = slopes.map(s => ({
    type: 'Feature',
    properties: { dir: s.dir, label: s.label, steep: s.steep },
    geometry: { type: 'Point', coordinates: [s.lo, s.la] }
  }));
  map.addSource('slopes', { type: 'geojson', data: { type: 'FeatureCollection', features: slopeFeatures } });
  map.addLayer({ id: 'slope-arrow', type: 'symbol', source: 'slopes',
    layout: {
      'text-field': ['concat', ['get','dir'], ' ', ['get','label']],
      'text-size': 14, 'text-font': ['Open Sans Bold','Arial Unicode MS Bold'],
      'text-allow-overlap': true
    },
    paint: {
      'text-color': ['case', ['get','steep'], '#C62828', '#E65100'],
      'text-halo-color': '#fff', 'text-halo-width': 2
    }
  });

  // --- Peaks ---
  const peaks = [
    {n:'â›°ï¸ ëŒ€ëª¨ì‚° 293m',la:37.4730,lo:127.0830},
    {n:'â›°ï¸ êµ¬ë£¡ì‚° 306m',la:37.4785,lo:127.0620},
    {n:'â›°ï¸ ë§¤ë´‰ì‚° 101m',la:37.4910,lo:127.0450},
    {n:'â›°ï¸ ìš°ë©´ì‚° 293m',la:37.4780,lo:127.0080},
  ];
  map.addSource('peaks', { type: 'geojson', data: {
    type: 'FeatureCollection',
    features: peaks.map(p => ({ type:'Feature', properties:{name:p.n}, geometry:{type:'Point',coordinates:[p.lo,p.la]} }))
  }});
  map.addLayer({ id: 'peak-label', type: 'symbol', source: 'peaks',
    layout: { 'text-field': ['get','name'], 'text-size': 12, 'text-font': ['Open Sans Bold','Arial Unicode MS Bold'], 'text-allow-overlap': true },
    paint: { 'text-color': '#C62828', 'text-halo-color': '#fff', 'text-halo-width': 2 }
  });

  // --- Default location marker ---
  addLocMarker(DEFAULT_LOC);
});

// ===== Location marker =====
let locMarkerEl = null;
let locMarker = null;

function addLocMarker(lnglat) {
  if (locMarker) locMarker.remove();
  locMarkerEl = document.createElement('div');
  locMarkerEl.innerHTML = '<div style="width:18px;height:18px;background:#4285F4;border:3px solid #fff;border-radius:50%;box-shadow:0 0 0 0 rgba(66,133,244,0.5),0 1px 4px rgba(0,0,0,0.3);animation:pulse 2s infinite"></div>';
  locMarker = new maplibregl.Marker({ element: locMarkerEl }).setLngLat(lnglat).addTo(map);
}

// Inject pulse keyframes
const styleSheet = document.createElement('style');
styleSheet.textContent = '@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(66,133,244,0.5),0 1px 4px rgba(0,0,0,0.3)}70%{box-shadow:0 0 0 18px rgba(66,133,244,0),0 1px 4px rgba(0,0,0,0.3)}100%{box-shadow:0 0 0 0 rgba(66,133,244,0),0 1px 4px rgba(0,0,0,0.3)}}';
document.head.appendChild(styleSheet);

// ===== Controls =====
document.getElementById('btnLayers').addEventListener('click', () => document.getElementById('layerPanel').classList.toggle('show'));
document.getElementById('btnReset').addEventListener('click', () => {
  map.flyTo({ center: GANGNAM_CENTER, zoom: 14, pitch: 40, bearing: 0, duration: 1000 });
});

let is3d = true;
document.getElementById('btn3dToggle').addEventListener('click', () => {
  is3d = !is3d;
  if (is3d) {
    map.setTerrain({ source: 'terrain-dem', exaggeration: 2.0 });
    map.easeTo({ pitch: 40, duration: 500 });
    document.getElementById('btn3dToggle').textContent = 'ğŸ”ï¸';
  } else {
    map.setTerrain(null);
    map.easeTo({ pitch: 0, bearing: 0, duration: 500 });
    document.getElementById('btn3dToggle').textContent = '2D';
  }
});

document.getElementById('chk3d').addEventListener('change', e => {
  if (e.target.checked) {
    map.setTerrain({ source: 'terrain-dem', exaggeration: 2.0 });
  } else {
    map.setTerrain(null);
    map.easeTo({ pitch: 0, bearing: 0, duration: 300 });
  }
});

document.getElementById('contourOpacity').addEventListener('input', e => {
  map.setPaintProperty('contour-overlay', 'raster-opacity', e.target.value / 100);
});

document.getElementById('chkStation').addEventListener('change', e => {
  const v = e.target.checked ? 'visible' : 'none';
  map.setLayoutProperty('station-circle', 'visibility', v);
  map.setLayoutProperty('station-label', 'visibility', v);
});
document.getElementById('chkRoute').addEventListener('change', e => {
  const v = e.target.checked ? 'visible' : 'none';
  ['flat-routes-line','flat-routes-label','caution-fill','caution-border','caution-label'].forEach(l => map.setLayoutProperty(l,'visibility',v));
});
document.getElementById('chkSlope').addEventListener('change', e => {
  map.setLayoutProperty('slope-arrow', 'visibility', e.target.checked ? 'visible' : 'none');
});

// ===== My Location =====
document.getElementById('btnLocate').addEventListener('click', () => {
  if (!navigator.geolocation) return alert('ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.');
  const b = document.getElementById('btnLocate');
  b.textContent = 'â³'; b.style.opacity = '0.6';
  navigator.geolocation.getCurrentPosition(p => {
    const ll = [p.coords.longitude, p.coords.latitude];
    addLocMarker(ll);
    map.flyTo({ center: ll, zoom: 15, duration: 800 });
    b.textContent = 'ğŸ“'; b.style.opacity = '1';
    fetchE(p.coords.latitude, p.coords.longitude).then(el => {
      if (el !== null) new maplibregl.Popup({ offset: 12 }).setLngLat(ll).setHTML(`ğŸ“ í˜„ìœ„ì¹˜ ê³ ë„: <b>${el}m</b>`).addTo(map);
    });
  }, err => {
    b.textContent = 'ğŸ“'; b.style.opacity = '1';
    if (err.code === 1) alert('ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
    else alert('ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ìš”.');
  }, { enableHighAccuracy: true, timeout: 15000 });
});

// Auto-locate on mobile
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(p => {
    addLocMarker([p.coords.longitude, p.coords.latitude]);
  }, () => {}, { enableHighAccuracy: false, timeout: 8000, maximumAge: 60000 });
}

// ===== Elevation API =====
async function fetchE(la, lo) {
  try {
    const r = await fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${la},${lo}`);
    const d = await r.json();
    return d.results[0].elevation;
  } catch { return null; }
}

// ===== Click & Mode =====
let mode = 'explore', cmpState = 0, ptA = null, ptB = null;
let cmpMarkers = [];

document.querySelectorAll('.mode-tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.mode-tab').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    mode = t.dataset.mode;
    resetCmp();
    document.getElementById('exploreInfo').style.display = mode === 'explore' ? 'block' : 'none';
    document.getElementById('compareInfo').style.display = mode === 'compare' ? 'block' : 'none';
  });
});

function resetCmp() {
  cmpState = 0; ptA = ptB = null;
  cmpMarkers.forEach(m => m.remove()); cmpMarkers = [];
  if (map.getSource('cmp-line')) { map.removeLayer('cmp-line-layer'); map.removeSource('cmp-line'); }
  document.getElementById('compareHint').style.display = 'block';
  document.getElementById('compareHint').textContent = 'ğŸ…°ï¸ ì¶œë°œ ì§€ì ì„ íƒ­í•˜ì„¸ìš”';
  document.getElementById('compareResult').style.display = 'none';
  document.getElementById('exploreInfo').innerHTML = '<div class="hint-text">ì§€ë„ë¥¼ íƒ­í•˜ë©´ ê³ ë„ì™€ ê²½ì‚¬ íŒì •ì„ ë³¼ ìˆ˜ ìˆì–´ìš”</div>';
}

function gradeInfo(elev) {
  if (elev > 80) return { text: 'ê¸‰ê²½ì‚¬ êµ¬ê°„ â€” íšŒí”¼ ê¶Œì¥ ğŸš«', cls: 'badge-danger', color: '#C62828' };
  if (elev > 40) return { text: 'ì˜¤ë¥´ë§‰ ì£¼ì˜ âš ï¸', cls: 'badge-warn', color: '#E65100' };
  return { text: 'í‰ì§€ â€” ìì „ê±° OK ğŸš´', cls: 'badge-safe', color: '#2E7D32' };
}

function makeDotMarker(lnglat, color) {
  const el = document.createElement('div');
  el.style.cssText = `width:14px;height:14px;background:${color};border:2px solid #fff;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,0.3)`;
  const m = new maplibregl.Marker({ element: el }).setLngLat(lnglat).addTo(map);
  cmpMarkers.push(m);
  return m;
}

map.on('click', async (e) => {
  const { lng, lat } = e.lngLat;

  if (mode === 'explore') {
    cmpMarkers.forEach(m => m.remove()); cmpMarkers = [];
    makeDotMarker([lng, lat], '#333');
    document.getElementById('exploreInfo').innerHTML = '<div class="hint-text">â³ ê³ ë„ ì¡°íšŒ ì¤‘...</div>';
    const el = await fetchE(lat, lng);
    if (el !== null) {
      const g = gradeInfo(el);
      document.getElementById('exploreInfo').innerHTML = `
        <div class="elev-info">
          <div class="elev-big" style="color:${g.color}">${el}<small>m</small></div>
          <div>
            <div class="elev-badge ${g.cls}">${g.text}</div>
            <div class="elev-coord">${lat.toFixed(5)}, ${lng.toFixed(5)}</div>
          </div>
        </div>`;
    } else {
      document.getElementById('exploreInfo').innerHTML = '<div class="hint-text">âš ï¸ ì¡°íšŒ ì‹¤íŒ¨ â€” ë‹¤ì‹œ íƒ­í•´ë³´ì„¸ìš”</div>';
    }
  }

  else if (mode === 'compare') {
    if (cmpState === 0) {
      makeDotMarker([lng, lat], '#4CAF50');
      ptA = { lat, lng, e: null };
      document.getElementById('compareHint').textContent = 'â³ ì¶œë°œ ê³ ë„ ì¡°íšŒ ì¤‘...';
      ptA.e = await fetchE(lat, lng);
      if (ptA.e !== null) {
        document.getElementById('compareHint').textContent = `ğŸ…°ï¸ ${ptA.e}m â€” ì´ì œ ğŸ…±ï¸ ë„ì°©ì„ íƒ­í•˜ì„¸ìš”`;
        cmpState = 1;
      } else document.getElementById('compareHint').textContent = 'âš ï¸ ì‹¤íŒ¨, ë‹¤ì‹œ íƒ­';
    }
    else if (cmpState === 1) {
      makeDotMarker([lng, lat], '#2196F3');
      // Draw line
      if (map.getSource('cmp-line')) { map.removeLayer('cmp-line-layer'); map.removeSource('cmp-line'); }
      map.addSource('cmp-line', { type: 'geojson', data: {
        type: 'Feature', geometry: { type: 'LineString', coordinates: [[ptA.lng,ptA.lat],[lng,lat]] }
      }});
      map.addLayer({ id: 'cmp-line-layer', type: 'line', source: 'cmp-line',
        paint: { 'line-color': '#555', 'line-width': 2, 'line-dasharray': [4,3] }
      });
      ptB = { lat, lng, e: null };
      document.getElementById('compareHint').textContent = 'â³ ë„ì°© ê³ ë„ ì¡°íšŒ ì¤‘...';
      ptB.e = await fetchE(lat, lng);
      if (ptB.e !== null) {
        document.getElementById('compareHint').style.display = 'none';
        document.getElementById('compareResult').style.display = 'block';
        document.getElementById('elevA').textContent = ptA.e + 'm';
        document.getElementById('elevB').textContent = ptB.e + 'm';
        const d = ptB.e - ptA.e;
        let arr, col, vd;
        if (d > 10) { arr = 'ğŸ“ˆ'; col = '#C62828'; vd = Math.abs(d) > 30 ? 'ì˜¤ë¥´ë§‰ ì‹¬í•¨! ğŸš« ë‹¤ë¥¸ ê¸¸ ì¶”ì²œ' : 'ì•½ê°„ ì˜¤ë¥´ë§‰ â€” í˜ë“¤ ìˆ˜ ìˆìŒ'; }
        else if (d < -10) { arr = 'ğŸ“‰'; col = '#2E7D32'; vd = 'ë‚´ë¦¬ë§‰! í¸í•˜ê²Œ ê°ˆ ìˆ˜ ìˆì–´ìš” ğŸ‰'; }
        else { arr = 'â¡ï¸'; col = '#2E7D32'; vd = 'ê±°ì˜ í‰ì§€! ìì „ê±° OK ğŸš´'; }
        document.getElementById('diffArrow').textContent = arr;
        document.getElementById('diffText').style.color = col;
        document.getElementById('diffText').textContent = `${d > 0 ? '+' : ''}${d}m`;
        document.getElementById('diffVerdict').textContent = vd;
        cmpState = 2;
      } else {
        document.getElementById('compareHint').textContent = 'âš ï¸ ì‹¤íŒ¨, ë‹¤ì‹œ íƒ­';
        document.getElementById('compareHint').style.display = 'block';
      }
    }
    else if (cmpState === 2) { resetCmp(); }
  }
});
</script>
</body>
</html>
