<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ê°•ë‚¨ ìì „ê±° ê³ ë„ ì§€ë„ ğŸš´</title>
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" />
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Apple SD Gothic Neo','Noto Sans KR',sans-serif}
#map{width:100%;height:100vh}

.top-bar{
  position:absolute;top:0;left:0;right:0;z-index:10;
  background:#fff;padding:10px 14px;
  display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid #e8e8e8;box-shadow:0 1px 4px rgba(0,0,0,0.06);
}
.top-bar h1{font-size:15px;font-weight:700;color:#333}
.top-bar h1 span{font-weight:400;color:#999;font-size:12px}
/* (compare/bottom-sheet CSS removed) */

.ctrl-panel{
  position:absolute;top:52px;left:10px;z-index:10;
  background:#fff;border-radius:10px;padding:8px 12px;
  box-shadow:0 1px 6px rgba(0,0,0,0.1);font-size:11px;color:#666;
  display:none;
}
.ctrl-panel.show{display:block}
.ctrl-panel label{display:flex;align-items:center;gap:6px;margin-bottom:3px;cursor:pointer}
.ctrl-panel input[type="range"]{width:100px}
.ctrl-panel hr{border:none;border-top:1px solid #eee;margin:5px 0}

.legend-bar{
  display:none;
  position:absolute;top:52px;right:10px;z-index:9;
  background:#fff;border-radius:8px;padding:6px 8px;
  box-shadow:0 1px 4px rgba(0,0,0,0.1);font-size:10px;color:#888;
}
.legend-bar.show{display:block}
.legend-bar h4{font-size:11px;color:#555;margin-bottom:3px}
.lg-row{display:flex;align-items:center;margin-bottom:1px}
.lg-c{width:14px;height:8px;border-radius:2px;margin-right:4px}

/* ===== FPS Mode ===== */
.fps-overlay{
  display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:100;
  pointer-events:none;
}
.fps-overlay.active{display:block}
.fps-hud{width:100%;height:100%;position:relative}

.fps-crosshair{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  font-size:28px;color:rgba(255,255,255,0.6);
  text-shadow:0 0 4px rgba(0,0,0,0.8);pointer-events:none;
  font-family:monospace;
}

.fps-controls{
  position:absolute;top:10px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,0.7);backdrop-filter:blur(6px);
  color:#fff;border-radius:10px;padding:10px 16px;
  text-align:center;font-size:11px;pointer-events:none;
  transition:opacity 1s;
}
.fps-keys{display:flex;flex-direction:column;align-items:center;gap:4px;margin-bottom:6px}
.fps-key-row{display:flex;gap:4px}
.fps-key-row kbd{
  background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);
  border-radius:4px;padding:2px 8px;font-size:12px;font-family:monospace;
}
.fps-info{display:flex;flex-direction:column;gap:2px;opacity:0.7}

.fps-coords{
  position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,0.65);color:#4CAF50;
  font-family:monospace;font-size:12px;font-weight:700;
  border-radius:6px;padding:4px 12px;pointer-events:none;
}

.fps-exit{
  position:absolute;top:10px;right:10px;
  background:rgba(0,0,0,0.7);color:#fff;border:1px solid rgba(255,255,255,0.2);
  border-radius:8px;padding:8px 16px;font-size:13px;font-weight:600;
  cursor:pointer;pointer-events:auto;
  transition:background .2s;
}
.fps-exit:hover{background:rgba(244,67,54,0.8)}

/* Mobile D-pad */
.fps-mobile-pad{
  display:none;
  position:absolute;bottom:30px;left:24px;
  width:130px;height:130px;pointer-events:auto;
}
@media(max-width:768px){
  .fps-mobile-pad{display:block}
  .fps-controls .fps-keys{display:none}
}
.pad-btn{
  position:absolute;width:42px;height:42px;border-radius:50%;
  background:rgba(255,255,255,0.15);border:1.5px solid rgba(255,255,255,0.3);
  color:#fff;font-size:16px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;-webkit-tap-highlight-color:transparent;
  user-select:none;
}
.pad-btn:active{background:rgba(255,255,255,0.35)}
.pad-up{top:0;left:50%;transform:translateX(-50%)}
.pad-down{bottom:0;left:50%;transform:translateX(-50%)}
.pad-left{top:50%;left:0;transform:translateY(-50%)}
.pad-right{top:50%;right:0;transform:translateY(-50%)}

/* Floating station markers */
.floating-station{
  display:flex;flex-direction:column;align-items:center;pointer-events:none;
}
.stn-pole{
  width:2px;height:35px;
  background:linear-gradient(to bottom, rgba(0,0,0,0.4), rgba(0,0,0,0.1));
}
.stn-tag{
  background:rgba(255,255,255,0.88);
  backdrop-filter:blur(4px);
  border:2px solid;border-radius:6px;
  padding:2px 8px;font-size:12px;font-weight:700;
  white-space:nowrap;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
  pointer-events:auto;
}

.fab-col{
  position:absolute;right:10px;z-index:10;
  display:flex;flex-direction:column;gap:8px;
}
.fab-col.bot{bottom:130px}
@media(max-width:600px){.fab-col.bot{bottom:100px}}
.fab{
  width:44px;height:44px;border-radius:50%;border:none;
  background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.2);
  font-size:20px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:transform .15s;-webkit-tap-highlight-color:transparent;
}
.fab:active{transform:scale(0.9)}
.fab-locate{width:48px;height:48px;font-size:22px;background:#4285F4;color:#fff;box-shadow:0 2px 10px rgba(66,133,244,0.4)}

.pitch-hint{
  position:absolute;bottom:130px;left:50%;transform:translateX(-50%);z-index:10;
  background:rgba(0,0,0,0.7);color:#fff;border-radius:20px;
  padding:6px 14px;font-size:12px;pointer-events:none;
  opacity:0;transition:opacity .5s;
}
.pitch-hint.show{opacity:1}
</style>
</head>
<body>

<div id="map"></div>

<div class="top-bar">
  <h1>ğŸš´ ê°•ë‚¨ ì˜¤ë¥´ë§‰ ì§€ë„ <span>ì–¸ë• í”¼í•´ì„œ íƒ€ì</span></h1>
</div>

<div class="ctrl-panel" id="layerPanel">
  <strong style="color:#333">ë ˆì´ì–´</strong>
  <hr>
  <label>ë“±ê³ ì„  ì§„í•˜ê¸°</label>
  <input type="range" id="contourOpacity" min="0" max="100" value="75">
  <hr>
  <label><input type="checkbox" id="chk3d" checked> ğŸ”ï¸ 3D ì§€í˜•</label>
  <label><input type="checkbox" id="chkContour" checked> ã€°ï¸ ë“±ê³ ì„ </label>
  <label><input type="checkbox" id="chkStation" checked> ğŸš‡ ì—­</label>
  <label><input type="checkbox" id="chkRoute" checked> ğŸŸ¢ ì¶”ì²œê²½ë¡œ</label>
  <label><input type="checkbox" id="chkSlope" checked> ğŸ”º ì˜¤ë¥´ë§‰ ë°©í–¥</label>
</div>

<div class="legend-bar" id="legendBar">
  <h4>ğŸš´ ì§€ë„ ë²”ë¡€</h4>
  <div class="lg-row"><div class="lg-c" style="background:#4CAF50"></div>í‰ì§€ ìì „ê±°ê¸¸</div>
  <div class="lg-row"><div class="lg-c" style="background:#FF9800"></div>ì˜¤ë¥´ë§‰ ì£¼ì˜ êµ¬ê°„</div>
  <div class="lg-row"><div class="lg-c" style="background:#f44336"></div>ê¸‰ê²½ì‚¬ íšŒí”¼ êµ¬ê°„</div>
  <div class="lg-row" style="margin-top:3px;border-top:1px solid #eee;padding-top:3px">
    <span style="margin-right:4px;color:#388E3C">â€º</span> ì™„ë§Œí•œ ì˜¤ë¥´ë§‰
  </div>
  <div class="lg-row">
    <span style="margin-right:4px;color:#E65100">â€ºâ€º</span> ì¤‘ê°„ ì˜¤ë¥´ë§‰
  </div>
  <div class="lg-row">
    <span style="margin-right:4px;color:#C62828">â€ºâ€ºâ€º</span> ê¸‰ê²½ì‚¬ ì˜¤ë¥´ë§‰
  </div>
  <div class="lg-row"><span style="font-size:9px;margin-right:4px">ã€°ï¸</span> ë“±ê³ ì„ </div>
  <div class="lg-row" style="margin-top:3px;border-top:1px solid #eee;padding-top:3px;color:#666">
    ğŸ¤ ë‘ ì†ê°€ë½ íšŒì „/ê¸°ìš¸ì´ê¸°
  </div>
</div>

<div class="fab-col bot">
  <button class="fab" id="btnLegend" title="ë²”ë¡€">ğŸ“‹</button>
  <button class="fab" id="btnLayers" title="ë ˆì´ì–´">ğŸ—ºï¸</button>
  <button class="fab fab-locate" id="btnLocate" title="ë‚´ ìœ„ì¹˜">ğŸ“</button>
  <button class="fab" id="btnReset" title="ì „ì²´ë³´ê¸°">â†º</button>
  <button class="fab" id="btn3dToggle" title="3D/2D ì „í™˜">ğŸ”ï¸</button>
  <button class="fab" id="btnFps" title="1ì¸ì¹­ ëª¨ë“œ" style="background:#222;color:#4CAF50;font-size:14px;font-weight:800">FPS</button>
  <button class="fab" id="btnMinecraft" title="ë§ˆì¸í¬ë˜í”„íŠ¸ ëª¨ë“œ" style="background:#5D8A3C;color:#fff;font-size:13px;font-weight:800">MC</button>
</div>

<div class="pitch-hint" id="pitchHint">ğŸ¤ ë‘ ì†ê°€ë½ìœ¼ë¡œ íšŒì „ & ê¸°ìš¸ì´ê¸°</div>

<!-- FPS mode overlay -->
<div class="fps-overlay" id="fpsOverlay">
  <div class="fps-hud">
    <div class="fps-crosshair">+</div>
    <div class="fps-controls" id="fpsControls">
      <div class="fps-keys">
        <div class="fps-key-row"><kbd>W</kbd></div>
        <div class="fps-key-row"><kbd>A</kbd><kbd>S</kbd><kbd>D</kbd></div>
      </div>
      <div class="fps-info">
        <span>ì´ë™: WASD</span>
        <span>ì‹œì : ë§ˆìš°ìŠ¤/ë“œë˜ê·¸</span>
        <span>ë†’ì´: Q/E</span>
        <span>ì†ë„: Shift=ë¹ ë¥´ê²Œ</span>
      </div>
    </div>
    <div class="fps-coords" id="fpsCoords"></div>
    <div class="fps-mobile-pad" id="fpsPad">
      <button class="pad-btn pad-up" data-dir="forward">â–²</button>
      <button class="pad-btn pad-left" data-dir="left">â—€</button>
      <button class="pad-btn pad-right" data-dir="right">â–¶</button>
      <button class="pad-btn pad-down" data-dir="backward">â–¼</button>
    </div>
    <button class="fps-exit" id="fpsExit">âœ• ë‚˜ê°€ê¸°</button>
  </div>
</div>

<!-- Minecraft mode -->
<div id="mcOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:200;background:#87CEEB">
  <canvas id="mcCanvas" style="width:100%;height:100%;display:block"></canvas>
  <div style="position:absolute;top:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.6);color:#fff;border-radius:8px;padding:8px 16px;font-size:12px;text-align:center;pointer-events:none" id="mcHelp">
    <b>ğŸ® ê°•ë‚¨êµ¬ ë§ˆì¸í¬ë˜í”„íŠ¸</b><br>
    WASD ì´ë™ Â· ë§ˆìš°ìŠ¤ ì‹œì  Â· Space ì í”„ Â· Q/E ë†’ì´<br>
    ëª¨ë°”ì¼: ë“œë˜ê·¸=ì‹œì , í•˜ë‹¨ íŒ¨ë“œ=ì´ë™
  </div>
  <div style="position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.5);color:#4CAF50;font-family:monospace;font-size:11px;border-radius:4px;padding:3px 10px;pointer-events:none" id="mcCoords"></div>
  <button onclick="exitMc()" style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.6);color:#fff;border:1px solid rgba(255,255,255,0.2);border-radius:8px;padding:8px 16px;font-size:13px;cursor:pointer">âœ• ë‚˜ê°€ê¸°</button>
  <!-- Mobile D-pad -->
  <div id="mcPad" style="display:none;position:absolute;bottom:30px;left:24px;width:130px;height:130px">
    <button class="mc-pad" data-d="w" style="position:absolute;top:0;left:50%;transform:translateX(-50%)">â–²</button>
    <button class="mc-pad" data-d="a" style="position:absolute;top:50%;left:0;transform:translateY(-50%)">â—€</button>
    <button class="mc-pad" data-d="d" style="position:absolute;top:50%;right:0;transform:translateY(-50%)">â–¶</button>
    <button class="mc-pad" data-d="s" style="position:absolute;bottom:0;left:50%;transform:translateX(-50%)">â–¼</button>
  </div>
</div>
<style>
.mc-pad{
  width:42px;height:42px;border-radius:50%;
  background:rgba(255,255,255,0.15);border:1.5px solid rgba(255,255,255,0.3);
  color:#fff;font-size:16px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;-webkit-tap-highlight-color:transparent;
}
.mc-pad:active{background:rgba(255,255,255,0.35)}
</style>

<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/maplibre-contour@0.0.7/dist/index.min.js"></script>
<script>
const DEFAULT_LOC = [127.0448, 37.5104]; // ì„ ì •ë¦‰ì—­ [lng, lat]
const GANGNAM_CENTER = [127.047, 37.497];

// ===== Map (base only â€” contours added after load) =====
const map = new maplibregl.Map({
  container: 'map',
  style: {
    version: 8,
    sources: {
      'carto': {
        type: 'raster',
        tiles: ['https://a.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}@2x.png'],
        tileSize: 256,
        attribution: 'Â© CARTO Â· Â© OSM'
      },
      'hillshade-tiles': {
        type: 'raster',
        tiles: ['https://tiles.wmflabs.org/hillshading/{z}/{x}/{y}.png'],
        tileSize: 256
      },
      'terrain-dem': {
        type: 'raster-dem',
        tiles: ['https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png'],
        tileSize: 256,
        encoding: 'terrarium'
      }
    },
    layers: [
      { id: 'base', type: 'raster', source: 'carto' },
      { id: 'hill-overlay', type: 'raster', source: 'hillshade-tiles', paint: { 'raster-opacity': 0.5 } }
    ],
    terrain: { source: 'terrain-dem', exaggeration: 4.0 }
  },
  center: DEFAULT_LOC,
  zoom: 14,
  pitch: 40,
  bearing: 0,
  maxPitch: 70,
  touchPitch: true,
  dragRotate: true,
  touchZoomRotate: true
});

// Nav controls
map.addControl(new maplibregl.NavigationControl({ showCompass: true, showZoom: true }), 'bottom-left');

// Show pitch hint on first load
setTimeout(() => {
  const h = document.getElementById('pitchHint');
  h.classList.add('show');
  setTimeout(() => h.classList.remove('show'), 4000);
}, 2000);

// ===== GeoJSON sources for overlays =====
map.on('load', () => {
  // --- Contour lines from DEM ---
  try {
    const demSource = new mlcontour.DemSource({
      url: 'https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png',
      encoding: 'terrarium',
      maxzoom: 13,
      worker: true
    });
    demSource.setupMaplibre(maplibregl);

    map.addSource('contour-source', {
      type: 'vector',
      tiles: [demSource.contourProtocolUrl({
        multiplier: 1,
        overzoom: 1,
        thresholds: { 11: [50], 12: [20,100], 13: [10,50], 14: [10,50], 15: [5,20] },
        elevationKey: 'ele',
        levelKey: 'level',
        contourLayer: 'contours'
      })],
      maxzoom: 15
    });

    // Minor contour lines
    map.addLayer({
      id: 'contour-lines', type: 'line', source: 'contour-source', 'source-layer': 'contours',
      filter: ['==', ['get','level'], 0],
      paint: { 'line-color': 'rgba(56, 142, 60, 0.5)', 'line-width': 1.2 }
    });
    // Major contour lines
    map.addLayer({
      id: 'contour-lines-major', type: 'line', source: 'contour-source', 'source-layer': 'contours',
      filter: ['==', ['get','level'], 1],
      paint: { 'line-color': 'rgba(46, 125, 50, 0.8)', 'line-width': 2.5 }
    });
    // Labels on major lines
    map.addLayer({
      id: 'contour-labels', type: 'symbol', source: 'contour-source', 'source-layer': 'contours',
      filter: ['==', ['get','level'], 1],
      layout: {
        'symbol-placement': 'line', 'text-field': ['concat', ['get','ele'], 'm'],
        'text-size': 11, 'text-font': ['Open Sans Bold','Arial Unicode MS Bold'],
        'text-max-angle': 25, 'text-padding': 40
      },
      paint: { 'text-color': 'rgba(46,125,50,0.9)', 'text-halo-color': 'rgba(255,255,255,0.85)', 'text-halo-width': 1.5 }
    });
  } catch(err) {
    console.warn('Contour init failed:', err);
  }

  // --- Flat routes ---
  const flatRoutes = [
    { name: 'íƒ„ì²œ ìì „ê±°ê¸¸', coords: [[127.0946,37.5145],[127.0920,37.5100],[127.0870,37.5040],[127.0810,37.4970],[127.0770,37.4910],[127.0730,37.4850],[127.0680,37.4780],[127.0640,37.4720],[127.0610,37.4665]] },
    { name: 'ì–‘ì¬ì²œ ìì „ê±°ê¸¸', coords: [[127.0352,37.4842],[127.0420,37.4835],[127.0490,37.4830],[127.0560,37.4828],[127.0630,37.4825],[127.0700,37.4822],[127.0750,37.4820]] },
    { name: 'í•œê°• ìì „ê±°ê¸¸', coords: [[127.0100,37.5240],[127.0200,37.5250],[127.0300,37.5260],[127.0400,37.5270],[127.0500,37.5265],[127.0600,37.5260],[127.0700,37.5255],[127.0800,37.5250],[127.0900,37.5245],[127.1000,37.5240]] },
    { name: 'í…Œí—¤ë€ë¡œ', coords: [[127.0276,37.4979],[127.0330,37.4990],[127.0366,37.5007],[127.0420,37.5025],[127.0490,37.5045],[127.0560,37.5065],[127.0639,37.5088]] },
  ];
  const routeFeatures = flatRoutes.map(r => ({
    type: 'Feature', properties: { name: r.name },
    geometry: { type: 'LineString', coordinates: r.coords }
  }));

  map.addSource('flat-routes', { type: 'geojson', data: { type: 'FeatureCollection', features: routeFeatures } });
  map.addLayer({ id: 'flat-routes-line', type: 'line', source: 'flat-routes',
    paint: { 'line-color': '#4CAF50', 'line-width': 5, 'line-opacity': 0.7 },
    layout: { 'line-cap': 'round', 'line-join': 'round' }
  });
  map.addLayer({ id: 'flat-routes-label', type: 'symbol', source: 'flat-routes',
    layout: { 'symbol-placement': 'line-center', 'text-field': ['concat', 'ğŸŸ¢ ', ['get', 'name']],
      'text-size': 11, 'text-font': ['Open Sans Bold','Arial Unicode MS Bold'],
      'text-allow-overlap': true
    },
    paint: { 'text-color': '#1B5E20', 'text-halo-color': '#fff', 'text-halo-width': 2 }
  });

  // --- Caution zones ---
  const cautionZones = [
    { name: 'ëŒ€ëª¨ì‚°Â·êµ¬ë£¡ì‚°', center: [127.073,37.476], radius: 600, steep: true },
    { name: 'ë§¤ë´‰ì‚°', center: [127.040,37.489], radius: 350, steep: false },
    { name: 'ìš°ë©´ì‚°', center: [127.010,37.478], radius: 450, steep: true },
    { name: 'ì„¸ê³¡ë™ êµ¬ë¦‰', center: [127.070,37.468], radius: 400, steep: false },
  ];
  // Approximate circles as polygons
  function makeCircle(c, r, n=32) {
    const coords = [];
    for (let i=0;i<=n;i++) {
      const a = (i/n)*2*Math.PI;
      const dlat = (r/111320)*Math.cos(a);
      const dlng = (r/(111320*Math.cos(c[1]*Math.PI/180)))*Math.sin(a);
      coords.push([c[0]+dlng, c[1]+dlat]);
    }
    return coords;
  }
  const cautionFeatures = cautionZones.map(z => ({
    type: 'Feature',
    properties: { name: z.name, steep: z.steep },
    geometry: { type: 'Polygon', coordinates: [makeCircle(z.center, z.radius)] }
  }));
  map.addSource('caution-zones', { type: 'geojson', data: { type: 'FeatureCollection', features: cautionFeatures } });
  map.addLayer({ id: 'caution-fill', type: 'fill', source: 'caution-zones',
    paint: { 'fill-color': ['case', ['get','steep'], '#f44336', '#FF9800'], 'fill-opacity': 0.12 }
  });
  map.addLayer({ id: 'caution-border', type: 'line', source: 'caution-zones',
    paint: { 'line-color': ['case', ['get','steep'], '#f44336', '#FF9800'], 'line-width': 2, 'line-dasharray': [4,3] }
  });
  map.addLayer({ id: 'caution-label', type: 'symbol', source: 'caution-zones',
    layout: { 'text-field': ['concat', ['case',['get','steep'],'ğŸ”´','ğŸŸ '], ' ', ['get','name']],
      'text-size': 11, 'text-font': ['Open Sans Bold','Arial Unicode MS Bold']
    },
    paint: { 'text-color': ['case',['get','steep'],'#C62828','#E65100'], 'text-halo-color': '#fff', 'text-halo-width': 2 }
  });

  // --- Stations ---
  const stations = [
    {n:'ê°•ë‚¨',la:37.4979,lo:127.0276,c:'#1a6b24',l:'2'},
    {n:'ì—­ì‚¼',la:37.5007,lo:127.0366,c:'#1a6b24',l:'2'},
    {n:'ì„ ë¦‰',la:37.5045,lo:127.0490,c:'#1a6b24',l:'2'},
    {n:'ì‚¼ì„±',la:37.5088,lo:127.0639,c:'#1a6b24',l:'2'},
    {n:'ì¢…í•©ìš´ë™ì¥',la:37.5107,lo:127.0736,c:'#1a6b24',l:'2'},
    {n:'êµëŒ€',la:37.4934,lo:127.0146,c:'#1a6b24',l:'2'},
    {n:'ì••êµ¬ì •',la:37.5270,lo:127.0286,c:'#c43d08',l:'3'},
    {n:'ì‹ ì‚¬',la:37.5164,lo:127.0203,c:'#c43d08',l:'3'},
    {n:'ë§¤ë´‰',la:37.4874,lo:127.0347,c:'#c43d08',l:'3'},
    {n:'ë„ê³¡',la:37.4915,lo:127.0455,c:'#c43d08',l:'3'},
    {n:'ëŒ€ì¹˜',la:37.4948,lo:127.0577,c:'#c43d08',l:'3'},
    {n:'í•™ì—¬ìš¸',la:37.4965,lo:127.0648,c:'#c43d08',l:'3'},
    {n:'ëŒ€ì²­',la:37.4920,lo:127.0744,c:'#c43d08',l:'3'},
    {n:'ì¼ì›',la:37.4836,lo:127.0867,c:'#c43d08',l:'3'},
    {n:'ìˆ˜ì„œ',la:37.4872,lo:127.1017,c:'#c43d08',l:'3'},
    {n:'ê°•ë‚¨êµ¬ì²­',la:37.5173,lo:127.0413,c:'#3d5516',l:'7'},
    {n:'ì²­ë‹´',la:37.5196,lo:127.0539,c:'#3d5516',l:'7'},
    {n:'ë…¼í˜„',la:37.5113,lo:127.0215,c:'#3d5516',l:'7'},
    {n:'í•™ë™',la:37.5146,lo:127.0319,c:'#3d5516',l:'7'},
    {n:'ë´‰ì€ì‚¬',la:37.5140,lo:127.0580,c:'#6b5c38',l:'9'},
    {n:'ì–¸ì£¼',la:37.5072,lo:127.0340,c:'#6b5c38',l:'9'},
    {n:'ì‹ ë…¼í˜„',la:37.5045,lo:127.0253,c:'#6b5c38',l:'9'},
    {n:'ì„ ì •ë¦‰',la:37.5104,lo:127.0448,c:'#6b5c38',l:'9'},
    {n:'ì–‘ì¬',la:37.4842,lo:127.0352,c:'#a01528',l:'ì‹ ë¶„ë‹¹'},
    {n:'í•œí‹°',la:37.4984,lo:127.0561,c:'#9a7510',l:'ë¶„ë‹¹'},
    {n:'êµ¬ë£¡',la:37.4847,lo:127.0538,c:'#9a7510',l:'ë¶„ë‹¹'},
    {n:'ê°œí¬ë™',la:37.4787,lo:127.0549,c:'#9a7510',l:'ë¶„ë‹¹'},
    {n:'ëŒ€ëª¨ì‚°ì…êµ¬',la:37.4765,lo:127.0772,c:'#9a7510',l:'ë¶„ë‹¹'},
  ];
  const stnFeatures = stations.map(s => ({
    type: 'Feature',
    properties: { name: s.n, color: s.c, line: s.l },
    geometry: { type: 'Point', coordinates: [s.lo, s.la] }
  }));
  map.addSource('stations', { type: 'geojson', data: { type: 'FeatureCollection', features: stnFeatures } });
  // Station labels as floating HTML markers (above terrain)
  const stnMarkers = [];
  stations.forEach(s => {
    const el = document.createElement('div');
    el.className = 'floating-station';
    el.innerHTML = `<div class="stn-pole"></div><div class="stn-tag" style="color:${s.c};border-color:${s.c}">${s.n}</div>`;
    const marker = new maplibregl.Marker({ element: el, anchor: 'bottom' })
      .setLngLat([s.lo, s.la])
      .addTo(map);
    stnMarkers.push(marker);
  });
  // Save for toggle
  window._stnMarkers = stnMarkers;

  // --- Slope arrows ---
  const slopes = [
    {la:37.4790,lo:127.0780,dir:'â†—',label:'+80m',steep:true},
    {la:37.4760,lo:127.0850,dir:'â†’',label:'+60m',steep:true},
    {la:37.4810,lo:127.0870,dir:'â†˜',label:'+50m',steep:true},
    {la:37.4820,lo:127.0580,dir:'â†“',label:'+70m',steep:true},
    {la:37.4760,lo:127.0650,dir:'â†—',label:'+90m',steep:true},
    {la:37.4880,lo:127.0400,dir:'â†‘',label:'+30m',steep:false},
    {la:37.4930,lo:127.0420,dir:'â†—',label:'+25m',steep:false},
    {la:37.4890,lo:127.0480,dir:'â†',label:'+20m',steep:false},
    {la:37.4810,lo:127.0120,dir:'â†‘',label:'+60m',steep:true},
    {la:37.4750,lo:127.0050,dir:'â†—',label:'+80m',steep:true},
    {la:37.4700,lo:127.0660,dir:'â†“',label:'+35m',steep:false},
    {la:37.4660,lo:127.0730,dir:'â†—',label:'+40m',steep:false},
    {la:37.4850,lo:127.0920,dir:'â†',label:'+25m',steep:false},
    {la:37.4800,lo:127.0560,dir:'â†“',label:'+45m',steep:false},
  ];
  const slopeFeatures = slopes.map(s => ({
    type: 'Feature',
    properties: { dir: s.dir, label: s.label, steep: s.steep },
    geometry: { type: 'Point', coordinates: [s.lo, s.la] }
  }));
  map.addSource('slopes', { type: 'geojson', data: { type: 'FeatureCollection', features: slopeFeatures } });
  map.addLayer({ id: 'slope-arrow', type: 'symbol', source: 'slopes',
    layout: {
      'text-field': ['concat', ['get','dir'], ' ', ['get','label']],
      'text-size': 14, 'text-font': ['Open Sans Bold','Arial Unicode MS Bold'],
      'text-allow-overlap': true
    },
    paint: {
      'text-color': ['case', ['get','steep'], '#C62828', '#E65100'],
      'text-halo-color': '#fff', 'text-halo-width': 2
    }
  });

  // --- Road slope arrows (arrows point UPHILL, count = steepness) ---
  const roadSlopes = [
    // ê°•ë‚¨ëŒ€ë¡œ (ë‚¨ìª½ìœ¼ë¡œ ì˜¬ë¼ê° - ê°•ë‚¨ì—­â†’ì–‘ì¬)
    { name:'ê°•ë‚¨ëŒ€ë¡œ', grade:1, pts:[[127.0276,37.4979],[127.0290,37.4950],[127.0310,37.4920],[127.0330,37.4890],[127.0352,37.4842]] },
    // ê°œí¬ë¡œ (ë‚¨ìª½ìœ¼ë¡œ ì˜¬ë¼ê° - ê°œí¬ë™â†’êµ¬ë£¡ì‚°)
    { name:'ê°œí¬ë¡œ', grade:3, pts:[[127.0549,37.4787],[127.0560,37.4760],[127.0575,37.4740],[127.0600,37.4720]] },
    // í—Œë¦‰ë¡œ (ë™ìª½ìœ¼ë¡œ ì˜¬ë¼ê° - ìˆ˜ì„œì—­â†’ëŒ€ëª¨ì‚°)
    { name:'í—Œë¦‰ë¡œ', grade:3, pts:[[127.1017,37.4872],[127.0950,37.4830],[127.0880,37.4800],[127.0830,37.4770]] },
    // ì¼ì›ë¡œ (ë‚¨ìª½ìœ¼ë¡œ ì˜¬ë¼ê°)
    { name:'ì¼ì›ë¡œ', grade:2, pts:[[127.0867,37.4836],[127.0850,37.4810],[127.0840,37.4790]] },
    // ë‚¨ë¶€ìˆœí™˜ë¡œ ë™ìª½ (ëŒ€ëª¨ì‚°ì…êµ¬ ë°©í–¥ ì˜¬ë¼ê°)
    { name:'ë‚¨ë¶€ìˆœí™˜ë¡œ(ë™)', grade:2, pts:[[127.0650,37.4830],[127.0700,37.4820],[127.0750,37.4810],[127.0772,37.4800]] },
    // ë„ê³¡ë¡œ (ë§¤ë´‰ì‚° ë°©í–¥ ì˜¬ë¼ê°)
    { name:'ë„ê³¡ë¡œ', grade:2, pts:[[127.0455,37.4915],[127.0430,37.4900],[127.0410,37.4890],[127.0390,37.4880]] },
    // ì–¸ì£¼ë¡œ (ë‚¨ìª½ ì˜¬ë¼ê° - ì—­ì‚¼â†’ë§¤ë´‰)
    { name:'ì–¸ì£¼ë¡œ', grade:1, pts:[[127.0340,37.5072],[127.0345,37.5030],[127.0347,37.4990],[127.0347,37.4950],[127.0347,37.4910],[127.0347,37.4874]] },
    // ì„ ë¦‰ë¡œ (ë‚¨ìª½ ì•½ê°„ ì˜¬ë¼ê°)
    { name:'ì„ ë¦‰ë¡œ', grade:1, pts:[[127.0490,37.5045],[127.0480,37.5010],[127.0470,37.4970],[127.0455,37.4940]] },
    // ì‚¼ì„±ë¡œ (ë‚¨ìª½ ì˜¬ë¼ê° - ì‚¼ì„±ì—­â†’ëŒ€ì¹˜)
    { name:'ì‚¼ì„±ë¡œ', grade:1, pts:[[127.0639,37.5088],[127.0620,37.5050],[127.0600,37.5010],[127.0577,37.4948]] },
    // ì–‘ì¬ëŒ€ë¡œ (ë™ìª½ìœ¼ë¡œ ì˜¬ë¼ê° - ì–‘ì¬â†’ì„¸ê³¡)
    { name:'ì–‘ì¬ëŒ€ë¡œ', grade:2, pts:[[127.0352,37.4842],[127.0450,37.4835],[127.0550,37.4830],[127.0650,37.4825],[127.0720,37.4820]] },
    // ì„¸ê³¡ë™ê¸¸ (ë‚¨ìª½ ì˜¬ë¼ê°)
    { name:'ì„¸ê³¡ë™ê¸¸', grade:2, pts:[[127.0700,37.4750],[127.0690,37.4720],[127.0680,37.4690],[127.0670,37.4660]] },
    // ëŒ€ëª¨ì‚°ê¸¸ (ë™ë‚¨ìª½ ì˜¬ë¼ê° - ëŒ€ëª¨ì‚°ì…êµ¬ì—­â†’ëŒ€ëª¨ì‚°)
    { name:'ëŒ€ëª¨ì‚°ê¸¸', grade:3, pts:[[127.0772,37.4765],[127.0790,37.4750],[127.0810,37.4740],[127.0830,37.4730]] },
    // êµ¬ë£¡ì‚°ê¸¸ (ë‚¨ìª½ ì˜¬ë¼ê°)
    { name:'êµ¬ë£¡ì‚°ê¸¸', grade:3, pts:[[127.0538,37.4847],[127.0560,37.4830],[127.0580,37.4810],[127.0600,37.4795],[127.0620,37.4785]] },
    // ì˜ë™ëŒ€ë¡œ (ê±°ì˜ í‰ì§€ - í‘œì‹œ ì•ˆí•¨)
    // í…Œí—¤ë€ë¡œ (ê±°ì˜ í‰ì§€ - í‘œì‹œ ì•ˆí•¨)
    // ë´‰ì€ì‚¬ë¡œ ë‚¨ìª½ìœ¼ë¡œ ì•½ê°„
    { name:'ë´‰ì€ì‚¬ë¡œ', grade:1, pts:[[127.0580,37.5140],[127.0550,37.5120],[127.0520,37.5100],[127.0490,37.5080]] },
    // ë…¼í˜„ë¡œ (ë‚¨ìª½ ì˜¬ë¼ê°)
    { name:'ë…¼í˜„ë¡œ', grade:1, pts:[[127.0215,37.5113],[127.0220,37.5080],[127.0230,37.5050],[127.0240,37.5020]] },
    // ìš°ë©´ì‚° ì ‘ê·¼ (ê¸‰ê²½ì‚¬)
    { name:'ìš°ë©´ì‚°ë¡œ', grade:3, pts:[[127.0146,37.4934],[127.0130,37.4900],[127.0110,37.4860],[127.0090,37.4820],[127.0080,37.4780]] },
  ];

  // Arrow symbol: more chevrons = steeper
  const gradeArrows = { 1: 'â€º', 2: 'â€ºâ€º', 3: 'â€ºâ€ºâ€º' };
  const gradeColors = { 1: '#4CAF50', 2: '#FF9800', 3: '#f44336' };
  const gradeWidths = { 1: 3, 2: 4, 3: 5 };

  const roadFeatures = roadSlopes.map(r => ({
    type: 'Feature',
    properties: { name: r.name, grade: r.grade, arrows: gradeArrows[r.grade], color: gradeColors[r.grade] },
    geometry: { type: 'LineString', coordinates: r.pts }
  }));

  map.addSource('road-slopes', { type: 'geojson', data: { type: 'FeatureCollection', features: roadFeatures } });

  // Road slope line (subtle colored underline)
  map.addLayer({
    id: 'road-slope-line', type: 'line', source: 'road-slopes',
    paint: {
      'line-color': ['match', ['get','grade'], 1,'rgba(76,175,80,0.3)', 2,'rgba(255,152,0,0.3)', 'rgba(244,67,54,0.3)'],
      'line-width': ['match', ['get','grade'], 1,6, 2,8, 10],
    },
    layout: { 'line-cap': 'round' }
  });

  // Arrows along road (pointing uphill)
  map.addLayer({
    id: 'road-slope-arrows', type: 'symbol', source: 'road-slopes',
    layout: {
      'symbol-placement': 'line',
      'text-field': ['get', 'arrows'],
      'text-size': ['match', ['get','grade'], 1,16, 2,20, 24],
      'text-font': ['Open Sans Bold','Arial Unicode MS Bold'],
      'text-keep-upright': false,
      'symbol-spacing': ['match', ['get','grade'], 1,80, 2,60, 45],
      'text-allow-overlap': true,
      'text-rotation-alignment': 'map',
      'text-pitch-alignment': 'map'
    },
    paint: {
      'text-color': ['match', ['get','grade'], 1,'#388E3C', 2,'#E65100', '#C62828'],
      'text-halo-color': 'rgba(255,255,255,0.85)',
      'text-halo-width': 1.5
    }
  });

  // Road name labels
  map.addLayer({
    id: 'road-slope-labels', type: 'symbol', source: 'road-slopes',
    layout: {
      'symbol-placement': 'line-center',
      'text-field': ['get', 'name'],
      'text-size': 10,
      'text-font': ['Open Sans Bold','Arial Unicode MS Bold'],
      'text-offset': [0, -1.2]
    },
    paint: {
      'text-color': ['match', ['get','grade'], 1,'#2E7D32', 2,'#E65100', '#C62828'],
      'text-halo-color': 'rgba(255,255,255,0.9)',
      'text-halo-width': 1.5
    }
  });

  // --- Local maximums (ì—°í•œ í•˜ì´ë¼ì´íŠ¸) ---
  const localMaxima = [
    // Major peaks
    { n:'ëŒ€ëª¨ì‚°', e:293, lo:127.0830, la:37.4730, r:350 },
    { n:'êµ¬ë£¡ì‚°', e:306, lo:127.0620, la:37.4785, r:300 },
    { n:'ë§¤ë´‰ì‚°', e:101, lo:127.0450, la:37.4910, r:200 },
    { n:'ìš°ë©´ì‚°', e:293, lo:127.0080, la:37.4780, r:300 },
    // Minor local highs
    { n:'', e:120, lo:127.0700, la:37.4680, r:150 }, // ì„¸ê³¡ë™ êµ¬ë¦‰
    { n:'', e:80, lo:127.0900, la:37.4830, r:120 },  // ì¼ì›ë™ êµ¬ë¦‰
    { n:'', e:65, lo:127.0560, la:37.4800, r:100 },  // ê°œí¬ë™ ì–¸ë•
    { n:'', e:55, lo:127.0380, la:37.4950, r:80 },   // ì—­ì‚¼ ì–¸ë•
    { n:'', e:90, lo:127.1010, la:37.4870, r:120 },  // ìˆ˜ì„œë™ ê³ ì§€ëŒ€
    { n:'', e:50, lo:127.0520, la:37.5080, r:80 },   // ë‹¬í„°ê³µì›
    { n:'', e:45, lo:127.0320, la:37.5140, r:70 },   // í•™ë™ ì–¸ë•
    { n:'', e:70, lo:127.0750, la:37.4760, r:100 },  // ëŒ€ëª¨ì‚°ì…êµ¬ ì£¼ë³€
    { n:'', e:55, lo:127.0480, la:37.4880, r:80 },   // ë„ê³¡ë™ ì–¸ë•
    { n:'', e:100, lo:127.0650, la:37.4720, r:130 }, // ì„¸ê³¡ë™ ë‚¨ìª½
    { n:'', e:40, lo:127.0250, la:37.5000, r:60 },   // ê°•ë‚¨ì—­ ì„œìª½ ë¯¸ì„¸ ì–¸ë•
  ];

  // Circles (glow effect)
  const maxCircles = localMaxima.map(m => ({
    type: 'Feature',
    properties: { name: m.n, elev: m.e, radius: m.r },
    geometry: { type: 'Point', coordinates: [m.lo, m.la] }
  }));
  map.addSource('local-max', { type: 'geojson', data: { type: 'FeatureCollection', features: maxCircles } });

  // Outer glow
  map.addLayer({
    id: 'local-max-glow', type: 'circle', source: 'local-max',
    paint: {
      'circle-radius': ['interpolate', ['linear'], ['zoom'], 12, ['/', ['get','radius'], 40], 15, ['/', ['get','radius'], 8]],
      'circle-color': [
        'interpolate', ['linear'], ['get','elev'],
        40, 'rgba(255, 236, 179, 0.2)',   // ë‚®ì€ ì–¸ë•: ì—°í•œ ë…¸ë‘
        100, 'rgba(255, 204, 128, 0.25)',  // ì¤‘ê°„: ì—°í•œ ì£¼í™©
        200, 'rgba(255, 171, 145, 0.3)'    // ë†’ì€ ì‚°: ì—°í•œ ë¹¨ê°•
      ],
      'circle-blur': 0.8
    }
  }, 'flat-routes-line');

  // Inner highlight
  map.addLayer({
    id: 'local-max-core', type: 'circle', source: 'local-max',
    paint: {
      'circle-radius': ['interpolate', ['linear'], ['zoom'], 12, 4, 15, 10],
      'circle-color': [
        'interpolate', ['linear'], ['get','elev'],
        40, 'rgba(255, 224, 130, 0.5)',
        100, 'rgba(255, 183, 77, 0.55)',
        200, 'rgba(255, 138, 101, 0.6)'
      ],
      'circle-stroke-color': [
        'interpolate', ['linear'], ['get','elev'],
        40, 'rgba(255, 193, 7, 0.4)',
        100, 'rgba(255, 152, 0, 0.45)',
        200, 'rgba(244, 67, 54, 0.5)'
      ],
      'circle-stroke-width': 1.5
    }
  }, 'flat-routes-line');

  // Elevation label on each local max
  map.addLayer({
    id: 'local-max-label', type: 'symbol', source: 'local-max',
    layout: {
      'text-field': ['concat', ['get','elev'], 'm'],
      'text-size': 10,
      'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
      'text-allow-overlap': false,
      'text-offset': [0, -0.8]
    },
    paint: {
      'text-color': [
        'interpolate', ['linear'], ['get','elev'],
        40, 'rgba(230, 170, 0, 0.7)',
        100, 'rgba(230, 120, 0, 0.8)',
        200, 'rgba(200, 60, 40, 0.85)'
      ],
      'text-halo-color': 'rgba(255,255,255,0.8)',
      'text-halo-width': 1.2
    }
  });

  // --- Peaks ---
  const peaks = [
    {n:'â›°ï¸ ëŒ€ëª¨ì‚° 293m',la:37.4730,lo:127.0830},
    {n:'â›°ï¸ êµ¬ë£¡ì‚° 306m',la:37.4785,lo:127.0620},
    {n:'â›°ï¸ ë§¤ë´‰ì‚° 101m',la:37.4910,lo:127.0450},
    {n:'â›°ï¸ ìš°ë©´ì‚° 293m',la:37.4780,lo:127.0080},
  ];
  map.addSource('peaks', { type: 'geojson', data: {
    type: 'FeatureCollection',
    features: peaks.map(p => ({ type:'Feature', properties:{name:p.n}, geometry:{type:'Point',coordinates:[p.lo,p.la]} }))
  }});
  map.addLayer({ id: 'peak-label', type: 'symbol', source: 'peaks',
    layout: { 'text-field': ['get','name'], 'text-size': 12, 'text-font': ['Open Sans Bold','Arial Unicode MS Bold'], 'text-allow-overlap': true },
    paint: { 'text-color': '#C62828', 'text-halo-color': '#fff', 'text-halo-width': 2 }
  });

  // --- Default location marker ---
  addLocMarker(DEFAULT_LOC);
});

// ===== Location marker =====
let locMarkerEl = null;
let locMarker = null;

function addLocMarker(lnglat) {
  if (locMarker) locMarker.remove();
  locMarkerEl = document.createElement('div');
  locMarkerEl.innerHTML = '<div style="width:18px;height:18px;background:#4285F4;border:3px solid #fff;border-radius:50%;box-shadow:0 0 0 0 rgba(66,133,244,0.5),0 1px 4px rgba(0,0,0,0.3);animation:pulse 2s infinite"></div>';
  locMarker = new maplibregl.Marker({ element: locMarkerEl }).setLngLat(lnglat).addTo(map);
}

// Inject pulse keyframes
const styleSheet = document.createElement('style');
styleSheet.textContent = '@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(66,133,244,0.5),0 1px 4px rgba(0,0,0,0.3)}70%{box-shadow:0 0 0 18px rgba(66,133,244,0),0 1px 4px rgba(0,0,0,0.3)}100%{box-shadow:0 0 0 0 rgba(66,133,244,0),0 1px 4px rgba(0,0,0,0.3)}}';
document.head.appendChild(styleSheet);

// ===== Controls =====
document.getElementById('btnLegend').addEventListener('click', () => {
  document.getElementById('legendBar').classList.toggle('show');
  document.getElementById('layerPanel').classList.remove('show');
});
document.getElementById('btnLayers').addEventListener('click', () => {
  document.getElementById('layerPanel').classList.toggle('show');
  document.getElementById('legendBar').classList.remove('show');
});
document.getElementById('btnReset').addEventListener('click', () => {
  map.flyTo({ center: GANGNAM_CENTER, zoom: 14, pitch: 40, bearing: 0, duration: 1000 });
});

let is3d = true;
document.getElementById('btn3dToggle').addEventListener('click', () => {
  is3d = !is3d;
  if (is3d) {
    map.setTerrain({ source: 'terrain-dem', exaggeration: 4.0 });
    map.easeTo({ pitch: 40, duration: 500 });
    document.getElementById('btn3dToggle').textContent = 'ğŸ”ï¸';
  } else {
    map.setTerrain(null);
    map.easeTo({ pitch: 0, bearing: 0, duration: 500 });
    document.getElementById('btn3dToggle').textContent = '2D';
  }
});

document.getElementById('chk3d').addEventListener('change', e => {
  if (e.target.checked) {
    map.setTerrain({ source: 'terrain-dem', exaggeration: 4.0 });
  } else {
    map.setTerrain(null);
    map.easeTo({ pitch: 0, bearing: 0, duration: 300 });
  }
});

// Contour line visibility toggle
document.getElementById('chkContour')?.addEventListener('change', e => {
  const v = e.target.checked ? 'visible' : 'none';
  try { ['contour-lines','contour-lines-major','contour-labels'].forEach(l => map.setLayoutProperty(l,'visibility',v)); } catch(err) {}
});

document.getElementById('contourOpacity').addEventListener('input', e => {
  const v = e.target.value / 100;
  try {
    map.setPaintProperty('contour-lines', 'line-opacity', v);
    map.setPaintProperty('contour-lines-major', 'line-opacity', v);
    map.setPaintProperty('contour-labels', 'text-opacity', v);
  } catch(err) {}
});

document.getElementById('chkStation').addEventListener('change', e => {
  if (window._stnMarkers) {
    window._stnMarkers.forEach(m => m.getElement().style.display = e.target.checked ? '' : 'none');
  }
});
document.getElementById('chkRoute').addEventListener('change', e => {
  const v = e.target.checked ? 'visible' : 'none';
  ['flat-routes-line','flat-routes-label','caution-fill','caution-border','caution-label'].forEach(l => map.setLayoutProperty(l,'visibility',v));
});
document.getElementById('chkSlope').addEventListener('change', e => {
  const v = e.target.checked ? 'visible' : 'none';
  try { ['slope-arrow','road-slope-line','road-slope-arrows','road-slope-labels'].forEach(l => map.setLayoutProperty(l,'visibility',v)); } catch(err){}
});

// ===== My Location =====
document.getElementById('btnLocate').addEventListener('click', () => {
  if (!navigator.geolocation) return alert('ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.');
  const b = document.getElementById('btnLocate');
  b.textContent = 'â³'; b.style.opacity = '0.6';
  navigator.geolocation.getCurrentPosition(p => {
    const ll = [p.coords.longitude, p.coords.latitude];
    addLocMarker(ll);
    map.flyTo({ center: ll, zoom: 15, duration: 800 });
    b.textContent = 'ğŸ“'; b.style.opacity = '1';
    new maplibregl.Popup({ offset: 12 }).setLngLat(ll).setHTML('ğŸ“ í˜„ìœ„ì¹˜').addTo(map);
  }, err => {
    b.textContent = 'ğŸ“'; b.style.opacity = '1';
    if (err.code === 1) alert('ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
    else alert('ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ìš”.');
  }, { enableHighAccuracy: true, timeout: 15000 });
});

// Auto-locate on mobile
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(p => {
    addLocMarker([p.coords.longitude, p.coords.latitude]);
  }, () => {}, { enableHighAccuracy: false, timeout: 8000, maximumAge: 60000 });
}

// ===== FPS MODE =====
let fpsActive = false;
let fpsKeys = {};
let fpsRaf = null;
let savedView = null;

document.getElementById('btnFps').addEventListener('click', enterFps);
document.getElementById('fpsExit').addEventListener('click', exitFps);

function enterFps() {
  fpsActive = true;
  // Save current view
  savedView = { center: map.getCenter(), zoom: map.getZoom(), pitch: map.getPitch(), bearing: map.getBearing() };

  // Set FPS camera
  map.setTerrain({ source: 'terrain-dem', exaggeration: 4.0 });
  map.easeTo({ pitch: 70, zoom: 17.5, duration: 600 });

  document.getElementById('fpsOverlay').classList.add('active');

  // Hide other UI
  document.querySelectorAll('.top-bar,.legend-bar,.fab-col,.ctrl-panel').forEach(el => el.style.display = 'none');

  // Fade out help after 5s
  setTimeout(() => {
    const c = document.getElementById('fpsControls');
    if (c) c.style.opacity = '0';
  }, 5000);

  // Start loop
  fpsLoop();
}

function exitFps() {
  fpsActive = false;
  document.getElementById('fpsOverlay').classList.remove('active');
  document.querySelectorAll('.top-bar,.legend-bar,.ctrl-panel').forEach(el => el.style.display = '');
  document.querySelectorAll('.fab-col').forEach(el => el.style.display = 'flex');
  document.getElementById('fpsControls').style.opacity = '1';

  if (savedView) {
    map.easeTo({ center: savedView.center, zoom: savedView.zoom, pitch: savedView.pitch, bearing: savedView.bearing, duration: 600 });
  }
  if (fpsRaf) cancelAnimationFrame(fpsRaf);
}

// Keyboard
document.addEventListener('keydown', e => {
  if (!fpsActive) return;
  fpsKeys[e.key.toLowerCase()] = true;
  if (e.key === 'Escape') exitFps();
});
document.addEventListener('keyup', e => {
  fpsKeys[e.key.toLowerCase()] = false;
});

// Mobile D-pad
document.querySelectorAll('.pad-btn').forEach(btn => {
  const dir = btn.dataset.dir;
  const setKey = (val) => {
    if (dir === 'forward') fpsKeys['w'] = val;
    if (dir === 'backward') fpsKeys['s'] = val;
    if (dir === 'left') fpsKeys['a'] = val;
    if (dir === 'right') fpsKeys['d'] = val;
  };
  btn.addEventListener('touchstart', e => { e.preventDefault(); setKey(true); });
  btn.addEventListener('touchend', e => { e.preventDefault(); setKey(false); });
  btn.addEventListener('mousedown', () => setKey(true));
  btn.addEventListener('mouseup', () => setKey(false));
  btn.addEventListener('mouseleave', () => setKey(false));
});

function fpsLoop() {
  if (!fpsActive) return;

  const speed = fpsKeys['shift'] ? 0.0006 : 0.00015;
  const bearing = map.getBearing() * Math.PI / 180;
  const center = map.getCenter();
  let lng = center.lng, lat = center.lat;

  // Forward/backward (relative to bearing)
  if (fpsKeys['w'] || fpsKeys['arrowup']) {
    lng += Math.sin(bearing) * speed;
    lat += Math.cos(bearing) * speed;
  }
  if (fpsKeys['s'] || fpsKeys['arrowdown']) {
    lng -= Math.sin(bearing) * speed;
    lat -= Math.cos(bearing) * speed;
  }
  // Strafe left/right
  if (fpsKeys['a'] || fpsKeys['arrowleft']) {
    lng -= Math.cos(bearing) * speed;
    lat += Math.sin(bearing) * speed;
  }
  if (fpsKeys['d'] || fpsKeys['arrowright']) {
    lng += Math.cos(bearing) * speed;
    lat -= Math.sin(bearing) * speed;
  }
  // Height (zoom)
  let zoom = map.getZoom();
  if (fpsKeys['q']) zoom = Math.min(20, zoom + 0.02);
  if (fpsKeys['e']) zoom = Math.max(14, zoom - 0.02);

  // Rotate with R/F or mouse drag is handled by MapLibre natively
  let pitch = map.getPitch();
  if (fpsKeys['r']) pitch = Math.min(85, pitch + 0.5);
  if (fpsKeys['f']) pitch = Math.max(30, pitch - 0.5);

  map.jumpTo({ center: [lng, lat], zoom, pitch });

  // Update coords HUD
  document.getElementById('fpsCoords').textContent =
    `${lat.toFixed(4)}, ${lng.toFixed(4)} | ì¤Œ:${zoom.toFixed(1)} | ë°©í–¥:${(map.getBearing()).toFixed(0)}Â°`;

  fpsRaf = requestAnimationFrame(fpsLoop);
}

// ===== MINECRAFT VOXEL MODE =====
let mcActive = false, mcScene, mcCamera, mcRenderer, mcRaf;
const mcKeys = {};

document.getElementById('btnMinecraft').addEventListener('click', enterMc);

function exitMc() {
  mcActive = false;
  document.getElementById('mcOverlay').style.display = 'none';
  if (mcRaf) cancelAnimationFrame(mcRaf);
  if (mcRenderer) { mcRenderer.dispose(); mcRenderer = null; }
  mcScene = mcCamera = null;
}
window.exitMc = exitMc;

async function enterMc() {
  mcActive = true;
  document.getElementById('mcOverlay').style.display = 'block';
  if (/Mobi|Android|iPhone/i.test(navigator.userAgent)) document.getElementById('mcPad').style.display = 'block';

  const canvas = document.getElementById('mcCanvas');
  const W = window.innerWidth, H = window.innerHeight;
  canvas.width = W; canvas.height = H;

  mcScene = new THREE.Scene();
  mcScene.background = new THREE.Color(0x87CEEB);
  mcScene.fog = new THREE.Fog(0x87CEEB, 80, 220);

  mcCamera = new THREE.PerspectiveCamera(70, W / H, 0.1, 300);
  mcCamera.position.set(64, 30, 64);

  mcRenderer = new THREE.WebGLRenderer({ canvas, antialias: true });
  mcRenderer.setSize(W, H);
  mcRenderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

  mcScene.add(new THREE.AmbientLight(0xffffff, 0.55));
  const sun = new THREE.DirectionalLight(0xffffff, 0.85);
  sun.position.set(60, 100, 40);
  mcScene.add(sun);

  document.getElementById('mcCoords').textContent = 'â³ ì§€í˜• ë¡œë”© ì¤‘...';
  const grid = await loadDEM();
  buildBlocks(grid);
  addSigns(grid);
  document.getElementById('mcCoords').textContent = 'ì¤€ë¹„!';
  setTimeout(() => { document.getElementById('mcHelp').style.opacity = '0.3'; }, 5000);

  // Camera state
  let yaw = -Math.PI / 2, ptch = -0.3, camY = 30;
  let dragging = false, lx = 0, ly = 0;

  canvas.addEventListener('mousedown', e => { dragging = true; lx = e.clientX; ly = e.clientY; });
  canvas.addEventListener('mousemove', e => { if (!dragging) return; yaw += (e.clientX - lx) * 0.003; ptch -= (e.clientY - ly) * 0.003; ptch = Math.max(-1.2, Math.min(1.2, ptch)); lx = e.clientX; ly = e.clientY; });
  canvas.addEventListener('mouseup', () => dragging = false);
  canvas.addEventListener('touchstart', e => { const t = e.touches[0]; lx = t.clientX; ly = t.clientY; });
  canvas.addEventListener('touchmove', e => { const t = e.touches[0]; yaw += (t.clientX - lx) * 0.004; ptch -= (t.clientY - ly) * 0.004; ptch = Math.max(-1.2, Math.min(1.2, ptch)); lx = t.clientX; ly = t.clientY; });

  document.querySelectorAll('.mc-pad').forEach(btn => {
    const d = btn.dataset.d;
    btn.addEventListener('touchstart', e => { e.preventDefault(); mcKeys[d] = true; });
    btn.addEventListener('touchend', e => { e.preventDefault(); mcKeys[d] = false; });
  });

  (function animate() {
    if (!mcActive) return;
    mcRaf = requestAnimationFrame(animate);
    const spd = mcKeys['shift'] ? 0.5 : 0.18;
    const dx = Math.cos(yaw) * spd, dz = Math.sin(yaw) * spd;
    if (mcKeys['w'] || mcKeys['arrowup']) { mcCamera.position.x += dx; mcCamera.position.z += dz; }
    if (mcKeys['s'] || mcKeys['arrowdown']) { mcCamera.position.x -= dx; mcCamera.position.z -= dz; }
    if (mcKeys['a'] || mcKeys['arrowleft']) { mcCamera.position.x += dz; mcCamera.position.z -= dx; }
    if (mcKeys['d'] || mcKeys['arrowright']) { mcCamera.position.x -= dz; mcCamera.position.z += dx; }
    if (mcKeys[' '] || mcKeys['q']) camY += 0.15;
    if (mcKeys['e']) camY = Math.max(3, camY - 0.15);
    mcCamera.position.y = camY;
    mcCamera.lookAt(mcCamera.position.x + Math.cos(yaw) * 10, mcCamera.position.y + Math.sin(ptch) * 10, mcCamera.position.z + Math.sin(yaw) * 10);
    document.getElementById('mcCoords').textContent = `X:${Math.floor(mcCamera.position.x)} Y:${Math.floor(camY)} Z:${Math.floor(mcCamera.position.z)}`;
    mcRenderer.render(mcScene, mcCamera);
  })();
}

async function loadDEM() {
  const SIZE = 128;
  const grid = new Float32Array(SIZE * SIZE);
  return new Promise(resolve => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => {
      const cv = document.createElement('canvas');
      cv.width = img.width; cv.height = img.height;
      const ctx = cv.getContext('2d');
      ctx.drawImage(img, 0, 0);
      const px = ctx.getImageData(0, 0, cv.width, cv.height).data;
      for (let gy = 0; gy < SIZE; gy++)
        for (let gx = 0; gx < SIZE; gx++) {
          const sx = Math.floor(gx / SIZE * cv.width), sy = Math.floor(gy / SIZE * cv.height);
          const i = (sy * cv.width + sx) * 4;
          grid[gy * SIZE + gx] = (px[i] * 256 + px[i + 1] + px[i + 2] / 256) - 32768;
        }
      resolve(grid);
    };
    img.onerror = () => {
      // Fallback procedural terrain
      for (let gy = 0; gy < SIZE; gy++)
        for (let gx = 0; gx < SIZE; gx++) {
          const d1 = ((gx - 90) ** 2 + (gy - 100) ** 2), d2 = ((gx - 55) ** 2 + (gy - 65) ** 2);
          grid[gy * SIZE + gx] = 15 + 80 * Math.exp(-d1 / 400) + 65 * Math.exp(-d2 / 350) + Math.random() * 2;
        }
      resolve(grid);
    };
    img.src = 'https://s3.amazonaws.com/elevation-tiles-prod/terrarium/12/3494/1574.png';
  });
}

function buildBlocks(grid) {
  const S = 128;
  const mn = Math.min(...grid), mx = Math.max(...grid), rng = mx - mn || 1;
  const colors = [0x3B7A2B, 0x4A8C3A, 0x6B8E23, 0x8B7355, 0x8B6914, 0x9E7B4F, 0x808080, 0xA0A0A0];
  const geo = new THREE.BoxGeometry(1, 1, 1);
  const buckets = new Map();

  for (let z = 0; z < S; z++) {
    for (let x = 0; x < S; x++) {
      const e = grid[z * S + x];
      const norm = (e - mn) / rng;
      const h = Math.max(1, Math.round(norm * 28));
      const ci = Math.min(colors.length - 1, Math.floor(norm * colors.length));
      const layers = Math.min(h, 5);
      for (let ly = 0; ly < layers; ly++) {
        const c = ly === 0 ? colors[ci] : ly < 3 ? 0x8B6B4A : 0x606060;
        const key = c;
        if (!buckets.has(key)) buckets.set(key, []);
        buckets.get(key).push([x, h - ly - 0.5, z]);
      }
    }
  }

  const dummy = new THREE.Object3D();
  buckets.forEach((positions, color) => {
    const mat = new THREE.MeshLambertMaterial({ color });
    const mesh = new THREE.InstancedMesh(geo, mat, positions.length);
    positions.forEach((p, i) => {
      dummy.position.set(p[0], p[1], p[2]);
      dummy.updateMatrix();
      mesh.setMatrixAt(i, dummy.matrix);
    });
    mcScene.add(mesh);
  });

  // Water plane
  const waterGeo = new THREE.PlaneGeometry(S, S);
  const waterMat = new THREE.MeshLambertMaterial({ color: 0x3B82F6, transparent: true, opacity: 0.6 });
  const water = new THREE.Mesh(waterGeo, waterMat);
  water.rotation.x = -Math.PI / 2;
  water.position.set(S / 2, 2, S / 2);
  mcScene.add(water);
}

function addSigns(grid) {
  const S = 128, mn = Math.min(...grid), rng = (Math.max(...grid) - mn) || 1;
  const signs = [
    { n: 'ê°•ë‚¨ì—­', x: 25, z: 60 }, { n: 'ì—­ì‚¼ì—­', x: 38, z: 55 }, { n: 'ì„ ë¦‰ì—­', x: 52, z: 48 },
    { n: 'ì‚¼ì„±ì—­', x: 68, z: 40 }, { n: 'ë„ê³¡ì—­', x: 48, z: 65 }, { n: 'ëŒ€ì¹˜ì—­', x: 60, z: 58 },
    { n: 'ìˆ˜ì„œì—­', x: 100, z: 62 }, { n: 'ë§¤ë´‰ì—­', x: 37, z: 68 }, { n: 'ì–‘ì¬ì—­', x: 36, z: 80 },
    { n: 'â›° ëŒ€ëª¨ì‚°', x: 88, z: 90 }, { n: 'â›° êµ¬ë£¡ì‚°', x: 62, z: 82 },
  ];
  signs.forEach(s => {
    const gi = Math.min(S - 1, s.z) * S + Math.min(S - 1, s.x);
    const h = Math.max(1, Math.round(((grid[gi] || mn) - mn) / rng * 28));

    const cv = document.createElement('canvas');
    cv.width = 256; cv.height = 64;
    const ctx = cv.getContext('2d');
    ctx.fillStyle = 'rgba(0,0,0,0.65)';
    ctx.beginPath(); ctx.roundRect(4, 4, 248, 56, 10); ctx.fill();
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 26px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(s.n, 128, 42);
    const tex = new THREE.CanvasTexture(cv);
    const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex, transparent: true }));
    sprite.position.set(s.x, h + 7, s.z);
    sprite.scale.set(12, 3, 1);
    mcScene.add(sprite);

    // Pole
    const pole = new THREE.Mesh(new THREE.CylinderGeometry(0.12, 0.12, 6, 4), new THREE.MeshLambertMaterial({ color: 0x444444 }));
    pole.position.set(s.x, h + 3.5, s.z);
    mcScene.add(pole);
  });
}

document.addEventListener('keydown', e => { mcKeys[e.key.toLowerCase()] = true; if (e.key === 'Escape' && mcActive) exitMc(); });
document.addEventListener('keyup', e => { mcKeys[e.key.toLowerCase()] = false; });
</script>
</body>
</html>
