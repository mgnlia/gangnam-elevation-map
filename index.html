<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ê°•ë‚¨ ìì „ê±° ê³ ë„ ì§€ë„ ğŸš´</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #1a1a2e; }
#map { width: 100%; height: 100vh; }

/* --- Top bar --- */
.top-bar {
  position: absolute;
  top: 0; left: 0; right: 0;
  z-index: 1000;
  background: rgba(26,26,46,0.92);
  backdrop-filter: blur(10px);
  padding: 10px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  color: #fff;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.top-bar h1 { font-size: 15px; font-weight: 700; }
.top-bar h1 span { font-weight: 400; opacity: 0.6; font-size: 12px; }
.mode-tabs {
  display: flex;
  gap: 4px;
  background: rgba(255,255,255,0.08);
  border-radius: 8px;
  padding: 3px;
}
.mode-tab {
  padding: 5px 12px;
  border: none;
  border-radius: 6px;
  background: transparent;
  color: rgba(255,255,255,0.6);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.mode-tab.active { background: #4CAF50; color: #fff; }

/* --- Bottom sheet --- */
.bottom-sheet {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  z-index: 1000;
  background: rgba(26,26,46,0.94);
  backdrop-filter: blur(12px);
  border-radius: 16px 16px 0 0;
  padding: 12px 16px;
  padding-bottom: max(12px, env(safe-area-inset-bottom));
  color: #fff;
  transition: transform 0.3s ease;
}
.sheet-handle {
  width: 36px; height: 4px;
  background: rgba(255,255,255,0.2);
  border-radius: 2px;
  margin: 0 auto 10px;
}
.elev-info {
  display: flex;
  align-items: center;
  gap: 12px;
}
.elev-big {
  font-size: 32px;
  font-weight: 800;
  color: #4CAF50;
  line-height: 1;
}
.elev-big small { font-size: 14px; font-weight: 500; }
.elev-detail { font-size: 12px; color: rgba(255,255,255,0.55); line-height: 1.6; }
.elev-detail strong { color: rgba(255,255,255,0.85); }

/* Compare mode */
.compare-info {
  display: none;
}
.compare-info .compare-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 6px;
}
.compare-dot {
  width: 10px; height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}
.compare-label { font-size: 12px; color: rgba(255,255,255,0.6); }
.compare-elev { font-size: 14px; font-weight: 700; }
.compare-result {
  background: rgba(255,255,255,0.06);
  border-radius: 8px;
  padding: 8px 12px;
  margin-top: 6px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.compare-arrow { font-size: 24px; }
.compare-diff { font-size: 18px; font-weight: 800; }
.compare-verdict { font-size: 12px; color: rgba(255,255,255,0.5); }

.hint-text {
  font-size: 13px;
  color: rgba(255,255,255,0.45);
  text-align: center;
  padding: 8px 0;
}

/* --- Flat route badges --- */
.flat-route-badge {
  background: rgba(76,175,80,0.88);
  color: #fff;
  font-size: 11px;
  font-weight: 700;
  padding: 3px 8px;
  border-radius: 10px;
  white-space: nowrap;
  box-shadow: 0 1px 4px rgba(0,0,0,0.3);
  letter-spacing: -0.3px;
}
.caution-badge {
  background: rgba(244,67,54,0.85);
}
.moderate-badge {
  background: rgba(255,152,0,0.85);
}

/* --- Station labels --- */
.station-dot {
  background: rgba(255,255,255,0.92);
  border: 2px solid;
  border-radius: 4px;
  padding: 1px 5px;
  font-size: 10px;
  font-weight: 600;
  white-space: nowrap;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.sl-2 { border-color: #33A23D; color: #33A23D; }
.sl-3 { border-color: #FE5B10; color: #FE5B10; }
.sl-7 { border-color: #6E8B2D; color: #6E8B2D; }
.sl-9 { border-color: #AA9872; color: #AA9872; }
.sl-sh { border-color: #A71E31; color: #A71E31; }
.sl-su { border-color: #b39500; color: #b39500; }

.hill-label {
  font-size: 10px;
  font-weight: 700;
  color: #FF6B6B;
  text-shadow: 0 0 4px rgba(0,0,0,0.8), 0 0 4px rgba(0,0,0,0.8);
  white-space: nowrap;
}

/* --- FABs --- */
.fab-group {
  position: absolute;
  right: 12px;
  bottom: 120px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.fab {
  width: 44px; height: 44px;
  border-radius: 50%;
  border: none;
  background: rgba(26,26,46,0.9);
  backdrop-filter: blur(8px);
  color: #fff;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  transition: all 0.2s;
}
.fab:active { transform: scale(0.92); }

/* --- Layer panel --- */
.layer-panel {
  position: absolute;
  top: 54px; left: 10px;
  z-index: 1000;
  background: rgba(26,26,46,0.92);
  backdrop-filter: blur(10px);
  border-radius: 10px;
  padding: 10px 12px;
  color: #fff;
  font-size: 12px;
  display: none;
}
.layer-panel.show { display: block; }
.layer-panel label {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 4px;
  cursor: pointer;
}

/* Slope legend */
.slope-legend {
  position: absolute;
  top: 54px; right: 10px;
  z-index: 999;
  background: rgba(26,26,46,0.88);
  backdrop-filter: blur(8px);
  border-radius: 8px;
  padding: 8px 10px;
  color: rgba(255,255,255,0.7);
  font-size: 10px;
}
.slope-legend h4 { font-size: 11px; color: #fff; margin-bottom: 4px; }
.sl-item { display: flex; align-items: center; margin-bottom: 2px; }
.sl-color { width: 14px; height: 8px; border-radius: 2px; margin-right: 5px; }

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(66,133,244,0.5); }
  70% { box-shadow: 0 0 0 14px rgba(66,133,244,0); }
  100% { box-shadow: 0 0 0 0 rgba(66,133,244,0); }
}
.loc-dot {
  width: 14px; height: 14px;
  background: #4285F4;
  border: 2.5px solid #fff;
  border-radius: 50%;
  animation: pulse 2s infinite;
}
</style>
</head>
<body>

<div id="map"></div>

<!-- Top bar -->
<div class="top-bar">
  <h1>ğŸš´ ê°•ë‚¨ ì˜¤ë¥´ë§‰ ì§€ë„ <span>â€” ì–¸ë• í”¼í•´ì„œ íƒ€ì</span></h1>
  <div class="mode-tabs">
    <button class="mode-tab active" data-mode="explore">íƒìƒ‰</button>
    <button class="mode-tab" data-mode="compare">ë¹„êµ</button>
  </div>
</div>

<!-- Layer toggle -->
<div class="layer-panel" id="layerPanel">
  <label><input type="radio" name="base" value="topo" checked> ë“±ê³ ì„ </label>
  <label><input type="radio" name="base" value="osm"> ì¼ë°˜</label>
  <label><input type="radio" name="base" value="satellite"> ìœ„ì„±</label>
  <hr style="border:none;border-top:1px solid rgba(255,255,255,0.1);margin:5px 0">
  <label><input type="checkbox" id="chkHill" checked> ìŒì˜ê¸°ë³µ</label>
  <label><input type="checkbox" id="chkStation" checked> ğŸš‡ ì§€í•˜ì² ì—­</label>
  <label><input type="checkbox" id="chkPeak" checked> â›°ï¸ ì–¸ë•</label>
  <label><input type="checkbox" id="chkRoute" checked> ğŸŸ¢ ì¶”ì²œ/ì£¼ì˜ ê²½ë¡œ</label>
</div>

<!-- Slope legend -->
<div class="slope-legend">
  <h4>ê²½ì‚¬ë„ ê°€ì´ë“œ</h4>
  <div class="sl-item"><div class="sl-color" style="background:#4CAF50"></div> í‰ì§€ (ì•ˆì „)</div>
  <div class="sl-item"><div class="sl-color" style="background:#FF9800"></div> ì•½ê°„ ì˜¤ë¥´ë§‰</div>
  <div class="sl-item"><div class="sl-color" style="background:#f44336"></div> ê¸‰ê²½ì‚¬ (âš ï¸ íšŒí”¼)</div>
</div>

<!-- FABs -->
<div class="fab-group">
  <button class="fab" id="btnLayers" title="ë ˆì´ì–´">ğŸ—ºï¸</button>
  <button class="fab" id="btnLocate" title="ë‚´ ìœ„ì¹˜">ğŸ“</button>
  <button class="fab" id="btnReset" title="ê°•ë‚¨êµ¬ ì „ì²´ë³´ê¸°">ğŸ”„</button>
</div>

<!-- Bottom sheet -->
<div class="bottom-sheet" id="bottomSheet">
  <div class="sheet-handle"></div>
  <!-- Explore mode -->
  <div id="exploreInfo">
    <div class="hint-text">ğŸš´ ì§€ë„ë¥¼ íƒ­í•˜ë©´ í•´ë‹¹ ì§€ì ì˜ ê³ ë„ë¥¼ í™•ì¸í•©ë‹ˆë‹¤</div>
  </div>
  <!-- Compare mode -->
  <div class="compare-info" id="compareInfo">
    <div class="hint-text" id="compareHint">ğŸ…°ï¸ ì¶œë°œ ì§€ì ì„ íƒ­í•˜ì„¸ìš”</div>
    <div id="compareResult" style="display:none">
      <div class="compare-row">
        <div class="compare-dot" style="background:#4CAF50"></div>
        <div>
          <div class="compare-label">ì¶œë°œ ğŸ…°ï¸</div>
          <div class="compare-elev" id="elevA">â€”</div>
        </div>
      </div>
      <div class="compare-row">
        <div class="compare-dot" style="background:#2196F3"></div>
        <div>
          <div class="compare-label">ë„ì°© ğŸ…±ï¸</div>
          <div class="compare-elev" id="elevB">â€”</div>
        </div>
      </div>
      <div class="compare-result" id="diffBox">
        <div class="compare-arrow" id="diffArrow">â†’</div>
        <div>
          <div class="compare-diff" id="diffText">â€”</div>
          <div class="compare-verdict" id="diffVerdict"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ========== CONFIG ==========
const gangnamCenter = [37.497, 127.047];
const gangnamBounds = [[37.464, 127.012], [37.532, 127.105]];

// ========== MAP ==========
const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom: 17 });
const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 });
const satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 18 });
const hillLayer = L.tileLayer('https://tiles.wmflabs.org/hillshading/{z}/{x}/{y}.png', { maxZoom: 17, opacity: 0.45 });

const map = L.map('map', {
  center: gangnamCenter, zoom: 14,
  layers: [topoLayer, hillLayer],
  zoomControl: false,
  attributionControl: false
});
L.control.zoom({ position: 'topleft' }).addTo(map);
L.control.attribution({ position: 'bottomleft', prefix: false }).addAttribution('Â© OpenTopoMap Â· OSM Â· Open-Elevation').addTo(map);
map.fitBounds(gangnamBounds, { padding: [10, 60] });

// ========== FLAT / CAUTION ROUTES ==========
const routeGroup = L.layerGroup();

// Flat cycling paths (green)
const flatRoutes = [
  { name: 'ğŸŸ¢ íƒ„ì²œ ìì „ê±°ê¸¸ (í‰ì§€)', coords: [[37.5145,127.0946],[37.5100,127.0920],[37.5040,127.0870],[37.4970,127.0810],[37.4910,127.0770],[37.4850,127.0730],[37.4780,127.0680],[37.4720,127.0640],[37.4665,127.0610]] },
  { name: 'ğŸŸ¢ ì–‘ì¬ì²œ ìì „ê±°ê¸¸ (í‰ì§€)', coords: [[37.4842,127.0352],[37.4835,127.0420],[37.4830,127.0490],[37.4828,127.0560],[37.4825,127.0630],[37.4822,127.0700],[37.4820,127.0750]] },
  { name: 'ğŸŸ¢ í•œê°• ìì „ê±°ê¸¸ (í‰ì§€)', coords: [[37.5240,127.0100],[37.5250,127.0200],[37.5260,127.0300],[37.5270,127.0400],[37.5265,127.0500],[37.5260,127.0600],[37.5255,127.0700],[37.5250,127.0800],[37.5245,127.0900],[37.5240,127.1000]] },
  { name: 'ğŸŸ¢ í…Œí—¤ë€ë¡œ (ë¹„êµì  í‰ì§€)', coords: [[37.4979,127.0276],[37.4990,127.0330],[37.5007,127.0366],[37.5025,127.0420],[37.5045,127.0490],[37.5065,127.0560],[37.5088,127.0639]] },
];

flatRoutes.forEach(r => {
  L.polyline(r.coords, { color: '#4CAF50', weight: 5, opacity: 0.7, dashArray: null, lineCap: 'round' })
    .bindPopup(`<strong>${r.name}</strong><br>ìì „ê±° íƒ€ê¸° ì¢‹ì€ í‰íƒ„í•œ êµ¬ê°„`)
    .addTo(routeGroup);
  // Label at midpoint
  const mid = r.coords[Math.floor(r.coords.length / 2)];
  L.marker(mid, {
    icon: L.divIcon({ html: `<div class="flat-route-badge">${r.name}</div>`, className: '', iconAnchor: [0, 0] }),
    interactive: false
  }).addTo(routeGroup);
});

// Steep/caution zones (red areas)
const cautionZones = [
  { name: 'ğŸ”´ ëŒ€ëª¨ì‚°Â·êµ¬ë£¡ì‚° ê¸‰ê²½ì‚¬', center: [37.476, 127.073], radius: 600 },
  { name: 'ğŸŸ  ë§¤ë´‰ì‚° ì˜¤ë¥´ë§‰', center: [37.489, 127.040], radius: 350 },
  { name: 'ğŸ”´ ìš°ë©´ì‚° ê¸‰ê²½ì‚¬', center: [37.478, 127.010], radius: 450 },
  { name: 'ğŸŸ  ì„¸ê³¡ë™ êµ¬ë¦‰', center: [37.468, 127.070], radius: 400 },
];

cautionZones.forEach(z => {
  const isSteep = z.name.startsWith('ğŸ”´');
  L.circle(z.center, {
    radius: z.radius,
    color: isSteep ? '#f44336' : '#FF9800',
    fillColor: isSteep ? '#f44336' : '#FF9800',
    fillOpacity: 0.12,
    weight: 2,
    dashArray: '6,4'
  }).bindPopup(`<strong>${z.name}</strong><br>${isSteep ? 'âš ï¸ ìì „ê±° íšŒí”¼ ê¶Œì¥' : 'âš ï¸ ì˜¤ë¥´ë§‰ ì£¼ì˜'}`)
   .addTo(routeGroup);

  L.marker(z.center, {
    icon: L.divIcon({
      html: `<div class="${isSteep ? 'flat-route-badge caution-badge' : 'flat-route-badge moderate-badge'}">${z.name}</div>`,
      className: '', iconAnchor: [0, 0]
    }), interactive: false
  }).addTo(routeGroup);
});

routeGroup.addTo(map);

// ========== STATIONS ==========
const stationGroup = L.layerGroup();
const stations = [
  { n:'ê°•ë‚¨',lat:37.4979,lng:127.0276,c:'sl-2'},{ n:'ì—­ì‚¼',lat:37.5007,lng:127.0366,c:'sl-2'},
  { n:'ì„ ë¦‰',lat:37.5045,lng:127.0490,c:'sl-2'},{ n:'ì‚¼ì„±',lat:37.5088,lng:127.0639,c:'sl-2'},
  { n:'ì¢…í•©ìš´ë™ì¥',lat:37.5107,lng:127.0736,c:'sl-2'},{ n:'êµëŒ€',lat:37.4934,lng:127.0146,c:'sl-2'},
  { n:'ì••êµ¬ì •',lat:37.5270,lng:127.0286,c:'sl-3'},{ n:'ì‹ ì‚¬',lat:37.5164,lng:127.0203,c:'sl-3'},
  { n:'ë§¤ë´‰',lat:37.4874,lng:127.0347,c:'sl-3'},{ n:'ë„ê³¡',lat:37.4915,lng:127.0455,c:'sl-3'},
  { n:'ëŒ€ì¹˜',lat:37.4948,lng:127.0577,c:'sl-3'},{ n:'í•™ì—¬ìš¸',lat:37.4965,lng:127.0648,c:'sl-3'},
  { n:'ëŒ€ì²­',lat:37.4920,lng:127.0744,c:'sl-3'},{ n:'ì¼ì›',lat:37.4836,lng:127.0867,c:'sl-3'},
  { n:'ìˆ˜ì„œ',lat:37.4872,lng:127.1017,c:'sl-3'},
  { n:'ê°•ë‚¨êµ¬ì²­',lat:37.5173,lng:127.0413,c:'sl-7'},{ n:'ì²­ë‹´',lat:37.5196,lng:127.0539,c:'sl-7'},
  { n:'ë…¼í˜„',lat:37.5113,lng:127.0215,c:'sl-7'},{ n:'í•™ë™',lat:37.5146,lng:127.0319,c:'sl-7'},
  { n:'ë´‰ì€ì‚¬',lat:37.5140,lng:127.0580,c:'sl-9'},{ n:'ì–¸ì£¼',lat:37.5072,lng:127.0340,c:'sl-9'},
  { n:'ì‹ ë…¼í˜„',lat:37.5045,lng:127.0253,c:'sl-9'},{ n:'ì„ ì •ë¦‰',lat:37.5104,lng:127.0448,c:'sl-9'},
  { n:'ì–‘ì¬',lat:37.4842,lng:127.0352,c:'sl-sh'},
  { n:'í•œí‹°',lat:37.4984,lng:127.0561,c:'sl-su'},{ n:'êµ¬ë£¡',lat:37.4847,lng:127.0538,c:'sl-su'},
  { n:'ê°œí¬ë™',lat:37.4787,lng:127.0549,c:'sl-su'},{ n:'ëŒ€ëª¨ì‚°ì…êµ¬',lat:37.4765,lng:127.0772,c:'sl-su'},
];
stations.forEach(s => {
  L.marker([s.lat, s.lng], {
    icon: L.divIcon({ html: `<div class="station-dot ${s.c}">${s.n}</div>`, className: '', iconAnchor: [0, -2] }),
    interactive: false
  }).addTo(stationGroup);
});
stationGroup.addTo(map);

// ========== HILLS ==========
const peakGroup = L.layerGroup();
[
  { n:'â›°ï¸ ëŒ€ëª¨ì‚° 293m', lat:37.4730, lng:127.0830 },
  { n:'â›°ï¸ êµ¬ë£¡ì‚° 306m', lat:37.4785, lng:127.0620 },
  { n:'â›°ï¸ ë§¤ë´‰ì‚° 101m', lat:37.4910, lng:127.0450 },
  { n:'â›°ï¸ ìš°ë©´ì‚° 293m', lat:37.4780, lng:127.0080 },
].forEach(h => {
  L.marker([h.lat, h.lng], {
    icon: L.divIcon({ html: `<div class="hill-label">${h.n}</div>`, className: '', iconAnchor: [0, 8] }),
    interactive: false
  }).addTo(peakGroup);
});
peakGroup.addTo(map);

// ========== LAYER CONTROLS ==========
const bases = { topo: topoLayer, osm: osmLayer, satellite: satLayer };
let curBase = 'topo';
document.querySelectorAll('input[name="base"]').forEach(r => {
  r.addEventListener('change', e => { map.removeLayer(bases[curBase]); curBase = e.target.value; map.addLayer(bases[curBase]); });
});
document.getElementById('chkHill').addEventListener('change', e => e.target.checked ? map.addLayer(hillLayer) : map.removeLayer(hillLayer));
document.getElementById('chkStation').addEventListener('change', e => e.target.checked ? map.addLayer(stationGroup) : map.removeLayer(stationGroup));
document.getElementById('chkPeak').addEventListener('change', e => e.target.checked ? map.addLayer(peakGroup) : map.removeLayer(peakGroup));
document.getElementById('chkRoute').addEventListener('change', e => e.target.checked ? map.addLayer(routeGroup) : map.removeLayer(routeGroup));

document.getElementById('btnLayers').addEventListener('click', () => {
  document.getElementById('layerPanel').classList.toggle('show');
});

document.getElementById('btnReset').addEventListener('click', () => {
  map.fitBounds(gangnamBounds, { padding: [10, 60] });
});

// ========== MY LOCATION ==========
let locMarker = null, locCircle = null;
document.getElementById('btnLocate').addEventListener('click', () => {
  if (!navigator.geolocation) return alert('ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
  const btn = document.getElementById('btnLocate');
  btn.textContent = 'â³';
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude: lat, longitude: lng, accuracy } = pos.coords;
    if (locMarker) { map.removeLayer(locMarker); map.removeLayer(locCircle); }
    locMarker = L.marker([lat, lng], {
      icon: L.divIcon({ html: '<div class="loc-dot"></div>', className: '', iconSize: [14,14], iconAnchor: [7,7] }),
      zIndexOffset: 9999
    }).addTo(map);
    locCircle = L.circle([lat, lng], { radius: accuracy, color: '#4285F4', fillColor: '#4285F4', fillOpacity: 0.08, weight: 1 }).addTo(map);
    map.setView([lat, lng], 15);
    btn.textContent = 'ğŸ“';
    fetchElev(lat, lng).then(elev => {
      if (elev !== null) locMarker.bindPopup(`ğŸ“ í˜„ìœ„ì¹˜ ê³ ë„: <strong>${elev}m</strong>`).openPopup();
    });
  }, err => { btn.textContent = 'ğŸ“'; alert('ìœ„ì¹˜ ì˜¤ë¥˜: ' + err.message); }, { enableHighAccuracy: true, timeout: 10000 });
});

// ========== ELEVATION API ==========
async function fetchElev(lat, lng) {
  try {
    const r = await fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}`);
    const d = await r.json();
    return d.results[0].elevation;
  } catch { return null; }
}

// ========== MODES ==========
let mode = 'explore'; // explore | compare
let compareState = 0; // 0: waiting A, 1: waiting B, 2: done
let pointA = null, pointB = null;
let markerA = null, markerB = null, compareLine = null;

document.querySelectorAll('.mode-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    mode = tab.dataset.mode;
    resetCompare();
    document.getElementById('exploreInfo').style.display = mode === 'explore' ? 'block' : 'none';
    document.getElementById('compareInfo').style.display = mode === 'compare' ? 'block' : 'none';
  });
});

function resetCompare() {
  compareState = 0; pointA = null; pointB = null;
  [markerA, markerB, compareLine].forEach(m => { if (m) map.removeLayer(m); });
  markerA = markerB = compareLine = null;
  document.getElementById('compareHint').style.display = 'block';
  document.getElementById('compareHint').textContent = 'ğŸ…°ï¸ ì¶œë°œ ì§€ì ì„ íƒ­í•˜ì„¸ìš”';
  document.getElementById('compareResult').style.display = 'none';
  // Reset explore
  document.getElementById('exploreInfo').innerHTML = '<div class="hint-text">ğŸš´ ì§€ë„ë¥¼ íƒ­í•˜ë©´ í•´ë‹¹ ì§€ì ì˜ ê³ ë„ë¥¼ í™•ì¸í•©ë‹ˆë‹¤</div>';
}

// ========== MAP CLICK ==========
let clickMarker = null;

map.on('click', async (e) => {
  const { lat, lng } = e.latlng;

  if (mode === 'explore') {
    if (clickMarker) map.removeLayer(clickMarker);
    clickMarker = L.circleMarker([lat, lng], { radius: 6, color: '#4CAF50', fillColor: '#4CAF50', fillOpacity: 0.9, weight: 2 }).addTo(map);

    document.getElementById('exploreInfo').innerHTML = `
      <div class="elev-info">
        <div class="elev-big">â³<small>m</small></div>
        <div class="elev-detail">ì¡°íšŒ ì¤‘...</div>
      </div>`;

    const elev = await fetchElev(lat, lng);
    if (elev !== null) {
      let grade = 'í‰ì§€ ğŸŸ¢ ìì „ê±° OK';
      let color = '#4CAF50';
      if (elev > 80) { grade = 'ê¸‰ê²½ì‚¬ ğŸ”´ íšŒí”¼ ê¶Œì¥'; color = '#f44336'; }
      else if (elev > 40) { grade = 'ì•½ê°„ ì˜¤ë¥´ë§‰ ğŸŸ  ì£¼ì˜'; color = '#FF9800'; }

      document.getElementById('exploreInfo').innerHTML = `
        <div class="elev-info">
          <div class="elev-big" style="color:${color}">${elev}<small>m</small></div>
          <div class="elev-detail">
            <strong>${grade}</strong><br>
            ${lat.toFixed(4)}, ${lng.toFixed(4)}
          </div>
        </div>`;
    } else {
      document.getElementById('exploreInfo').innerHTML = `<div class="hint-text">âš ï¸ ê³ ë„ ì¡°íšŒ ì‹¤íŒ¨ â€” ë‹¤ì‹œ íƒ­í•´ë³´ì„¸ìš”</div>`;
    }
  }

  else if (mode === 'compare') {
    if (compareState === 0) {
      if (markerA) map.removeLayer(markerA);
      markerA = L.circleMarker([lat, lng], { radius: 7, color: '#4CAF50', fillColor: '#4CAF50', fillOpacity: 0.9 }).addTo(map);
      pointA = { lat, lng, elev: null };
      document.getElementById('compareHint').textContent = 'â³ ì¶œë°œ ê³ ë„ ì¡°íšŒ ì¤‘...';
      pointA.elev = await fetchElev(lat, lng);
      if (pointA.elev !== null) {
        document.getElementById('compareHint').textContent = `ğŸ…°ï¸ ${pointA.elev}m â€” ì´ì œ ğŸ…±ï¸ ë„ì°© ì§€ì ì„ íƒ­í•˜ì„¸ìš”`;
        compareState = 1;
      } else {
        document.getElementById('compareHint').textContent = 'âš ï¸ ì¡°íšŒ ì‹¤íŒ¨, ë‹¤ì‹œ íƒ­í•˜ì„¸ìš”';
      }
    }
    else if (compareState === 1) {
      if (markerB) map.removeLayer(markerB);
      if (compareLine) map.removeLayer(compareLine);
      markerB = L.circleMarker([lat, lng], { radius: 7, color: '#2196F3', fillColor: '#2196F3', fillOpacity: 0.9 }).addTo(map);
      compareLine = L.polyline([[pointA.lat, pointA.lng], [lat, lng]], { color: '#fff', weight: 2, dashArray: '6,6', opacity: 0.6 }).addTo(map);
      pointB = { lat, lng, elev: null };
      document.getElementById('compareHint').textContent = 'â³ ë„ì°© ê³ ë„ ì¡°íšŒ ì¤‘...';
      pointB.elev = await fetchElev(lat, lng);
      if (pointB.elev !== null) {
        document.getElementById('compareHint').style.display = 'none';
        document.getElementById('compareResult').style.display = 'block';
        document.getElementById('elevA').textContent = `${pointA.elev}m`;
        document.getElementById('elevB').textContent = `${pointB.elev}m`;
        const diff = pointB.elev - pointA.elev;
        const absDiff = Math.abs(diff);
        let arrow, color, verdict;
        if (diff > 10) {
          arrow = 'ğŸ“ˆ'; color = '#f44336';
          verdict = absDiff > 30 ? 'ì˜¤ë¥´ë§‰ ì‹¬í•¨! ë‹¤ë¥¸ ê¸¸ ì¶”ì²œ' : 'ì•½ê°„ ì˜¤ë¥´ë§‰ â€” í˜ë“¤ ìˆ˜ ìˆìŒ';
        } else if (diff < -10) {
          arrow = 'ğŸ“‰'; color = '#4CAF50';
          verdict = 'ë‚´ë¦¬ë§‰! í¸í•˜ê²Œ ê°ˆ ìˆ˜ ìˆì–´ìš” ğŸ‰';
        } else {
          arrow = 'â¡ï¸'; color = '#4CAF50';
          verdict = 'ê±°ì˜ í‰ì§€! ìì „ê±° íƒ€ê¸° ì¢‹ì•„ìš” ğŸš´';
        }
        document.getElementById('diffArrow').textContent = arrow;
        document.getElementById('diffText').style.color = color;
        document.getElementById('diffText').textContent = `${diff > 0 ? '+' : ''}${diff}m`;
        document.getElementById('diffVerdict').textContent = verdict;
        compareState = 2;
      } else {
        document.getElementById('compareHint').textContent = 'âš ï¸ ì¡°íšŒ ì‹¤íŒ¨, ë‹¤ì‹œ íƒ­í•˜ì„¸ìš”';
        document.getElementById('compareHint').style.display = 'block';
      }
    }
    else if (compareState === 2) {
      resetCompare();
      // Re-trigger as new A
      map.fire('click', e);
    }
  }
});
</script>
</body>
</html>
