<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#4CAF50">
<meta name="description" content="ì„œìš¸ ì§€ì—­ ì§€í˜•ê³¼ ê³ ë„ë¥¼ ì‹œê°ì ìœ¼ë¡œ í™•ì¸í•˜ëŠ” ì¸í„°ë™í‹°ë¸Œ ì§€ë„. ì˜¤í”„ë¼ì¸ ì‚¬ìš© ê°€ëŠ¥.">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ì„œìš¸ ê³ ë„ ì§€ë„">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect fill='%234CAF50' width='192' height='192' rx='20'/%3E%3Ctext x='96' y='120' font-size='80' text-anchor='middle'%3EğŸ”ï¸%3C/text%3E%3C/svg%3E">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect fill='%234CAF50' width='64' height='64' rx='10'/%3E%3Ctext x='32' y='46' font-size='36' text-anchor='middle'%3EğŸš´%3C/text%3E%3C/svg%3E">
<title>ì„œìš¸ ìì „ê±° ê³ ë„ ì§€ë„ ğŸš´</title>
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" />
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4PF67VSQGX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-4PF67VSQGX');
</script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Apple SD Gothic Neo','Noto Sans KR',sans-serif}
#map{width:100%;height:100vh}

.top-bar{
  position:absolute;top:0;left:0;right:0;z-index:10;
  background:#fff;padding:10px 14px;
  display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid #e8e8e8;box-shadow:0 1px 4px rgba(0,0,0,0.06);
}
.top-bar h1{font-size:15px;font-weight:700;color:#333}
.top-bar h1 span{font-weight:400;color:#999;font-size:12px}
/* (compare/bottom-sheet CSS removed) */

.ctrl-panel{
  position:absolute;top:52px;left:10px;z-index:10;
  background:#fff;border-radius:10px;padding:8px 12px;
  box-shadow:0 1px 6px rgba(0,0,0,0.1);font-size:11px;color:#666;
  display:none;
}
.ctrl-panel.show{display:block}
.ctrl-panel label{display:flex;align-items:center;gap:6px;margin-bottom:3px;cursor:pointer}
.ctrl-panel input[type="range"]{width:100px}
.ctrl-panel hr{border:none;border-top:1px solid #eee;margin:5px 0}

.legend-bar{
  display:none;
  position:absolute;top:52px;right:10px;z-index:9;
  background:#fff;border-radius:8px;padding:6px 8px;
  box-shadow:0 1px 4px rgba(0,0,0,0.1);font-size:10px;color:#888;
}
.legend-bar.show{display:block}
.legend-bar h4{font-size:11px;color:#555;margin-bottom:3px}
.lg-row{display:flex;align-items:center;margin-bottom:1px}
.lg-c{width:14px;height:8px;border-radius:2px;margin-right:4px}

/* FPS mode removed */


.fab-col{
  position:absolute;right:10px;z-index:10;
  display:flex;flex-direction:column;gap:8px;
}
.fab-col.bot{bottom:130px}
@media(max-width:600px){.fab-col.bot{bottom:100px}}
.fab{
  width:44px;height:44px;border-radius:50%;border:none;
  background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.2);
  font-size:20px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:transform .15s;-webkit-tap-highlight-color:transparent;
}
.fab:active{transform:scale(0.9)}
.fab-locate{width:48px;height:48px;font-size:22px;background:#4285F4;color:#fff;box-shadow:0 2px 10px rgba(66,133,244,0.4)}

.pitch-hint{
  position:absolute;bottom:130px;left:50%;transform:translateX(-50%);z-index:10;
  background:rgba(0,0,0,0.7);color:#fff;border-radius:20px;
  padding:6px 14px;font-size:12px;pointer-events:none;white-space:nowrap;
  opacity:0;transition:opacity .5s;
}
.pitch-hint.show{opacity:1}
</style>
</head>
<body>

<div id="map"></div>

<div class="top-bar">
  <h1>ğŸš´ ì„œìš¸ ì˜¤ë¥´ë§‰ ì§€ë„ <span>ì–¸ë• í”¼í•´ì„œ íƒ€ì</span></h1>
  <span id="offline-indicator" style="display:none;font-size:12px;color:#666;background:#f0f0f0;padding:4px 8px;border-radius:4px;">ğŸ“´ ì˜¤í”„ë¼ì¸ ëª¨ë“œ</span>
</div>

<div class="ctrl-panel" id="layerPanel">
  <strong style="color:#333">ë ˆì´ì–´</strong>
  <hr>
  <label>ë“±ê³ ì„  ì§„í•˜ê¸°</label>
  <input type="range" id="contourOpacity" min="0" max="100" value="75">
  <hr>
  <label><input type="checkbox" id="chk3d" checked> ğŸ”ï¸ 3D ì§€í˜•</label>
  <label><input type="checkbox" id="chkBuildings"> ğŸ¢ 3D ê±´ë¬¼</label>
  <label><input type="checkbox" id="chkContour" checked> ã€°ï¸ ë“±ê³ ì„ </label>
  <label><input type="checkbox" id="chkStation" checked> ğŸš‡ ì—­</label>
  <label><input type="checkbox" id="chkRoute" checked> ğŸŸ¢ ì¶”ì²œê²½ë¡œ</label>
  <label><input type="checkbox" id="chkSlope" checked> ğŸ”º ì˜¤ë¥´ë§‰ ë°©í–¥</label>
</div>

<div class="legend-bar" id="legendBar">
  <h4>ğŸš´ ì§€ë„ ë²”ë¡€</h4>
  <div class="lg-row"><div class="lg-c" style="background:#4CAF50"></div>í‰ì§€ ìì „ê±°ê¸¸</div>
  <div class="lg-row"><div class="lg-c" style="background:#FF9800"></div>ì˜¤ë¥´ë§‰ ì£¼ì˜ êµ¬ê°„</div>
  <div class="lg-row"><div class="lg-c" style="background:#f44336"></div>ê¸‰ê²½ì‚¬ íšŒí”¼ êµ¬ê°„</div>
  <div class="lg-row" style="margin-top:3px;border-top:1px solid #eee;padding-top:3px">
    <span style="margin-right:4px;color:#388E3C">â€º</span> ì™„ë§Œí•œ ì˜¤ë¥´ë§‰
  </div>
  <div class="lg-row">
    <span style="margin-right:4px;color:#E65100">â€ºâ€º</span> ì¤‘ê°„ ì˜¤ë¥´ë§‰
  </div>
  <div class="lg-row">
    <span style="margin-right:4px;color:#C62828">â€ºâ€ºâ€º</span> ê¸‰ê²½ì‚¬ ì˜¤ë¥´ë§‰
  </div>
  <div class="lg-row"><span style="font-size:9px;margin-right:4px">ã€°ï¸</span> ë“±ê³ ì„ </div>
  <div class="lg-row" style="margin-top:3px;border-top:1px solid #eee;padding-top:3px;color:#666" id="legendControlHint">
    ğŸ¤ ë‘ ì†ê°€ë½ íšŒì „/ê¸°ìš¸ì´ê¸°
  </div>
</div>

<div class="fab-col bot">
  <button class="fab" id="btnLegend" title="ë²”ë¡€">ğŸ“‹</button>
  <button class="fab" id="btnLayers" title="ë ˆì´ì–´">ğŸ—ºï¸</button>
  <button class="fab fab-locate" id="btnLocate" title="ë‚´ ìœ„ì¹˜">ğŸ“</button>
  <button class="fab" id="btnReset" title="ì „ì²´ë³´ê¸°">â†º</button>
  <button class="fab" id="btn3dToggle" title="3D/2D ì „í™˜">ğŸ”ï¸</button>
</div>

<div class="pitch-hint" id="pitchHint">ğŸ¤ ë‘ ì†ê°€ë½ìœ¼ë¡œ íšŒì „ &amp; ê¸°ìš¸ì´ê¸°</div>

<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
<script>
const DEFAULT_LOC = [127.0448, 37.5104]; // ì„ ì •ë¦‰ì—­ [lng, lat]
const SEOUL_CENTER = [126.9780, 37.5665];
const IS_MOBILE = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
const PERF_DEBUG = new URLSearchParams(window.location.search).get('perf') === '1';
const TERRAIN_EXAGGERATION = IS_MOBILE ? 3.4 : 4.0;
const FONT_STACK = ['Open Sans Bold'];

const PERF_BUDGETS = Object.freeze({
  startupMsDesktop: 2000,
  startupMsMobile: 3500,
  contourTileMsDesktop: 40,
  contourTileMsMobile: 90,
  panFpsDesktop: 50,
  panFpsMobile: 35
});

function detectDeviceProfile() {
  const mem = navigator.deviceMemory || (IS_MOBILE ? 2 : 4);
  const cores = navigator.hardwareConcurrency || 4;
  if (IS_MOBILE && (mem <= 3 || cores <= 4)) return 'low';
  if (mem >= 8 && cores >= 8 && !IS_MOBILE) return 'high';
  return 'medium';
}

const DEVICE_PROFILE = detectDeviceProfile();
const CONTOUR_CONFIG_BY_PROFILE = {
  low: {
    overzoom: 0,
    thresholds: { 11: [100], 12: [50], 13: [20, 100], 14: [20, 100], 15: [10, 50] }
  },
  medium: {
    overzoom: 1,
    thresholds: { 11: [50], 12: [20, 100], 13: [10, 50], 14: [10, 50], 15: [5, 20] }
  },
  high: {
    overzoom: 1,
    thresholds: { 11: [50], 12: [20, 100], 13: [10, 50], 14: [5, 20], 15: [5, 10, 20] }
  }
};
const CONTOUR_CONFIG = CONTOUR_CONFIG_BY_PROFILE[DEVICE_PROFILE];

const PERF_METRICS = {
  navStart: performance.timeOrigin || Date.now(),
  firstInteractionLatencyMs: null,
  startupMs: null,
  contourTileSampleCount: 0,
  contourTileTotalMs: 0,
  contourTileAvgMs: null,
  panSampleCount: 0,
  panFpsAvg: null,
  cacheHits: 0,
  cacheMisses: 0,
  cacheHitRate: null,
  memoryUsedMb: null,
  lastReportReason: null
};

window.__seoulMapPerf = {
  enabled: PERF_DEBUG,
  budgets: PERF_BUDGETS,
  deviceProfile: DEVICE_PROFILE,
  metrics: PERF_METRICS
};

const contourTileStarts = new Map();
function tileCoordKey(coord) {
  if (!coord || !coord.canonical) return null;
  const c = coord.canonical;
  return `${c.z}/${c.x}/${c.y}`;
}

function getHeapUsedMb() {
  const heap = performance.memory?.usedJSHeapSize;
  return heap ? +(heap / (1024 * 1024)).toFixed(1) : null;
}

function summarizeBudgets() {
  const startupBudget = IS_MOBILE ? PERF_BUDGETS.startupMsMobile : PERF_BUDGETS.startupMsDesktop;
  const contourBudget = IS_MOBILE ? PERF_BUDGETS.contourTileMsMobile : PERF_BUDGETS.contourTileMsDesktop;
  const fpsBudget = IS_MOBILE ? PERF_BUDGETS.panFpsMobile : PERF_BUDGETS.panFpsDesktop;
  return {
    startup: PERF_METRICS.startupMs == null ? 'pending' : (PERF_METRICS.startupMs <= startupBudget ? 'pass' : 'fail'),
    contour: PERF_METRICS.contourTileAvgMs == null ? 'pending' : (PERF_METRICS.contourTileAvgMs <= contourBudget ? 'pass' : 'fail'),
    fps: PERF_METRICS.panFpsAvg == null ? 'pending' : (PERF_METRICS.panFpsAvg >= fpsBudget ? 'pass' : 'fail')
  };
}

function reportPerf(reason = 'manual') {
  PERF_METRICS.memoryUsedMb = getHeapUsedMb();
  PERF_METRICS.lastReportReason = reason;
  const budgetStatus = summarizeBudgets();
  console.table({
    profile: DEVICE_PROFILE,
    startupMs: PERF_METRICS.startupMs,
    firstInteractionLatencyMs: PERF_METRICS.firstInteractionLatencyMs,
    contourTileAvgMs: PERF_METRICS.contourTileAvgMs,
    panFpsAvg: PERF_METRICS.panFpsAvg,
    cacheHitRate: PERF_METRICS.cacheHitRate,
    memoryUsedMb: PERF_METRICS.memoryUsedMb,
    budgetStartup: budgetStatus.startup,
    budgetContour: budgetStatus.contour,
    budgetFps: budgetStatus.fps,
    reportReason: reason
  });
}

window.__seoulMapPerf.report = reportPerf;
if (PERF_DEBUG) {
  setInterval(() => reportPerf('interval'), 45000);
}

function scheduleIdleTask(fn, timeout = 2500) {
  if ('requestIdleCallback' in window) {
    requestIdleCallback(fn, { timeout });
    return;
  }
  setTimeout(fn, 0);
}

function createRafValueApplier(applyValue) {
  let rafId = null;
  let pendingValue = null;
  return (value) => {
    pendingValue = value;
    if (rafId !== null) return;
    rafId = requestAnimationFrame(() => {
      rafId = null;
      applyValue(pendingValue);
    });
  };
}

function setLayerVisibility(mapInstance, layerIds, visible) {
  const value = visible ? 'visible' : 'none';
  layerIds.forEach((layerId) => {
    if (mapInstance.getLayer(layerId)) {
      mapInstance.setLayoutProperty(layerId, 'visibility', value);
    }
  });
}

let contourLibPromise = null;
function loadContourLibrary() {
  if (window.mlcontour) return Promise.resolve(window.mlcontour);
  if (contourLibPromise) return contourLibPromise;
  contourLibPromise = new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/maplibre-contour@0.0.7/dist/index.min.js';
    script.async = true;
    script.onload = () => resolve(window.mlcontour);
    script.onerror = () => reject(new Error('Failed to load maplibre-contour'));
    document.head.appendChild(script);
  });
  return contourLibPromise;
}

// ===== Map (base only â€” contours added after load) =====
const map = new maplibregl.Map({
  container: 'map',
  style: {
    version: 8,
    glyphs: 'https://fonts.openmaptiles.org/{fontstack}/{range}.pbf',
    sources: {
      'carto': {
        type: 'raster',
        tiles: [IS_MOBILE
          ? 'https://a.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png'
          : 'https://a.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}@2x.png'],
        tileSize: 256,
        attribution: 'Â© CARTO Â· Â© OSM'
      },
      'hillshade-tiles': {
        type: 'raster',
        tiles: ['https://tiles.wmflabs.org/hillshading/{z}/{x}/{y}.png'],
        tileSize: 256
      },
      'terrain-dem': {
        type: 'raster-dem',
        tiles: ['https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png'],
        tileSize: 256,
        encoding: 'terrarium'
      }
    },
    layers: [
      { id: 'base', type: 'raster', source: 'carto' }
    ],
    terrain: { source: 'terrain-dem', exaggeration: TERRAIN_EXAGGERATION }
  },
  center: DEFAULT_LOC,
  zoom: 14,
  pitch: 40,
  bearing: 0,
  maxPitch: IS_MOBILE ? 65 : 70,
  touchPitch: true,
  dragRotate: true,
  touchZoomRotate: true,
  refreshExpiredTiles: false,
  fadeDuration: IS_MOBILE ? 120 : 250
});

map.once('load', () => {
  PERF_METRICS.startupMs = Math.round(performance.now());
  if (PERF_DEBUG) reportPerf('map-load');
});

let firstInteractionCaptured = false;
const captureFirstInteraction = () => {
  if (firstInteractionCaptured) return;
  firstInteractionCaptured = true;
  PERF_METRICS.firstInteractionLatencyMs = Math.round(performance.now());
};
['pointerdown', 'keydown', 'touchstart'].forEach((evtName) => {
  window.addEventListener(evtName, captureFirstInteraction, { passive: true, once: true });
});

if (PERF_DEBUG) {
  let panFrameCount = 0;
  let panStartAt = null;
  map.on('movestart', () => {
    panFrameCount = 0;
    panStartAt = performance.now();
  });
  map.on('render', () => {
    if (!panStartAt || !map.isMoving()) return;
    panFrameCount += 1;
  });
  map.on('moveend', () => {
    if (!panStartAt) return;
    const durationMs = performance.now() - panStartAt;
    panStartAt = null;
    if (durationMs < 300 || panFrameCount === 0) return;
    const fps = +(panFrameCount / (durationMs / 1000)).toFixed(1);
    PERF_METRICS.panSampleCount += 1;
    PERF_METRICS.panFpsAvg = PERF_METRICS.panFpsAvg == null
      ? fps
      : +(((PERF_METRICS.panFpsAvg * (PERF_METRICS.panSampleCount - 1)) + fps) / PERF_METRICS.panSampleCount).toFixed(1);
  });

  map.on('dataloading', (event) => {
    if (event.sourceId !== 'contour-source') return;
    const key = tileCoordKey(event.coord);
    if (!key) return;
    contourTileStarts.set(key, performance.now());
  });
  map.on('sourcedata', (event) => {
    if (event.sourceId !== 'contour-source') return;
    const key = tileCoordKey(event.coord);
    if (!key) return;
    const startedAt = contourTileStarts.get(key);
    if (!startedAt) return;
    contourTileStarts.delete(key);
    const elapsed = performance.now() - startedAt;
    PERF_METRICS.contourTileSampleCount += 1;
    PERF_METRICS.contourTileTotalMs += elapsed;
    PERF_METRICS.contourTileAvgMs = +(
      PERF_METRICS.contourTileTotalMs / PERF_METRICS.contourTileSampleCount
    ).toFixed(1);
  });
}

if (PERF_DEBUG && 'serviceWorker' in navigator) {
  navigator.serviceWorker.addEventListener('message', (event) => {
    if (event.data?.type !== 'sw-cache-stats') return;
    PERF_METRICS.cacheHits = event.data.hits || 0;
    PERF_METRICS.cacheMisses = event.data.misses || 0;
    const total = PERF_METRICS.cacheHits + PERF_METRICS.cacheMisses;
    PERF_METRICS.cacheHitRate = total ? +((PERF_METRICS.cacheHits / total) * 100).toFixed(1) : null;
  });
}

// Hillshade only on desktop (redundant with 3D terrain on mobile, saves GPU)
if (!IS_MOBILE) {
  map.on('load', () => {
    if (!map.getLayer('hill-overlay')) {
      map.addLayer({ id: 'hill-overlay', type: 'raster', source: 'hillshade-tiles', paint: { 'raster-opacity': 0.5 } }, map.getStyle().layers[1]?.id);
    }
  });
}

// Nav controls
map.addControl(new maplibregl.NavigationControl({ showCompass: true, showZoom: true }), 'bottom-left');

// ê¸°ê¸°ë³„ ì¡°ì‘ë²• íŒíŠ¸ í…ìŠ¤íŠ¸ ì„¤ì •
const controlHintText = IS_MOBILE
  ? 'ğŸ¤ ë‘ ì†ê°€ë½ íšŒì „ / ê¸°ìš¸ì´ê¸°'
  : 'âŒ¨ï¸ WASD: ì´ë™ &nbsp;|&nbsp; Space/Shift: ìƒìŠ¹Â·í•˜ê°• &nbsp;|&nbsp; ìš°í´ë¦­: íšŒì „';

document.getElementById('pitchHint').innerHTML = controlHintText;
const legendHint = document.getElementById('legendControlHint');
if (legendHint) legendHint.innerHTML = controlHintText;

// Show pitch hint on first load
setTimeout(() => {
  const h = document.getElementById('pitchHint');
  h.classList.add('show');
  setTimeout(() => h.classList.remove('show'), 4000);
}, 2000);

let contourInitialized = false;
let contourInitInFlight = false;
async function initContourLayers() {
  if (contourInitialized || contourInitInFlight) return;
  contourInitInFlight = true;
  const contourInitStartedAt = performance.now();
  try {
    const mlcontour = await loadContourLibrary();
    if (!mlcontour?.DemSource) throw new Error('maplibre-contour unavailable');
    const demSource = new mlcontour.DemSource({
      url: 'https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png',
      encoding: 'terrarium',
      maxzoom: 13,
      worker: true
    });
    demSource.setupMaplibre(maplibregl);

    map.addSource('contour-source', {
      type: 'vector',
      tiles: [demSource.contourProtocolUrl({
        multiplier: 1,
        overzoom: CONTOUR_CONFIG.overzoom,
        thresholds: CONTOUR_CONFIG.thresholds,
        elevationKey: 'ele',
        levelKey: 'level',
        contourLayer: 'contours'
      })],
      minzoom: 11,
      maxzoom: 15
    });
    map.addLayer({
      id: 'contour-lines', type: 'line', source: 'contour-source', 'source-layer': 'contours',
      filter: ['==', ['get','level'], 0],
      minzoom: 11,
      paint: { 'line-color': 'rgba(56, 142, 60, 0.5)', 'line-width': 1.2 }
    });
    map.addLayer({
      id: 'contour-lines-major', type: 'line', source: 'contour-source', 'source-layer': 'contours',
      filter: ['==', ['get','level'], 1],
      minzoom: 12,
      paint: { 'line-color': 'rgba(46, 125, 50, 0.8)', 'line-width': 2.5 }
    });
    contourInitialized = true;
    const contourVisible = document.getElementById('chkContour')?.checked ?? true;
    setLayerVisibility(map, ['contour-lines', 'contour-lines-major'], contourVisible);
    const sliderValue = Number(document.getElementById('contourOpacity')?.value ?? 75) / 100;
    if (map.getLayer('contour-lines')) map.setPaintProperty('contour-lines', 'line-opacity', sliderValue);
    if (map.getLayer('contour-lines-major')) map.setPaintProperty('contour-lines-major', 'line-opacity', sliderValue);
    if (PERF_DEBUG) {
      PERF_METRICS.contourInitMs = +(performance.now() - contourInitStartedAt).toFixed(1);
    }
  } catch (err) {
    console.warn('Contour init failed:', err);
  } finally {
    contourInitInFlight = false;
  }
}

const dynamicLayerRules = [
  { id: 'hill-overlay', minZoom: 12, maxPitch: 58 },
  { id: 'elevation-color-overlay', minZoom: 12, maxPitch: 62 },
  { id: 'local-max-label', minZoom: 13.2, maxPitch: 60 },
  { id: 'peak-label', minZoom: 13.5, maxPitch: 60 }
];
const dynamicLayerVisibilityState = new Map();
const scheduleDynamicVisibility = createRafValueApplier(() => {
  const zoom = map.getZoom();
  const pitch = map.getPitch();
  dynamicLayerRules.forEach((rule) => {
    if (!map.getLayer(rule.id)) return;
    const shouldBeVisible = zoom >= rule.minZoom && pitch <= rule.maxPitch;
    const previous = dynamicLayerVisibilityState.get(rule.id);
    if (previous === shouldBeVisible) return;
    dynamicLayerVisibilityState.set(rule.id, shouldBeVisible);
    setLayerVisibility(map, [rule.id], shouldBeVisible);
  });
});
['moveend', 'zoomend', 'pitchend', 'rotateend'].forEach((evtName) => {
  map.on(evtName, () => scheduleDynamicVisibility(0));
});

// ===== GeoJSON sources for overlays =====
map.on('load', () => {
  scheduleIdleTask(() => initContourLayers(), IS_MOBILE ? 5000 : 3000);

  // --- 3D Buildings (Apple Maps-like tone) ---
  // OpenFreeMap building layer exposes render_height / render_min_height.
  map.addSource('openfreemap-v', {
    type: 'vector',
    url: 'https://tiles.openfreemap.org/planet'
  });
  map.addLayer({
    id: 'buildings-3d',
    type: 'fill-extrusion',
    source: 'openfreemap-v',
    'source-layer': 'building',
    minzoom: 13.5,
    filter: ['!=', ['coalesce', ['get', 'hide_3d'], false], true],
    layout: { 'visibility': 'none' },
    paint: {
      'fill-extrusion-color': [
        'interpolate', ['linear'], ['coalesce', ['get', 'render_height'], 0],
        0, '#dfe6ef',
        30, '#d3dde8',
        80, '#c3d0de',
        180, '#aebfd0'
      ],
      'fill-extrusion-height': ['min', ['max', ['*', ['coalesce', ['get', 'render_height'], 0], 1.15], 8], 220],
      'fill-extrusion-base': ['*', ['coalesce', ['get', 'render_min_height'], 0], 1.15],
      'fill-extrusion-opacity': 0.98,
      'fill-extrusion-vertical-gradient': true
    }
  });
  map.addLayer({
    id: 'buildings-3d-outline',
    type: 'line',
    source: 'openfreemap-v',
    'source-layer': 'building',
    minzoom: 14,
    filter: ['!=', ['coalesce', ['get', 'hide_3d'], false], true],
    layout: { 'visibility': 'none' },
    paint: {
      'line-color': 'rgba(120,138,160,0.55)',
      'line-width': 1.1
    }
  });

  // Hypsometric tint - elevation coloring using hillshade
  map.addLayer({
    id: 'elevation-color-overlay',
    type: 'hillshade',
    source: 'terrain-dem',
    paint: {
      'hillshade-shadow-color': 'rgba(255,200,100,0.2)',
      'hillshade-highlight-color': 'rgba(255,100,100,0.15)',
      'hillshade-accent-color': 'rgba(200,50,50,0.25)',
      'hillshade-exaggeration': DEVICE_PROFILE === 'low' ? 0.55 : 0.8
    },
    layout: { 'visibility': 'visible' }
  });

  const initSecondaryOverlays = () => {
  // --- Flat routes ---
  const flatRoutes = [
    { name: 'íƒ„ì²œ ìì „ê±°ê¸¸', coords: [[127.0946,37.5145],[127.0920,37.5100],[127.0870,37.5040],[127.0810,37.4970],[127.0770,37.4910],[127.0730,37.4850],[127.0680,37.4780],[127.0640,37.4720],[127.0610,37.4665]] },
    { name: 'ì–‘ì¬ì²œ ìì „ê±°ê¸¸', coords: [[127.0352,37.4842],[127.0420,37.4835],[127.0490,37.4830],[127.0560,37.4828],[127.0630,37.4825],[127.0700,37.4822],[127.0750,37.4820]] },
    { name: 'í•œê°• ìì „ê±°ê¸¸', coords: [[127.0100,37.5240],[127.0200,37.5250],[127.0300,37.5260],[127.0400,37.5270],[127.0500,37.5265],[127.0600,37.5260],[127.0700,37.5255],[127.0800,37.5250],[127.0900,37.5245],[127.1000,37.5240]] },
    { name: 'í…Œí—¤ë€ë¡œ', coords: [[127.0276,37.4979],[127.0330,37.4990],[127.0366,37.5007],[127.0420,37.5025],[127.0490,37.5045],[127.0560,37.5065],[127.0639,37.5088]] },
  ];
  const routeFeatures = flatRoutes.map(r => ({
    type: 'Feature', properties: { name: r.name },
    geometry: { type: 'LineString', coordinates: r.coords }
  }));

  map.addSource('flat-routes', { type: 'geojson', data: { type: 'FeatureCollection', features: routeFeatures } });
  map.addLayer({ id: 'flat-routes-line', type: 'line', source: 'flat-routes',
    paint: { 'line-color': '#4CAF50', 'line-width': 5, 'line-opacity': 0.7 },
    layout: { 'line-cap': 'round', 'line-join': 'round' }
  });
  map.addLayer({ id: 'flat-routes-label', type: 'symbol', source: 'flat-routes',
    layout: { 'symbol-placement': 'line-center', 'text-field': ['concat', 'ğŸŸ¢ ', ['get', 'name']],
      'text-size': 11, 'text-font': FONT_STACK
    },
    paint: { 'text-color': '#1B5E20', 'text-halo-color': '#fff', 'text-halo-width': 2 }
  });

  // --- Caution zones ---
  const cautionZones = [
    { name: 'ëŒ€ëª¨ì‚°Â·êµ¬ë£¡ì‚°', center: [127.073,37.476], radius: 600, steep: true },
    { name: 'ë§¤ë´‰ì‚°', center: [127.040,37.489], radius: 350, steep: false },
    { name: 'ìš°ë©´ì‚°', center: [127.010,37.478], radius: 450, steep: true },
    { name: 'ì„¸ê³¡ë™ êµ¬ë¦‰', center: [127.070,37.468], radius: 400, steep: false },
  ];
  // Approximate circles as polygons
  function makeCircle(c, r, n=32) {
    const coords = [];
    for (let i=0;i<=n;i++) {
      const a = (i/n)*2*Math.PI;
      const dlat = (r/111320)*Math.cos(a);
      const dlng = (r/(111320*Math.cos(c[1]*Math.PI/180)))*Math.sin(a);
      coords.push([c[0]+dlng, c[1]+dlat]);
    }
    return coords;
  }
  const cautionFeatures = cautionZones.map(z => ({
    type: 'Feature',
    properties: { name: z.name, steep: z.steep },
    geometry: { type: 'Polygon', coordinates: [makeCircle(z.center, z.radius)] }
  }));
  map.addSource('caution-zones', { type: 'geojson', data: { type: 'FeatureCollection', features: cautionFeatures } });
  map.addLayer({ id: 'caution-fill', type: 'fill', source: 'caution-zones',
    paint: { 'fill-color': ['case', ['get','steep'], '#f44336', '#FF9800'], 'fill-opacity': 0.12 }
  });
  map.addLayer({ id: 'caution-border', type: 'line', source: 'caution-zones',
    paint: { 'line-color': ['case', ['get','steep'], '#f44336', '#FF9800'], 'line-width': 2, 'line-dasharray': [4,3] }
  });
  map.addLayer({ id: 'caution-label', type: 'symbol', source: 'caution-zones',
    layout: { 'text-field': ['concat', ['case',['get','steep'],'ğŸ”´','ğŸŸ '], ' ', ['get','name']],
      'text-size': 11, 'text-font': FONT_STACK
    },
    paint: { 'text-color': ['case',['get','steep'],'#C62828','#E65100'], 'text-halo-color': '#fff', 'text-halo-width': 2 }
  });

  // --- Stations ---
  const stations = [
    // â”€â”€ 1í˜¸ì„  #0052A4 â”€â”€
    {n:'ë„ë´‰',la:37.6826,lo:127.0441,c:'#0052A4',l:'1'},
    {n:'ë°©í•™',la:37.6567,lo:127.0372,c:'#0052A4',l:'1'},
    {n:'ì°½ë™',la:37.6529,lo:127.0472,c:'#0052A4',l:'1'},
    {n:'ê´‘ìš´ëŒ€',la:37.6226,lo:127.0579,c:'#0052A4',l:'1'},
    {n:'ì™¸ëŒ€ì•',la:37.5961,lo:127.0592,c:'#0052A4',l:'1'},
    {n:'íšŒê¸°',la:37.5900,lo:127.0564,c:'#0052A4',l:'1'},
    {n:'ì²­ëŸ‰ë¦¬',la:37.5803,lo:127.0471,c:'#0052A4',l:'1'},
    {n:'ì œê¸°ë™',la:37.5846,lo:127.0368,c:'#0052A4',l:'1'},
    {n:'ì‹ ì„¤ë™',la:37.5764,lo:127.0295,c:'#0052A4',l:'1'},
    {n:'ë™ë¬˜ì•',la:37.5742,lo:127.0175,c:'#0052A4',l:'1'},
    {n:'ë™ëŒ€ë¬¸',la:37.5713,lo:127.0097,c:'#0052A4',l:'1'},
    {n:'ì¢…ë¡œ5ê°€',la:37.5712,lo:127.0003,c:'#0052A4',l:'1'},
    {n:'ì¢…ë¡œ3ê°€',la:37.5711,lo:126.9918,c:'#0052A4',l:'1'},
    {n:'ì¢…ê°',la:37.5700,lo:126.9826,c:'#0052A4',l:'1'},
    {n:'ì‹œì²­',la:37.5657,lo:126.9770,c:'#0052A4',l:'1'},
    {n:'ì„œìš¸ì—­',la:37.5546,lo:126.9726,c:'#0052A4',l:'1'},
    {n:'ë‚¨ì˜',la:37.5414,lo:126.9717,c:'#0052A4',l:'1'},
    {n:'ìš©ì‚°',la:37.5298,lo:126.9646,c:'#0052A4',l:'1'},
    {n:'ë…¸ëŸ‰ì§„',la:37.5133,lo:126.9419,c:'#0052A4',l:'1'},
    {n:'ëŒ€ë°©',la:37.5028,lo:126.9290,c:'#0052A4',l:'1'},
    {n:'ì‹ ë„ë¦¼',la:37.5083,lo:126.8912,c:'#0052A4',l:'1'},
    {n:'êµ¬ë¡œ',la:37.5025,lo:126.8818,c:'#0052A4',l:'1'},
    // â”€â”€ 2í˜¸ì„  #009246 â”€â”€
    {n:'í™ëŒ€ì…êµ¬',la:37.5573,lo:126.9244,c:'#009246',l:'2'},
    {n:'í•©ì •',la:37.5495,lo:126.9141,c:'#009246',l:'2'},
    {n:'ë‹¹ì‚°',la:37.5336,lo:126.9010,c:'#009246',l:'2'},
    {n:'ì˜ë“±í¬êµ¬ì²­',la:37.5256,lo:126.8964,c:'#009246',l:'2'},
    {n:'ë¬¸ë˜',la:37.5179,lo:126.8960,c:'#009246',l:'2'},
    {n:'êµ¬ë¡œë””ì§€í„¸ë‹¨ì§€',la:37.4855,lo:126.9011,c:'#009246',l:'2'},
    {n:'ëŒ€ë¦¼',la:37.4913,lo:126.9005,c:'#009246',l:'2'},
    {n:'ì‹ ë¦¼',la:37.4847,lo:126.9294,c:'#009246',l:'2'},
    {n:'ì„œìš¸ëŒ€ì…êµ¬',la:37.4812,lo:126.9526,c:'#009246',l:'2'},
    {n:'ë‚™ì„±ëŒ€',la:37.4780,lo:126.9637,c:'#009246',l:'2'},
    {n:'ì‚¬ë‹¹',la:37.4762,lo:126.9817,c:'#009246',l:'2'},
    {n:'ë°©ë°°',la:37.4808,lo:126.9977,c:'#009246',l:'2'},
    {n:'ì„œì´ˆ',la:37.4836,lo:127.0101,c:'#009246',l:'2'},
    {n:'êµëŒ€',la:37.4934,lo:127.0146,c:'#009246',l:'2'},
    {n:'ê°•ë‚¨',la:37.4979,lo:127.0276,c:'#009246',l:'2'},
    {n:'ì—­ì‚¼',la:37.5007,lo:127.0366,c:'#009246',l:'2'},
    {n:'ì„ ë¦‰',la:37.5045,lo:127.0490,c:'#009246',l:'2'},
    {n:'ì‚¼ì„±',la:37.5088,lo:127.0639,c:'#009246',l:'2'},
    {n:'ì¢…í•©ìš´ë™ì¥',la:37.5107,lo:127.0736,c:'#009246',l:'2'},
    {n:'ì ì‹¤ìƒˆë‚´',la:37.5097,lo:127.0899,c:'#009246',l:'2'},
    {n:'ì ì‹¤',la:37.5131,lo:127.1000,c:'#009246',l:'2'},
    {n:'ì‹ ì²œ',la:37.5174,lo:127.1001,c:'#009246',l:'2'},
    {n:'ê°•ë³€',la:37.5353,lo:127.1003,c:'#009246',l:'2'},
    {n:'êµ¬ì˜',la:37.5374,lo:127.0930,c:'#009246',l:'2'},
    {n:'ê±´ëŒ€ì…êµ¬',la:37.5401,lo:127.0697,c:'#009246',l:'2'},
    {n:'ì„±ìˆ˜',la:37.5446,lo:127.0558,c:'#009246',l:'2'},
    {n:'ëšì„¬',la:37.5472,lo:127.0476,c:'#009246',l:'2'},
    {n:'í•œì–‘ëŒ€',la:37.5555,lo:127.0446,c:'#009246',l:'2'},
    {n:'ì™•ì‹­ë¦¬',la:37.5612,lo:127.0368,c:'#009246',l:'2'},
    {n:'ìƒì™•ì‹­ë¦¬',la:37.5612,lo:127.0285,c:'#009246',l:'2'},
    {n:'ì‹ ë‹¹',la:37.5655,lo:127.0190,c:'#009246',l:'2'},
    {n:'ë™ëŒ€ë¬¸ì—­ì‚¬ë¬¸í™”ê³µì›',la:37.5648,lo:127.0094,c:'#009246',l:'2'},
    {n:'ì„ì§€ë¡œ4ê°€',la:37.5669,lo:127.0002,c:'#009246',l:'2'},
    {n:'ì„ì§€ë¡œ3ê°€',la:37.5659,lo:126.9924,c:'#009246',l:'2'},
    {n:'ì„ì§€ë¡œì…êµ¬',la:37.5664,lo:126.9822,c:'#009246',l:'2'},
    // â”€â”€ 3í˜¸ì„  #EF7C1C â”€â”€
    {n:'ìˆ˜ì„œ',la:37.4872,lo:127.1017,c:'#EF7C1C',l:'3'},
    {n:'ì¼ì›',la:37.4836,lo:127.0867,c:'#EF7C1C',l:'3'},
    {n:'ëŒ€ì²­',la:37.4920,lo:127.0744,c:'#EF7C1C',l:'3'},
    {n:'í•™ì—¬ìš¸',la:37.4965,lo:127.0648,c:'#EF7C1C',l:'3'},
    {n:'ëŒ€ì¹˜',la:37.4948,lo:127.0577,c:'#EF7C1C',l:'3'},
    {n:'ë„ê³¡',la:37.4915,lo:127.0455,c:'#EF7C1C',l:'3'},
    {n:'ë§¤ë´‰',la:37.4874,lo:127.0347,c:'#EF7C1C',l:'3'},
    {n:'ë‚¨ë¶€í„°ë¯¸ë„',la:37.4855,lo:127.0163,c:'#EF7C1C',l:'3'},
    {n:'ê³ ì†í„°ë¯¸ë„',la:37.5047,lo:127.0048,c:'#EF7C1C',l:'3'},
    {n:'ì ì›',la:37.5125,lo:127.0013,c:'#EF7C1C',l:'3'},
    {n:'ì‹ ì‚¬',la:37.5164,lo:127.0203,c:'#EF7C1C',l:'3'},
    {n:'ì••êµ¬ì •',la:37.5270,lo:127.0286,c:'#EF7C1C',l:'3'},
    {n:'ì˜¥ìˆ˜',la:37.5467,lo:127.0180,c:'#EF7C1C',l:'3'},
    {n:'ê¸ˆí˜¸',la:37.5520,lo:127.0196,c:'#EF7C1C',l:'3'},
    {n:'ì•½ìˆ˜',la:37.5559,lo:127.0147,c:'#EF7C1C',l:'3'},
    {n:'ë™ëŒ€ì…êµ¬',la:37.5578,lo:127.0046,c:'#EF7C1C',l:'3'},
    {n:'ì¶©ë¬´ë¡œ',la:37.5618,lo:126.9944,c:'#EF7C1C',l:'3'},
    {n:'ì•ˆêµ­',la:37.5783,lo:126.9848,c:'#EF7C1C',l:'3'},
    {n:'ê²½ë³µê¶',la:37.5811,lo:126.9767,c:'#EF7C1C',l:'3'},
    {n:'ë…ë¦½ë¬¸',la:37.5746,lo:126.9590,c:'#EF7C1C',l:'3'},
    {n:'ë¬´ì•…ì¬',la:37.5782,lo:126.9432,c:'#EF7C1C',l:'3'},
    {n:'í™ì œ',la:37.5849,lo:126.9336,c:'#EF7C1C',l:'3'},
    {n:'ë¶ˆê´‘',la:37.6074,lo:126.9293,c:'#EF7C1C',l:'3'},
    {n:'ì—°ì‹ ë‚´',la:37.6188,lo:126.9195,c:'#EF7C1C',l:'3'},
    {n:'êµ¬íŒŒë°œ',la:37.6365,lo:126.9196,c:'#EF7C1C',l:'3'},
    // â”€â”€ 4í˜¸ì„  #00A5DE â”€â”€
    {n:'ë…¸ì›',la:37.6556,lo:127.0567,c:'#00A5DE',l:'4'},
    {n:'ìŒë¬¸',la:37.6482,lo:127.0349,c:'#00A5DE',l:'4'},
    {n:'ìˆ˜ìœ ',la:37.6383,lo:127.0256,c:'#00A5DE',l:'4'},
    {n:'ë¯¸ì•„ì‚¬ê±°ë¦¬',la:37.6152,lo:127.0291,c:'#00A5DE',l:'4'},
    {n:'ê¸¸ìŒ',la:37.6032,lo:127.0205,c:'#00A5DE',l:'4'},
    {n:'ì„±ì‹ ì—¬ëŒ€ì…êµ¬',la:37.5927,lo:127.0162,c:'#00A5DE',l:'4'},
    {n:'í•œì„±ëŒ€ì…êµ¬',la:37.5887,lo:127.0072,c:'#00A5DE',l:'4'},
    {n:'í˜œí™”',la:37.5823,lo:127.0016,c:'#00A5DE',l:'4'},
    {n:'ëª…ë™',la:37.5608,lo:126.9868,c:'#00A5DE',l:'4'},
    {n:'íšŒí˜„',la:37.5567,lo:126.9777,c:'#00A5DE',l:'4'},
    {n:'ìˆ™ëŒ€ì…êµ¬',la:37.5402,lo:126.9724,c:'#00A5DE',l:'4'},
    {n:'ì‚¼ê°ì§€',la:37.5359,lo:126.9739,c:'#00A5DE',l:'4'},
    {n:'ì‹ ìš©ì‚°',la:37.5299,lo:126.9649,c:'#00A5DE',l:'4'},
    {n:'ì´ì´Œ',la:37.5225,lo:126.9712,c:'#00A5DE',l:'4'},
    {n:'ë™ì‘',la:37.5080,lo:126.9805,c:'#00A5DE',l:'4'},
    {n:'ì´ì‹ ëŒ€ì…êµ¬',la:37.4942,lo:126.9777,c:'#00A5DE',l:'4'},
    // â”€â”€ 5í˜¸ì„  #996CAC â”€â”€
    {n:'ì—¬ì˜ë„',la:37.5217,lo:126.9241,c:'#996CAC',l:'5'},
    {n:'ì—¬ì˜ë‚˜ë£¨',la:37.5268,lo:126.9325,c:'#996CAC',l:'5'},
    {n:'ë§ˆí¬',la:37.5395,lo:126.9503,c:'#996CAC',l:'5'},
    {n:'ì• ì˜¤ê°œ',la:37.5461,lo:126.9569,c:'#996CAC',l:'5'},
    {n:'ì¶©ì •ë¡œ',la:37.5537,lo:126.9647,c:'#996CAC',l:'5'},
    {n:'ê´‘í™”ë¬¸',la:37.5720,lo:126.9768,c:'#996CAC',l:'5'},
    {n:'ì²­êµ¬',la:37.5616,lo:127.0218,c:'#996CAC',l:'5'},
    {n:'ë§ˆì¥',la:37.5665,lo:127.0486,c:'#996CAC',l:'5'},
    {n:'ë‹µì‹­ë¦¬',la:37.5659,lo:127.0571,c:'#996CAC',l:'5'},
    {n:'ì¥í•œí‰',la:37.5662,lo:127.0722,c:'#996CAC',l:'5'},
    {n:'êµ°ì',la:37.5588,lo:127.0795,c:'#996CAC',l:'5'},
    {n:'ì•„ì°¨ì‚°',la:37.5537,lo:127.0871,c:'#996CAC',l:'5'},
    {n:'ê´‘ë‚˜ë£¨',la:37.5488,lo:127.0970,c:'#996CAC',l:'5'},
    {n:'ì²œí˜¸',la:37.5387,lo:127.1236,c:'#996CAC',l:'5'},
    {n:'ê°•ë™',la:37.5300,lo:127.1347,c:'#996CAC',l:'5'},
    {n:'ê¸¸ë™',la:37.5311,lo:127.1464,c:'#996CAC',l:'5'},
    {n:'ëª…ì¼',la:37.5347,lo:127.1680,c:'#996CAC',l:'5'},
    // â”€â”€ 6í˜¸ì„  #CD7C2F â”€â”€
    {n:'ì´íƒœì›',la:37.5347,lo:126.9943,c:'#CD7C2F',l:'6'},
    {n:'í•œê°•ì§„',la:37.5293,lo:126.9965,c:'#CD7C2F',l:'6'},
    {n:'ë…¹ì‚¬í‰',la:37.5323,lo:126.9875,c:'#CD7C2F',l:'6'},
    {n:'ë²„í‹°ê³ ê°œ',la:37.5534,lo:127.0046,c:'#CD7C2F',l:'6'},
    {n:'ìƒìˆ˜',la:37.5494,lo:126.9219,c:'#CD7C2F',l:'6'},
    {n:'ë§ì›',la:37.5553,lo:126.9092,c:'#CD7C2F',l:'6'},
    {n:'ì›”ë“œì»µê²½ê¸°ì¥',la:37.5680,lo:126.8972,c:'#CD7C2F',l:'6'},
    {n:'ë””ì§€í„¸ë¯¸ë””ì–´ì‹œí‹°',la:37.5760,lo:126.8910,c:'#CD7C2F',l:'6'},
    {n:'ì‘ì•”',la:37.5949,lo:126.9119,c:'#CD7C2F',l:'6'},
    {n:'ë…ë°”ìœ„',la:37.6082,lo:126.9301,c:'#CD7C2F',l:'6'},
    // â”€â”€ 7í˜¸ì„  #747F00 â”€â”€
    {n:'ê°•ë‚¨êµ¬ì²­',la:37.5173,lo:127.0413,c:'#747F00',l:'7'},
    {n:'ì²­ë‹´',la:37.5196,lo:127.0539,c:'#747F00',l:'7'},
    {n:'ë…¼í˜„',la:37.5113,lo:127.0215,c:'#747F00',l:'7'},
    {n:'í•™ë™',la:37.5146,lo:127.0319,c:'#747F00',l:'7'},
    {n:'ë°˜í¬',la:37.5039,lo:127.0025,c:'#747F00',l:'7'},
    {n:'ë‚´ë°©',la:37.5003,lo:127.0038,c:'#747F00',l:'7'},
    {n:'ì´ìˆ˜',la:37.4847,lo:126.9810,c:'#747F00',l:'7'},
    {n:'ë³´ë¼ë§¤',la:37.4920,lo:126.9193,c:'#747F00',l:'7'},
    {n:'ì‹ í’',la:37.4980,lo:126.9200,c:'#747F00',l:'7'},
    {n:'ìˆ˜ë½ì‚°',la:37.6682,lo:127.0567,c:'#747F00',l:'7'},
    {n:'ë„ë´‰ì‚°',la:37.6893,lo:127.0457,c:'#747F00',l:'7'},
    {n:'ì¥ì•”',la:37.7038,lo:127.0510,c:'#747F00',l:'7'},
    // â”€â”€ 8í˜¸ì„  #EA545D â”€â”€
    {n:'ì•”ì‚¬',la:37.5536,lo:127.1258,c:'#EA545D',l:'8'},
    {n:'ê°•ë™êµ¬ì²­',la:37.5309,lo:127.1325,c:'#EA545D',l:'8'},
    {n:'ëª½ì´Œí† ì„±',la:37.5153,lo:127.1194,c:'#EA545D',l:'8'},
    {n:'ì„ì´Œ',la:37.5044,lo:127.1054,c:'#EA545D',l:'8'},
    {n:'ê°€ë½ì‹œì¥',la:37.4928,lo:127.1156,c:'#EA545D',l:'8'},
    {n:'ë¬¸ì •',la:37.4826,lo:127.1216,c:'#EA545D',l:'8'},
    {n:'ì¥ì§€',la:37.4765,lo:127.1258,c:'#EA545D',l:'8'},
    {n:'ë³µì •',la:37.4651,lo:127.1328,c:'#EA545D',l:'8'},
    // â”€â”€ 9í˜¸ì„  #BB9E45 â”€â”€
    {n:'êµ­íšŒì˜ì‚¬ë‹¹',la:37.5267,lo:126.9190,c:'#BB9E45',l:'9'},
    {n:'ìƒ›ê°•',la:37.5170,lo:126.9234,c:'#BB9E45',l:'9'},
    {n:'í‘ì„',la:37.5042,lo:126.9671,c:'#BB9E45',l:'9'},
    {n:'êµ¬ë°˜í¬',la:37.5021,lo:127.0028,c:'#BB9E45',l:'9'},
    {n:'ì‹ ë°˜í¬',la:37.5056,lo:127.0143,c:'#BB9E45',l:'9'},
    {n:'ì‚¬í‰',la:37.5020,lo:127.0258,c:'#BB9E45',l:'9'},
    {n:'ì‹ ë…¼í˜„',la:37.5045,lo:127.0253,c:'#BB9E45',l:'9'},
    {n:'ì–¸ì£¼',la:37.5072,lo:127.0340,c:'#BB9E45',l:'9'},
    {n:'ì„ ì •ë¦‰',la:37.5104,lo:127.0448,c:'#BB9E45',l:'9'},
    {n:'ì‚¼ì„±ì¤‘ì•™',la:37.5094,lo:127.0581,c:'#BB9E45',l:'9'},
    {n:'ë´‰ì€ì‚¬',la:37.5140,lo:127.0580,c:'#BB9E45',l:'9'},
    {n:'í•œì„±ë°±ì œ',la:37.5175,lo:127.0936,c:'#BB9E45',l:'9'},
    {n:'ì˜¬ë¦¼í”½ê³µì›',la:37.5204,lo:127.1074,c:'#BB9E45',l:'9'},
    // â”€â”€ ì‹ ë¶„ë‹¹ì„  #D4003B â”€â”€
    {n:'ì–‘ì¬',la:37.4842,lo:127.0352,c:'#D4003B',l:'ì‹ ë¶„ë‹¹'},
    {n:'ì–‘ì¬ì‹œë¯¼ì˜ìˆ²',la:37.4706,lo:127.0449,c:'#D4003B',l:'ì‹ ë¶„ë‹¹'},
    {n:'ì²­ê³„ì‚°ì…êµ¬',la:37.4468,lo:127.0557,c:'#D4003B',l:'ì‹ ë¶„ë‹¹'},
    // â”€â”€ ë¶„ë‹¹ì„  #F5A200 â”€â”€
    {n:'ì„œìš¸ìˆ²',la:37.5454,lo:127.0443,c:'#F5A200',l:'ë¶„ë‹¹'},
    {n:'ì••êµ¬ì •ë¡œë°ì˜¤',la:37.5267,lo:127.0399,c:'#F5A200',l:'ë¶„ë‹¹'},
    {n:'í•œí‹°',la:37.4984,lo:127.0561,c:'#F5A200',l:'ë¶„ë‹¹'},
    {n:'êµ¬ë£¡',la:37.4847,lo:127.0538,c:'#F5A200',l:'ë¶„ë‹¹'},
    {n:'ê°œí¬ë™',la:37.4787,lo:127.0549,c:'#F5A200',l:'ë¶„ë‹¹'},
    {n:'ëŒ€ëª¨ì‚°ì…êµ¬',la:37.4765,lo:127.0772,c:'#F5A200',l:'ë¶„ë‹¹'},
    // â”€â”€ ê²½ì˜ì¤‘ì•™ì„  #77C4A3 â”€â”€
    {n:'ê³µë•',la:37.5464,lo:126.9517,c:'#77C4A3',l:'ê²½ì˜'},
    {n:'ì„œê°•ëŒ€',la:37.5559,lo:126.9354,c:'#77C4A3',l:'ê²½ì˜'},
    {n:'ê°€ì¢Œ',la:37.5616,lo:126.9115,c:'#77C4A3',l:'ê²½ì˜'},
    {n:'ìˆ˜ìƒ‰',la:37.5898,lo:126.8826,c:'#77C4A3',l:'ê²½ì˜'},
  ];
  const stnFeatures = stations.map(s => ({
    type: 'Feature',
    properties: { name: s.n, color: s.c, line: s.l },
    geometry: { type: 'Point', coordinates: [s.lo, s.la] }
  }));
  map.addSource('stations', { type: 'geojson', data: { type: 'FeatureCollection', features: stnFeatures } });
  // Station markers as GPU symbol layers (no DOM, minzoom handles visibility natively)
  map.addLayer({
    id: 'station-dot', type: 'circle', source: 'stations', minzoom: 13,
    paint: {
      'circle-radius': 4,
      'circle-color': ['get', 'color'],
      'circle-stroke-color': '#ffffff',
      'circle-stroke-width': 1.5
    }
  });
  map.addLayer({
    id: 'station-labels', type: 'symbol', source: 'stations', minzoom: 13,
    layout: {
      'text-field': ['get', 'name'],
      'text-size': 15,
      'text-font': FONT_STACK,
      'text-offset': [0, -1.2],
      'text-anchor': 'bottom',
      'text-allow-overlap': false,
      'text-padding': 2
    },
    paint: {
      'text-color': ['get', 'color'],
      'text-halo-color': 'rgba(255,255,255,0.95)',
      'text-halo-width': 3
    }
  });

  // --- Slope arrows ---
  const slopes = [
    {la:37.4790,lo:127.0780,dir:'â†—',label:'+80m',steep:true},
    {la:37.4760,lo:127.0850,dir:'â†’',label:'+60m',steep:true},
    {la:37.4810,lo:127.0870,dir:'â†˜',label:'+50m',steep:true},
    {la:37.4820,lo:127.0580,dir:'â†“',label:'+70m',steep:true},
    {la:37.4760,lo:127.0650,dir:'â†—',label:'+90m',steep:true},
    {la:37.4880,lo:127.0400,dir:'â†‘',label:'+30m',steep:false},
    {la:37.4930,lo:127.0420,dir:'â†—',label:'+25m',steep:false},
    {la:37.4890,lo:127.0480,dir:'â†',label:'+20m',steep:false},
    {la:37.4810,lo:127.0120,dir:'â†‘',label:'+60m',steep:true},
    {la:37.4750,lo:127.0050,dir:'â†—',label:'+80m',steep:true},
    {la:37.4700,lo:127.0660,dir:'â†“',label:'+35m',steep:false},
    {la:37.4660,lo:127.0730,dir:'â†—',label:'+40m',steep:false},
    {la:37.4850,lo:127.0920,dir:'â†',label:'+25m',steep:false},
    {la:37.4800,lo:127.0560,dir:'â†“',label:'+45m',steep:false},
  ];
  const slopeFeatures = slopes.map(s => ({
    type: 'Feature',
    properties: { dir: s.dir, label: s.label, steep: s.steep },
    geometry: { type: 'Point', coordinates: [s.lo, s.la] }
  }));
  map.addSource('slopes', { type: 'geojson', data: { type: 'FeatureCollection', features: slopeFeatures } });
  map.addLayer({ id: 'slope-arrow', type: 'symbol', source: 'slopes',
    minzoom: 13,
    layout: {
      'text-field': ['concat', ['get','dir'], ' ', ['get','label']],
      'text-size': 14, 'text-font': FONT_STACK,
      'text-allow-overlap': false
    },
    paint: {
      'text-color': ['case', ['get','steep'], '#C62828', '#E65100'],
      'text-halo-color': '#fff', 'text-halo-width': 2
    }
  });

  // --- Road slope arrows (arrows point UPHILL, count = steepness) ---
  const roadSlopes = [
    // ê°•ë‚¨ëŒ€ë¡œ (ë‚¨ìª½ìœ¼ë¡œ ì˜¬ë¼ê° - ê°•ë‚¨ì—­â†’ì–‘ì¬)
    { name:'ê°•ë‚¨ëŒ€ë¡œ', grade:1, pts:[[127.0276,37.4979],[127.0290,37.4950],[127.0310,37.4920],[127.0330,37.4890],[127.0352,37.4842]] },
    // ê°œí¬ë¡œ (ë‚¨ìª½ìœ¼ë¡œ ì˜¬ë¼ê° - ê°œí¬ë™â†’êµ¬ë£¡ì‚°)
    { name:'ê°œí¬ë¡œ', grade:3, pts:[[127.0549,37.4787],[127.0560,37.4760],[127.0575,37.4740],[127.0600,37.4720]] },
    // í—Œë¦‰ë¡œ (ë™ìª½ìœ¼ë¡œ ì˜¬ë¼ê° - ìˆ˜ì„œì—­â†’ëŒ€ëª¨ì‚°)
    { name:'í—Œë¦‰ë¡œ', grade:3, pts:[[127.1017,37.4872],[127.0950,37.4830],[127.0880,37.4800],[127.0830,37.4770]] },
    // ì¼ì›ë¡œ (ë‚¨ìª½ìœ¼ë¡œ ì˜¬ë¼ê°)
    { name:'ì¼ì›ë¡œ', grade:2, pts:[[127.0867,37.4836],[127.0850,37.4810],[127.0840,37.4790]] },
    // ë‚¨ë¶€ìˆœí™˜ë¡œ ë™ìª½ (ëŒ€ëª¨ì‚°ì…êµ¬ ë°©í–¥ ì˜¬ë¼ê°)
    { name:'ë‚¨ë¶€ìˆœí™˜ë¡œ(ë™)', grade:2, pts:[[127.0650,37.4830],[127.0700,37.4820],[127.0750,37.4810],[127.0772,37.4800]] },
    // ë„ê³¡ë¡œ (ë§¤ë´‰ì‚° ë°©í–¥ ì˜¬ë¼ê°)
    { name:'ë„ê³¡ë¡œ', grade:2, pts:[[127.0455,37.4915],[127.0430,37.4900],[127.0410,37.4890],[127.0390,37.4880]] },
    // ì–¸ì£¼ë¡œ (ë‚¨ìª½ ì˜¬ë¼ê° - ì—­ì‚¼â†’ë§¤ë´‰)
    { name:'ì–¸ì£¼ë¡œ', grade:1, pts:[[127.0340,37.5072],[127.0345,37.5030],[127.0347,37.4990],[127.0347,37.4950],[127.0347,37.4910],[127.0347,37.4874]] },
    // ì„ ë¦‰ë¡œ (ë‚¨ìª½ ì•½ê°„ ì˜¬ë¼ê°)
    { name:'ì„ ë¦‰ë¡œ', grade:1, pts:[[127.0490,37.5045],[127.0480,37.5010],[127.0470,37.4970],[127.0455,37.4940]] },
    // ì‚¼ì„±ë¡œ (ë‚¨ìª½ ì˜¬ë¼ê° - ì‚¼ì„±ì—­â†’ëŒ€ì¹˜)
    { name:'ì‚¼ì„±ë¡œ', grade:1, pts:[[127.0639,37.5088],[127.0620,37.5050],[127.0600,37.5010],[127.0577,37.4948]] },
    // ì–‘ì¬ëŒ€ë¡œ (ë™ìª½ìœ¼ë¡œ ì˜¬ë¼ê° - ì–‘ì¬â†’ì„¸ê³¡)
    { name:'ì–‘ì¬ëŒ€ë¡œ', grade:2, pts:[[127.0352,37.4842],[127.0450,37.4835],[127.0550,37.4830],[127.0650,37.4825],[127.0720,37.4820]] },
    // ì„¸ê³¡ë™ê¸¸ (ë‚¨ìª½ ì˜¬ë¼ê°)
    { name:'ì„¸ê³¡ë™ê¸¸', grade:2, pts:[[127.0700,37.4750],[127.0690,37.4720],[127.0680,37.4690],[127.0670,37.4660]] },
    // ëŒ€ëª¨ì‚°ê¸¸ (ë™ë‚¨ìª½ ì˜¬ë¼ê° - ëŒ€ëª¨ì‚°ì…êµ¬ì—­â†’ëŒ€ëª¨ì‚°)
    { name:'ëŒ€ëª¨ì‚°ê¸¸', grade:3, pts:[[127.0772,37.4765],[127.0790,37.4750],[127.0810,37.4740],[127.0830,37.4730]] },
    // êµ¬ë£¡ì‚°ê¸¸ (ë‚¨ìª½ ì˜¬ë¼ê°)
    { name:'êµ¬ë£¡ì‚°ê¸¸', grade:3, pts:[[127.0538,37.4847],[127.0560,37.4830],[127.0580,37.4810],[127.0600,37.4795],[127.0620,37.4785]] },
    // ì˜ë™ëŒ€ë¡œ (ê±°ì˜ í‰ì§€ - í‘œì‹œ ì•ˆí•¨)
    // í…Œí—¤ë€ë¡œ (ê±°ì˜ í‰ì§€ - í‘œì‹œ ì•ˆí•¨)
    // ë´‰ì€ì‚¬ë¡œ ë‚¨ìª½ìœ¼ë¡œ ì•½ê°„
    { name:'ë´‰ì€ì‚¬ë¡œ', grade:1, pts:[[127.0580,37.5140],[127.0550,37.5120],[127.0520,37.5100],[127.0490,37.5080]] },
    // ë…¼í˜„ë¡œ (ë‚¨ìª½ ì˜¬ë¼ê°)
    { name:'ë…¼í˜„ë¡œ', grade:1, pts:[[127.0215,37.5113],[127.0220,37.5080],[127.0230,37.5050],[127.0240,37.5020]] },
    // ìš°ë©´ì‚° ì ‘ê·¼ (ê¸‰ê²½ì‚¬)
    { name:'ìš°ë©´ì‚°ë¡œ', grade:3, pts:[[127.0146,37.4934],[127.0130,37.4900],[127.0110,37.4860],[127.0090,37.4820],[127.0080,37.4780]] },
  ];

  // Arrow symbol: more chevrons = steeper
  const gradeArrows = { 1: 'â€º', 2: 'â€ºâ€º', 3: 'â€ºâ€ºâ€º' };
  const gradeColors = { 1: '#4CAF50', 2: '#FF9800', 3: '#f44336' };
  const gradeWidths = { 1: 3, 2: 4, 3: 5 };

  const roadFeatures = roadSlopes.map(r => ({
    type: 'Feature',
    properties: { name: r.name, grade: r.grade, arrows: gradeArrows[r.grade], color: gradeColors[r.grade] },
    geometry: { type: 'LineString', coordinates: r.pts }
  }));

  map.addSource('road-slopes', { type: 'geojson', data: { type: 'FeatureCollection', features: roadFeatures } });

  // Road slope line (subtle colored underline)
  map.addLayer({
    id: 'road-slope-line', type: 'line', source: 'road-slopes', minzoom: 13,
    paint: {
      'line-color': ['match', ['get','grade'], 1,'rgba(76,175,80,0.3)', 2,'rgba(255,152,0,0.3)', 'rgba(244,67,54,0.3)'],
      'line-width': ['match', ['get','grade'], 1,6, 2,8, 10],
    },
    layout: { 'line-cap': 'round' }
  });

  // Arrows along road (pointing uphill) - split by grade for stable symbol-spacing
  map.addLayer({
    id: 'road-slope-arrows-g1', type: 'symbol', source: 'road-slopes', minzoom: 13,
    filter: ['==', ['get', 'grade'], 1],
    layout: {
      'symbol-placement': 'line',
      'text-field': 'â€º',
      'text-size': 16,
      'text-font': FONT_STACK,
      'text-keep-upright': false,
      'symbol-spacing': 80,
      'text-allow-overlap': false,
      'text-rotation-alignment': 'map',
      'text-pitch-alignment': 'map'
    },
    paint: {
      'text-color': '#388E3C',
      'text-halo-color': 'rgba(255,255,255,0.85)',
      'text-halo-width': 1.5
    }
  });
  map.addLayer({
    id: 'road-slope-arrows-g2', type: 'symbol', source: 'road-slopes', minzoom: 13,
    filter: ['==', ['get', 'grade'], 2],
    layout: {
      'symbol-placement': 'line',
      'text-field': 'â€ºâ€º',
      'text-size': 20,
      'text-font': FONT_STACK,
      'text-keep-upright': false,
      'symbol-spacing': 60,
      'text-allow-overlap': false,
      'text-rotation-alignment': 'map',
      'text-pitch-alignment': 'map'
    },
    paint: {
      'text-color': '#E65100',
      'text-halo-color': 'rgba(255,255,255,0.85)',
      'text-halo-width': 1.5
    }
  });
  map.addLayer({
    id: 'road-slope-arrows-g3', type: 'symbol', source: 'road-slopes', minzoom: 13,
    filter: ['==', ['get', 'grade'], 3],
    layout: {
      'symbol-placement': 'line',
      'text-field': 'â€ºâ€ºâ€º',
      'text-size': 24,
      'text-font': FONT_STACK,
      'text-keep-upright': false,
      'symbol-spacing': 45,
      'text-allow-overlap': false,
      'text-rotation-alignment': 'map',
      'text-pitch-alignment': 'map'
    },
    paint: {
      'text-color': '#C62828',
      'text-halo-color': 'rgba(255,255,255,0.85)',
      'text-halo-width': 1.5
    }
  });

  // Road name labels
  map.addLayer({
    id: 'road-slope-labels', type: 'symbol', source: 'road-slopes', minzoom: 14,
    layout: {
      'symbol-placement': 'line-center',
      'text-field': ['get', 'name'],
      'text-size': 10,
      'text-font': FONT_STACK,
      'text-offset': [0, -1.2]
    },
    paint: {
      'text-color': ['match', ['get','grade'], 1,'#2E7D32', 2,'#E65100', '#C62828'],
      'text-halo-color': 'rgba(255,255,255,0.9)',
      'text-halo-width': 1.5
    }
  });

  // --- Local maximums (ì—°í•œ í•˜ì´ë¼ì´íŠ¸) ---
  const localMaxima = [
    // Major peaks
    { n:'ëŒ€ëª¨ì‚°', e:293, lo:127.0830, la:37.4730, r:350 },
    { n:'êµ¬ë£¡ì‚°', e:306, lo:127.0620, la:37.4785, r:300 },
    { n:'ë§¤ë´‰ì‚°', e:101, lo:127.0450, la:37.4910, r:200 },
    { n:'ìš°ë©´ì‚°', e:293, lo:127.0080, la:37.4780, r:300 },
    // Minor local highs
    { n:'', e:120, lo:127.0700, la:37.4680, r:150 }, // ì„¸ê³¡ë™ êµ¬ë¦‰
    { n:'', e:80, lo:127.0900, la:37.4830, r:120 },  // ì¼ì›ë™ êµ¬ë¦‰
    { n:'', e:65, lo:127.0560, la:37.4800, r:100 },  // ê°œí¬ë™ ì–¸ë•
    { n:'', e:55, lo:127.0380, la:37.4950, r:80 },   // ì—­ì‚¼ ì–¸ë•
    { n:'', e:90, lo:127.1010, la:37.4870, r:120 },  // ìˆ˜ì„œë™ ê³ ì§€ëŒ€
    { n:'', e:50, lo:127.0520, la:37.5080, r:80 },   // ë‹¬í„°ê³µì›
    { n:'', e:45, lo:127.0320, la:37.5140, r:70 },   // í•™ë™ ì–¸ë•
    { n:'', e:70, lo:127.0750, la:37.4760, r:100 },  // ëŒ€ëª¨ì‚°ì…êµ¬ ì£¼ë³€
    { n:'', e:55, lo:127.0480, la:37.4880, r:80 },   // ë„ê³¡ë™ ì–¸ë•
    { n:'', e:100, lo:127.0650, la:37.4720, r:130 }, // ì„¸ê³¡ë™ ë‚¨ìª½
    { n:'', e:40, lo:127.0250, la:37.5000, r:60 },   // ê°•ë‚¨ì—­ ì„œìª½ ë¯¸ì„¸ ì–¸ë•
  ];

  // Circles (glow effect)
  const maxCircles = localMaxima.map(m => ({
    type: 'Feature',
    properties: { name: m.n, elev: m.e, radius: m.r },
    geometry: { type: 'Point', coordinates: [m.lo, m.la] }
  }));
  map.addSource('local-max', { type: 'geojson', data: { type: 'FeatureCollection', features: maxCircles } });

  // Elevation highlight (single layer, no blur â€” saves GPU)
  map.addLayer({
    id: 'local-max-core', type: 'circle', source: 'local-max',
    minzoom: 12,
    paint: {
      'circle-radius': ['interpolate', ['linear'], ['zoom'], 12, ['/', ['get','radius'], 35], 15, ['/', ['get','radius'], 8]],
      'circle-color': [
        'interpolate', ['linear'], ['get','elev'],
        40, 'rgba(255, 224, 130, 0.3)',
        100, 'rgba(255, 183, 77, 0.35)',
        200, 'rgba(255, 138, 101, 0.4)'
      ],
      'circle-stroke-color': [
        'interpolate', ['linear'], ['get','elev'],
        40, 'rgba(255, 193, 7, 0.3)',
        100, 'rgba(255, 152, 0, 0.35)',
        200, 'rgba(244, 67, 54, 0.4)'
      ],
      'circle-stroke-width': 1.5
    }
  }, 'flat-routes-line');

  // Elevation label on each local max
  map.addLayer({
    id: 'local-max-label', type: 'symbol', source: 'local-max', minzoom: 13,
    layout: {
      'text-field': ['concat', ['get','elev'], 'm'],
      'text-size': 10,
      'text-font': FONT_STACK,
      'text-allow-overlap': false,
      'text-offset': [0, -0.8]
    },
    paint: {
      'text-color': [
        'interpolate', ['linear'], ['get','elev'],
        40, 'rgba(230, 170, 0, 0.7)',
        100, 'rgba(230, 120, 0, 0.8)',
        200, 'rgba(200, 60, 40, 0.85)'
      ],
      'text-halo-color': 'rgba(255,255,255,0.8)',
      'text-halo-width': 1.2
    }
  });

  // --- Peaks ---
  const peaks = [
    {n:'â›°ï¸ ëŒ€ëª¨ì‚° 293m',la:37.4730,lo:127.0830},
    {n:'â›°ï¸ êµ¬ë£¡ì‚° 306m',la:37.4785,lo:127.0620},
    {n:'â›°ï¸ ë§¤ë´‰ì‚° 101m',la:37.4910,lo:127.0450},
    {n:'â›°ï¸ ìš°ë©´ì‚° 293m',la:37.4780,lo:127.0080},
  ];
  map.addSource('peaks', { type: 'geojson', data: {
    type: 'FeatureCollection',
    features: peaks.map(p => ({ type:'Feature', properties:{name:p.n}, geometry:{type:'Point',coordinates:[p.lo,p.la]} }))
  }});
  map.addLayer({ id: 'peak-label', type: 'symbol', source: 'peaks',
    layout: { 'text-field': ['get','name'], 'text-size': 12, 'text-font': FONT_STACK, 'text-allow-overlap': true },
    paint: { 'text-color': '#C62828', 'text-halo-color': '#fff', 'text-halo-width': 2 }
  });
  };

  const applySecondaryOverlayState = () => {
    const routeVisible = document.getElementById('chkRoute')?.checked ?? true;
    const stationVisible = document.getElementById('chkStation')?.checked ?? true;
    const slopeVisible = document.getElementById('chkSlope')?.checked ?? true;
    setLayerVisibility(map, ['flat-routes-line', 'flat-routes-label', 'caution-fill', 'caution-border', 'caution-label'], routeVisible);
    setLayerVisibility(map, ['station-dot', 'station-labels'], stationVisible);
    setLayerVisibility(map, ['slope-arrow', 'road-slope-line', 'road-slope-arrows-g1', 'road-slope-arrows-g2', 'road-slope-arrows-g3', 'road-slope-labels'], slopeVisible);
    scheduleDynamicVisibility(0);
  };

  if (IS_MOBILE) {
    // Delay heavy overlay/source setup on mobile to reduce first-load main-thread work.
    scheduleIdleTask(() => {
      initSecondaryOverlays();
      applySecondaryOverlayState();
    }, 8000);
  } else {
    initSecondaryOverlays();
    applySecondaryOverlayState();
  }

  // --- Default location marker ---
  addLocMarker(DEFAULT_LOC);
  scheduleDynamicVisibility(0);
});

// ===== Location marker =====
let locMarkerEl = null;
let locMarker = null;

function addLocMarker(lnglat) {
  if (locMarker) locMarker.remove();
  locMarkerEl = document.createElement('div');
  locMarkerEl.innerHTML = '<div style="width:18px;height:18px;background:#4285F4;border:3px solid #fff;border-radius:50%;box-shadow:0 1px 4px rgba(0,0,0,0.3)"></div>';
  locMarker = new maplibregl.Marker({ element: locMarkerEl }).setLngLat(lnglat).addTo(map);
}

// Inject pulse keyframes
const styleSheet = document.createElement('style');
styleSheet.textContent = '@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(66,133,244,0.5),0 1px 4px rgba(0,0,0,0.3)}70%{box-shadow:0 0 0 18px rgba(66,133,244,0),0 1px 4px rgba(0,0,0,0.3)}100%{box-shadow:0 0 0 0 rgba(66,133,244,0),0 1px 4px rgba(0,0,0,0.3)}}';
document.head.appendChild(styleSheet);

// ===== Controls =====
document.getElementById('btnLegend').addEventListener('click', () => {
  document.getElementById('legendBar').classList.toggle('show');
  document.getElementById('layerPanel').classList.remove('show');
});
document.getElementById('btnLayers').addEventListener('click', () => {
  document.getElementById('layerPanel').classList.toggle('show');
  document.getElementById('legendBar').classList.remove('show');
});
document.getElementById('btnReset').addEventListener('click', () => {
  map.flyTo({ center: DEFAULT_LOC, zoom: 14, pitch: 40, bearing: 0, duration: 1000 });
});

let is3d = true;
document.getElementById('btn3dToggle').addEventListener('click', () => {
  is3d = !is3d;
  if (is3d) {
    map.setTerrain({ source: 'terrain-dem', exaggeration: TERRAIN_EXAGGERATION });
    map.easeTo({ pitch: 40, duration: 500 });
    document.getElementById('btn3dToggle').textContent = 'ğŸ”ï¸';
  } else {
    map.setTerrain(null);
    map.easeTo({ pitch: 0, bearing: 0, duration: 500 });
    document.getElementById('btn3dToggle').textContent = '2D';
  }
});

document.getElementById('chk3d').addEventListener('change', e => {
  if (e.target.checked) {
    map.setTerrain({ source: 'terrain-dem', exaggeration: TERRAIN_EXAGGERATION });
  } else {
    map.setTerrain(null);
    map.easeTo({ pitch: 0, bearing: 0, duration: 300 });
  }
});

// 3D buildings toggle (default hidden)
document.getElementById('chkBuildings')?.addEventListener('change', e => {
  setLayerVisibility(map, ['buildings-3d', 'buildings-3d-outline'], e.target.checked);
});

// Contour line visibility toggle
document.getElementById('chkContour')?.addEventListener('change', e => {
  setLayerVisibility(map, ['contour-lines', 'contour-lines-major'], e.target.checked);
});

const applyContourOpacity = createRafValueApplier((opacity) => {
  if (map.getLayer('contour-lines')) map.setPaintProperty('contour-lines', 'line-opacity', opacity);
  if (map.getLayer('contour-lines-major')) map.setPaintProperty('contour-lines-major', 'line-opacity', opacity);
});
document.getElementById('contourOpacity').addEventListener('input', e => {
  applyContourOpacity(Number(e.target.value) / 100);
});

document.getElementById('chkStation').addEventListener('change', e => {
  setLayerVisibility(map, ['station-dot', 'station-labels'], e.target.checked);
});
document.getElementById('chkRoute').addEventListener('change', e => {
  setLayerVisibility(map, ['flat-routes-line', 'flat-routes-label', 'caution-fill', 'caution-border', 'caution-label'], e.target.checked);
});
document.getElementById('chkSlope').addEventListener('change', e => {
  setLayerVisibility(map, ['slope-arrow', 'road-slope-line', 'road-slope-arrows-g1', 'road-slope-arrows-g2', 'road-slope-arrows-g3', 'road-slope-labels'], e.target.checked);
});

// ===== My Location =====
document.getElementById('btnLocate').addEventListener('click', () => {
  if (!navigator.geolocation) return alert('ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.');
  const b = document.getElementById('btnLocate');
  b.textContent = 'â³'; b.style.opacity = '0.6';
  navigator.geolocation.getCurrentPosition(p => {
    const ll = [p.coords.longitude, p.coords.latitude];
    addLocMarker(ll);
    map.flyTo({ center: ll, zoom: 15, duration: 800 });
    b.textContent = 'ğŸ“'; b.style.opacity = '1';
    new maplibregl.Popup({ offset: 12 }).setLngLat(ll).setHTML('ğŸ“ í˜„ìœ„ì¹˜').addTo(map);
  }, err => {
    b.textContent = 'ğŸ“'; b.style.opacity = '1';
    if (err.code === 1) alert('ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
    else alert('ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ìš”.');
  }, { enableHighAccuracy: true, timeout: 15000 });
});

// Auto-locate on mobile
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(p => {
    addLocMarker([p.coords.longitude, p.coords.latitude]);
  }, () => {}, { enableHighAccuracy: false, timeout: 8000, maximumAge: 60000 });
}

// e.code ê¸°ë°˜ìœ¼ë¡œ WASD/ê¸°íƒ€ í‚¤ ì²˜ë¦¬ (í•œêµ­ì–´ IME ë¬´ê´€)

// ===== Middle mouse button: rotate + tilt (desktop only) =====
// ì¢Œìš° ë“œë˜ê·¸ â†’ íšŒì „(bearing), ìƒí•˜ ë“œë˜ê·¸ â†’ ê¸°ìš¸ê¸°(pitch)
if (!IS_MOBILE) {
  let midDragging = false, midLastX = 0, midLastY = 0;
  let midAccumDx = 0, midAccumDy = 0;
  let midMoveRaf = null;

  document.getElementById('map').addEventListener('mousedown', e => {
    if (e.button === 1) {
      e.preventDefault(); // prevent browser auto-scroll
      midDragging = true;
      midLastX = e.clientX;
      midLastY = e.clientY;
      document.getElementById('map').style.cursor = 'crosshair';
    }
  });

  document.addEventListener('mousemove', e => {
    if (!midDragging) return;
    midAccumDx += e.clientX - midLastX;
    midAccumDy += e.clientY - midLastY;
    midLastX = e.clientX;
    midLastY = e.clientY;
    if (midMoveRaf !== null) return;
    midMoveRaf = requestAnimationFrame(() => {
      midMoveRaf = null;
      const newBearing = map.getBearing() + midAccumDx * 0.4;
      const maxPitch = typeof map.getMaxPitch === 'function' ? map.getMaxPitch() : 70;
      const newPitch = Math.max(0, Math.min(maxPitch, map.getPitch() - midAccumDy * 0.3));
      midAccumDx = 0;
      midAccumDy = 0;
      map.jumpTo({ bearing: newBearing, pitch: newPitch });
    });
  });

  document.addEventListener('mouseup', e => {
    if (e.button === 1) {
      midDragging = false;
      midAccumDx = 0;
      midAccumDy = 0;
      if (midMoveRaf !== null) {
        cancelAnimationFrame(midMoveRaf);
        midMoveRaf = null;
      }
      document.getElementById('map').style.cursor = '';
    }
  });

  // Prevent middle-click auto-scroll cursor on some browsers
  document.getElementById('map').addEventListener('auxclick', e => {
    if (e.button === 1) e.preventDefault();
  });

  // ===== WASD ì§€ë„ ì´ë™ (ë°ìŠ¤í¬íƒ‘ ì „ìš©) =====
  const wasdKeys = {};
  let wasdRaf = null;
  const PAN_SPEED = 6; // px/frame
  const VERTICAL_SPEED = 0.02; // zoom/frame

  function wasdLoop() {
    if (!Object.values(wasdKeys).some(Boolean)) {
      wasdRaf = null;
      return;
    }
    wasdRaf = requestAnimationFrame(wasdLoop);
    let dx = 0, dy = 0;
    if (wasdKeys['w']) dy -= PAN_SPEED;
    if (wasdKeys['s']) dy += PAN_SPEED;
    if (wasdKeys['a']) dx -= PAN_SPEED;
    if (wasdKeys['d']) dx += PAN_SPEED;
    // ëŒ€ê°ì„  ì´ë™ ì‹œ ì†ë„ ì •ê·œí™”
    if (dx !== 0 && dy !== 0) { dx *= 0.707; dy *= 0.707; }
    map.panBy([dx, dy], { animate: false });

    // Minecraft-like vertical motion:
    // Space = ascend (zoom out), Shift = descend (zoom in)
    let zoomDelta = 0;
    if (wasdKeys['space']) zoomDelta -= VERTICAL_SPEED;
    if (wasdKeys['shift']) zoomDelta += VERTICAL_SPEED;
    if (zoomDelta !== 0) {
      const nextZoom = Math.max(11, Math.min(18, map.getZoom() + zoomDelta));
      map.jumpTo({ zoom: nextZoom });
    }
  }

  // e.code = ë¬¼ë¦¬ í‚¤ ìœ„ì¹˜ (í•œêµ­ì–´ IME í™œì„±í™” ìƒíƒœì—ë„ ë¶ˆë³€)
  const CODE_TO_WASD = { KeyW:'w', KeyA:'a', KeyS:'s', KeyD:'d' };

  document.addEventListener('keydown', e => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    const key = CODE_TO_WASD[e.code]
      || (e.code === 'Space' ? 'space' : null)
      || (e.code === 'ShiftLeft' || e.code === 'ShiftRight' ? 'shift' : null);
    if (key) {
      e.preventDefault();
      wasdKeys[key] = true;
      if (!wasdRaf) wasdLoop();
    }
  });

  document.addEventListener('keyup', e => {
    const key = CODE_TO_WASD[e.code]
      || (e.code === 'Space' ? 'space' : null)
      || (e.code === 'ShiftLeft' || e.code === 'ShiftRight' ? 'shift' : null);
    if (key) wasdKeys[key] = false;
  });

  // íƒ­ ì „í™˜/í¬ì»¤ìŠ¤ í•´ì œ ì‹œ í‚¤ ìƒíƒœ ì´ˆê¸°í™”
  window.addEventListener('blur', () => {
    Object.keys(wasdKeys).forEach(k => { wasdKeys[k] = false; });
  });
}

// Register Service Worker for offline support
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    scheduleIdleTask(() => {
      navigator.serviceWorker.register('sw.js')
      .then((registration) => {
        console.log('[SW] Registered:', registration.scope);
        if (PERF_DEBUG) {
          const requestCacheStats = () => {
            const worker = navigator.serviceWorker.controller || registration.active;
            worker?.postMessage({ type: 'sw-report-cache-stats' });
          };
          requestCacheStats();
          setInterval(requestCacheStats, 20000);
        }
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              console.log('[SW] New version available');
            }
          });
        });
      })
      .catch((error) => {
        console.log('[SW] Registration failed:', error);
      });
    }, IS_MOBILE ? 4500 : 1500);
  });
}

// Offline indicator
function updateOnlineStatus() {
  const indicator = document.getElementById('offline-indicator');
  if (indicator) {
    indicator.style.display = navigator.onLine ? 'none' : 'inline-block';
  }
}
window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);
updateOnlineStatus();
</script>
</body>
</html>
